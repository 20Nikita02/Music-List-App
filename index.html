<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Songs List</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#12131a; --muted:#a7adbb; --text:#eef1f6;
      --line:#222433; --accent:#7aa2ff; --good:#38d39f; --warn:#ffcc66;
      --bad:#ff6b6b;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 14px; }
    header{
      position: sticky; top: 0; z-index: 10;
      background: rgba(11,12,16,.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    header .wrap{ padding-top: 10px; padding-bottom: 10px; }
    h1{ font-size: 18px; margin: 0 0 10px; letter-spacing:.2px; }
    .bar{
      display:grid; gap:10px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 720px){
      .bar{ grid-template-columns: 1.2fr .8fr .8fr auto; align-items: end; }
    }
    label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input, select, button{
      width:100%;
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--text);
      border-radius: 12px;
      padding: 11px 12px;
      font-size: 14px;
      outline: none;
    }
    input::placeholder{ color: #6e7688; }
    button{
      cursor:pointer;
      background: linear-gradient(180deg, #1b1d2a, #12131a);
      border: 1px solid #2a2d40;
    }
    button.primary{
      background: linear-gradient(180deg, #2a4bff, #1c2bb8);
      border: 1px solid rgba(122,162,255,.55);
    }
    button.ghost{
      background: transparent;
      border: 1px solid var(--line);
    }
    .row{
      display:flex; gap:10px; flex-wrap: wrap;
      margin-top: 10px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border: 1px solid var(--line);
      border-radius: 999px; color: var(--muted); font-size: 12px;
      background: rgba(18,19,26,.6);
    }
    .pill b{ color: var(--text); font-weight: 600; }
    main{ padding-top: 12px; }
    .artistBlock{ margin: 14px 0; }
    .artistHeader{
      display:flex; align-items: baseline; justify-content: space-between;
      padding: 10px 12px;
      border: 1px solid var(--line);
      background: rgba(18,19,26,.7);
      border-radius: 14px;
      gap: 12px;
    }
    .artistHeader .left{
      display:flex; flex-direction: column; gap: 2px;
      min-width: 0;
    }
    .artistHeader .name{
      font-size: 15px; font-weight: 700; white-space: nowrap;
      overflow: hidden; text-overflow: ellipsis;
    }
    .artistHeader .meta{
      color: var(--muted); font-size: 12px;
    }
    .songs{
      margin-top: 10px;
      display:flex; flex-direction: column; gap: 10px;
    }
    .songCard{
      border: 1px solid var(--line);
      background: var(--card);
      border-radius: 16px;
      padding: 12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
    }
    .songTitle{
      font-size: 14px; font-weight: 700; margin: 0 0 6px;
      word-break: break-word;
    }
    .songMeta{
      color: var(--muted); font-size: 12px;
      display:flex; flex-wrap: wrap; gap: 8px;
    }
    .tag{
      border: 1px solid var(--line);
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.03);
    }
    .tag.fav{ border-color: rgba(56,211,159,.35); color: #bff6e5; }
    .tag.xfav{ border-color: rgba(255,204,102,.45); color: #ffe6b3; }
    .actions{
      display:flex; gap: 8px; align-items: start;
    }
    .iconBtn{
      width:auto; padding: 10px 10px;
      border-radius: 12px;
      font-size: 13px;
      white-space: nowrap;
    }
    .muted{ color: var(--muted); }
    .divider{ height: 1px; background: var(--line); margin: 14px 0; opacity: .8; }

    /* modal */
    .modalWrap{
      position: fixed; inset: 0; background: rgba(0,0,0,.55);
      display:none; align-items: center; justify-content: center;
      padding: 14px; z-index: 50;
    }
    .modal{
      width: min(620px, 100%);
      border-radius: 18px;
      background: #0f1017;
      border: 1px solid #2a2d40;
      padding: 14px;
    }
    .modal h2{ margin: 0 0 10px; font-size: 16px; }
    .grid2{
      display:grid; grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 720px){
      .grid2{ grid-template-columns: 1fr 1fr; }
    }
    .toggleRow{
      display:flex; gap: 10px; align-items: center; flex-wrap: wrap;
      margin-top: 8px;
    }
    .toggle{
      display:flex; align-items:center; gap:8px;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(18,19,26,.6);
      width: fit-content;
    }
    .toggle input{ width:auto; }
    .footerBtns{ display:flex; gap:10px; margin-top: 12px; }
    .small{ font-size: 12px; }
    .danger{ border-color: rgba(255,107,107,.35) !important; color: #ffd1d1; }
    details{
      border:1px solid var(--line); border-radius: 14px;
      padding: 10px 12px; background: rgba(18,19,26,.55);
    }
    summary{ cursor:pointer; color: var(--muted); }
    .settingsGrid{
      display:grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px;
    }
    @media (min-width: 720px){
      .settingsGrid{ grid-template-columns: 1fr 1fr; }
    }
    .hint{ color: var(--muted); font-size: 12px; line-height: 1.35; }
    a{ color: var(--accent); }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <h1>My Songs</h1>

      <div class="bar">
        <div>
          <label>Search</label>
          <input id="q" placeholder="Search song or artist…" autocomplete="off" />
        </div>
        <div>
          <label>Filter mood</label>
          <select id="filterMood"></select>
        </div>
        <div>
          <label>Filter genre</label>
          <select id="filterGenre"></select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="primary" id="btnAdd">+ Add song</button>
        </div>
      </div>

      <div class="row">
        <span class="pill">Artists: <b id="statArtists">0</b></span>
        <span class="pill">Songs: <b id="statSongs">0</b></span>
        <span class="pill">Favorites: <b id="statFav">0</b></span>
        <span class="pill">Extra favorites: <b id="statXFav">0</b></span>
        <button class="ghost iconBtn" id="btnFavOnly">Show favorites</button>
        <button class="ghost iconBtn" id="btnReset">Reset filters</button>
      </div>

      <div class="divider"></div>

      <details>
        <summary>Sync (optional): use GitHub Gist for multi-device</summary>
        <div class="settingsGrid">
          <div>
            <label>GitHub Gist ID</label>
            <input id="gistId" placeholder="e.g. a1b2c3d4e5f6…" />
            <div class="hint">Maak 1 private Gist met een bestand <b>songs.json</b> (mag leeg). Plak hier de Gist ID.</div>
          </div>
          <div>
            <label>GitHub Token (fine-grained)</label>
            <input id="ghToken" placeholder="ghp_… of github_pat_…" />
            <div class="hint">Bewaar dit privé. Gebruik een token met alleen Gist read/write. Dit wordt lokaal opgeslagen op je device.</div>
          </div>
        </div>
        <div class="footerBtns">
          <button class="ghost" id="btnLoadGist">Load from Gist</button>
          <button class="ghost" id="btnSaveGist">Save to Gist</button>
          <button class="ghost danger" id="btnClearLocal">Clear local data</button>
        </div>
        <div class="hint small" style="margin-top:8px">
          Zonder Gist-sync: data staat alleen op dit apparaat (localStorage).
        </div>
      </details>
    </div>
  </header>

  <main class="wrap" id="list"></main>

  <!-- Modal -->
  <div class="modalWrap" id="modalWrap">
    <div class="modal">
      <h2 id="modalTitle">Add song</h2>

      <div class="grid2">
        <div>
          <label>Artist</label>
          <input id="inArtist" placeholder="Artist name" />
        </div>
        <div>
          <label>Song title</label>
          <input id="inTitle" placeholder="Song title" />
        </div>
        <div>
          <label>Mood</label>
          <select id="inMood"></select>
        </div>
        <div>
          <label>Genre</label>
          <select id="inGenre"></select>
        </div>
      </div>

      <div class="toggleRow">
        <label class="toggle"><input type="checkbox" id="inFav" /> Favorite</label>
        <label class="toggle"><input type="checkbox" id="inXFav" /> Extra favorite</label>
      </div>

      <div class="footerBtns">
        <button class="primary" id="btnSave">Save</button>
        <button class="ghost" id="btnCancel">Cancel</button>
        <button class="ghost danger" id="btnDelete" style="margin-left:auto; display:none;">Delete</button>
      </div>

      <div class="hint small" style="margin-top:10px">
        Tip: Zet “Artist – Song Title” in je muziekhistorie? Je kunt hier ook snel copy-pasten en daarna aanpassen.
      </div>
    </div>
  </div>

  <script>
    // ====== Presets (dropdown options) ======
    const MOODS = ["Any", "Happy", "Sad", "Energized", "Calm", "Instrumental"];
    const GENRES = ["Any", "Pop", "Hip-Hop", "Rock", "EDM", "R&B", "Jazz", "Classical", "Indie", "Metal", "Folk", "Other"];

    // ====== Storage keys ======
    const LS_KEY = "mySongs.v1";
    const LS_SYNC = "mySongs.sync.v1";

    // ====== State ======
    let songs = [];
    let favOnly = false;
    let editingId = null;

    // ====== Helpers ======
    const $ = (id) => document.getElementById(id);
    const norm = (s) => (s || "").toString().trim();
    const key = (s) => norm(s).toLowerCase();

    function uid(){
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function fillSelect(sel, options){
      sel.innerHTML = "";
      for(const opt of options){
        const o = document.createElement("option");
        o.value = opt === "Any" ? "" : opt;
        o.textContent = opt;
        sel.appendChild(o);
      }
    }

    function loadLocal(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        songs = raw ? JSON.parse(raw) : [];
      }catch(e){
        songs = [];
      }
    }
    function saveLocal(){
      localStorage.setItem(LS_KEY, JSON.stringify(songs));
    }

    function loadSyncSettings(){
      try{
        const raw = localStorage.getItem(LS_SYNC);
        const s = raw ? JSON.parse(raw) : {};
        $("gistId").value = s.gistId || "";
        $("ghToken").value = s.ghToken || "";
      }catch(e){}
    }
    function saveSyncSettings(){
      localStorage.setItem(LS_SYNC, JSON.stringify({
        gistId: $("gistId").value.trim(),
        ghToken: $("ghToken").value.trim()
      }));
    }

    function sortSongs(arr){
      return [...arr].sort((a,b)=>{
        const A = key(a.artist), B = key(b.artist);
        if(A !== B) return A.localeCompare(B);
        return key(a.title).localeCompare(key(b.title));
      });
    }

    function getUniqueArtists(arr){
      const set = new Set(arr.map(s => norm(s.artist)).filter(Boolean));
      return [...set].sort((a,b)=> key(a).localeCompare(key(b)));
    }

    // ====== Rendering ======
    function render(){
      const q = key($("q").value);
      const fm = $("filterMood").value;
      const fg = $("filterGenre").value;

      let filtered = songs;

      if(q){
        filtered = filtered.filter(s =>
          key(s.artist).includes(q) || key(s.title).includes(q)
        );
      }
      if(fm){
        filtered = filtered.filter(s => s.mood === fm);
      }
      if(fg){
        filtered = filtered.filter(s => s.genre === fg);
      }
      if(favOnly){
        filtered = filtered.filter(s => s.fav || s.xfav);
      }

      const sorted = sortSongs(filtered);

      // stats (based on ALL songs, not filtered)
      const allArtists = getUniqueArtists(songs);
      $("statArtists").textContent = allArtists.length.toString();
      $("statSongs").textContent = songs.length.toString();
      $("statFav").textContent = songs.filter(s=>!!s.fav).length.toString();
      $("statXFav").textContent = songs.filter(s=>!!s.xfav).length.toString();

      // group by artist
      const byArtist = new Map();
      for(const s of sorted){
        const a = norm(s.artist) || "Unknown artist";
        if(!byArtist.has(a)) byArtist.set(a, []);
        byArtist.get(a).push(s);
      }

      // Artist numbering based on ALL artists (global list)
      const artistIndex = new Map();
      allArtists.forEach((a,i)=> artistIndex.set(a, i+1));

      // Global song numbering across ALL songs sorted
      const globalSortedAll = sortSongs(songs);
      const globalSongNo = new Map();
      globalSortedAll.forEach((s,i)=> globalSongNo.set(s.id, i+1));

      const root = $("list");
      root.innerHTML = "";

      if(sorted.length === 0){
        const empty = document.createElement("div");
        empty.className = "muted";
        empty.style.padding = "10px 2px";
        empty.textContent = "No songs match your filters yet. Tap “Add song”.";
        root.appendChild(empty);
        return;
      }

      // artist blocks in A–Z
      const artistNames = [...byArtist.keys()].sort((a,b)=> key(a).localeCompare(key(b)));
      for(const artistName of artistNames){
        const list = byArtist.get(artistName);
        const block = document.createElement("div");
        block.className = "artistBlock";

        const h = document.createElement("div");
        h.className = "artistHeader";

        const left = document.createElement("div");
        left.className = "left";

        const aNo = artistIndex.get(artistName) || null;

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = aNo ? `#${aNo} ${artistName}` : artistName;

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `${list.length} song${list.length===1?"":"s"}`;

        left.appendChild(name);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.className = "meta";
        right.textContent = "";

        h.appendChild(left);
        h.appendChild(right);

        const songsDiv = document.createElement("div");
        songsDiv.className = "songs";

        list.forEach((s, idx)=>{
          const card = document.createElement("div");
          card.className = "songCard";

          const main = document.createElement("div");

          const title = document.createElement("div");
          title.className = "songTitle";

          // show global song number and per-artist number
          const gNo = globalSongNo.get(s.id) || "";
          const perArtistNo = idx + 1;
          title.textContent = `Song #${gNo} · ${perArtistNo}. ${s.title}`;

          const meta = document.createElement("div");
          meta.className = "songMeta";

          if(s.mood) meta.appendChild(tagEl(`Mood: ${s.mood}`));
          if(s.genre) meta.appendChild(tagEl(`Genre: ${s.genre}`));
          if(s.fav) meta.appendChild(tagEl("Favorite", "fav"));
          if(s.xfav) meta.appendChild(tagEl("Extra favorite", "xfav"));

          main.appendChild(title);
          main.appendChild(meta);

          const actions = document.createElement("div");
          actions.className = "actions";

          const btnEdit = document.createElement("button");
          btnEdit.className = "iconBtn";
          btnEdit.textContent = "Edit";
          btnEdit.onclick = ()=> openModal(s.id);

          actions.appendChild(btnEdit);

          card.appendChild(main);
          card.appendChild(actions);

          songsDiv.appendChild(card);
        });

        block.appendChild(h);
        block.appendChild(songsDiv);
        root.appendChild(block);
      }
    }

    function tagEl(text, cls=""){
      const t = document.createElement("span");
      t.className = "tag " + cls;
      t.textContent = text;
      return t;
    }

    // ====== Modal Add/Edit ======
    function openModal(id=null){
      editingId = id;
      $("modalWrap").style.display = "flex";
      $("btnDelete").style.display = id ? "inline-block" : "none";
      $("modalTitle").textContent = id ? "Edit song" : "Add song";

      if(id){
        const s = songs.find(x=>x.id===id);
        $("inArtist").value = s?.artist || "";
        $("inTitle").value = s?.title || "";
        $("inMood").value = s?.mood || "";
        $("inGenre").value = s?.genre || "";
        $("inFav").checked = !!s?.fav;
        $("inXFav").checked = !!s?.xfav;
      }else{
        $("inArtist").value = "";
        $("inTitle").value = "";
        $("inMood").value = "";
        $("inGenre").value = "";
        $("inFav").checked = false;
        $("inXFav").checked = false;
      }

      // focus first field
      setTimeout(()=> $("inArtist").focus(), 50);
    }

    function closeModal(){
      $("modalWrap").style.display = "none";
      editingId = null;
    }

    function upsertSong(){
      const artist = norm($("inArtist").value);
      const title = norm($("inTitle").value);
      const mood = $("inMood").value || "";
      const genre = $("inGenre").value || "";
      const fav = $("inFav").checked;
      const xfav = $("inXFav").checked;

      if(!artist || !title){
        alert("Please enter both Artist and Song Title.");
        return;
      }

      if(editingId){
        const idx = songs.findIndex(s=>s.id===editingId);
        if(idx >= 0){
          songs[idx] = { ...songs[idx], artist, title, mood, genre, fav, xfav };
        }
      }else{
        songs.push({ id: uid(), artist, title, mood, genre, fav, xfav, createdAt: Date.now() });
      }

      saveLocal();
      closeModal();
      render();
    }

    function deleteSong(){
      if(!editingId) return;
      const ok = confirm("Delete this song?");
      if(!ok) return;
      songs = songs.filter(s=>s.id!==editingId);
      saveLocal();
      closeModal();
      render();
    }

    // ====== GitHub Gist Sync (optional) ======
    async function loadFromGist(){
      saveSyncSettings();
      const gistId = $("gistId").value.trim();
      const token = $("ghToken").value.trim();
      if(!gistId || !token){
        alert("Fill in both Gist ID and GitHub token first.");
        return;
      }

      const res = await fetch(`https://api.github.com/gists/${gistId}`, {
        headers: { "Authorization": `token ${token}` }
      });

      if(!res.ok){
        alert("Could not load gist. Check Gist ID / token.");
        return;
      }

      const data = await res.json();
      const file = data.files && (data.files["songs.json"] || Object.values(data.files)[0]);
      if(!file || typeof file.content !== "string"){
        alert("No songs.json found in that gist.");
        return;
      }

      try{
        const parsed = JSON.parse(file.content || "[]");
        if(!Array.isArray(parsed)) throw new Error("not array");
        songs = parsed;
        saveLocal();
        render();
        alert("Loaded from Gist ✅");
      }catch(e){
        alert("Gist file content is not valid JSON.");
      }
    }

    async function saveToGist(){
      saveSyncSettings();
      const gistId = $("gistId").value.trim();
      const token = $("ghToken").value.trim();
      if(!gistId || !token){
        alert("Fill in both Gist ID and GitHub token first.");
        return;
      }

      const body = {
        files: {
          "songs.json": { content: JSON.stringify(songs, null, 2) }
        }
      };

      const res = await fetch(`https://api.github.com/gists/${gistId}`, {
        method: "PATCH",
        headers: {
          "Authorization": `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      if(!res.ok){
        alert("Could not save gist. Check token permissions.");
        return;
      }

      alert("Saved to Gist ✅");
    }

    function clearLocal(){
      const ok = confirm("Clear ALL local data on this device?");
      if(!ok) return;
      localStorage.removeItem(LS_KEY);
      songs = [];
      render();
    }

    // ====== Init ======
    function init(){
      fillSelect($("filterMood"), MOODS);
      fillSelect($("filterGenre"), GENRES);
      fillSelect($("inMood"), MOODS.filter(x=>x!=="Any"));
      fillSelect($("inGenre"), GENRES.filter(x=>x!=="Any"));

      loadLocal();
      loadSyncSettings();
      render();

      $("q").addEventListener("input", render);
      $("filterMood").addEventListener("change", render);
      $("filterGenre").addEventListener("change", render);

      $("btnAdd").onclick = ()=> openModal(null);
      $("btnCancel").onclick = closeModal;
      $("modalWrap").onclick = (e)=> { if(e.target.id==="modalWrap") closeModal(); };
      $("btnSave").onclick = upsertSong;
      $("btnDelete").onclick = deleteSong;

      $("btnFavOnly").onclick = ()=>{
        favOnly = !favOnly;
        $("btnFavOnly").textContent = favOnly ? "Showing favorites" : "Show favorites";
        render();
      };

      $("btnReset").onclick = ()=>{
        $("q").value = "";
        $("filterMood").value = "";
        $("filterGenre").value = "";
        favOnly = false;
        $("btnFavOnly").textContent = "Show favorites";
        render();
      };

      $("btnLoadGist").onclick = loadFromGist;
      $("btnSaveGist").onclick = saveToGist;
      $("btnClearLocal").onclick = clearLocal;

      // autosave sync settings when user types
      $("gistId").addEventListener("input", saveSyncSettings);
      $("ghToken").addEventListener("input", saveSyncSettings);
    }

    init();
  </script>
</body>
</html>

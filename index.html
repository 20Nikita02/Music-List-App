<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Music Index</title>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#12141c;
      --muted:#9aa3b2;
      --text:#e9ecf3;
      --line:#24283a;
      --chip:#1b2030;
      --chip2:#202743;
      --accent:#7aa2ff;
      --good:#44d18b;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:linear-gradient(180deg,#090a0f, #0b0c10);
      color:var(--text);
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    header{
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding: 14px 14px 10px;
      background: rgba(18,20,28,.85);
      border:1px solid var(--line);
      border-radius: var(--radius);
      position: sticky;
      top: 10px;
      backdrop-filter: blur(10px);
      z-index: 10;
    }
    .toprow{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      gap: 10px;
      align-items:center;
      min-width: 220px;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: radial-gradient(circle at 30% 30%, var(--accent), #4457ff 60%, #1f2450);
      border:1px solid rgba(255,255,255,.12);
    }
    h1{
      margin:0;
      font-size: 16px;
      letter-spacing: .2px;
      line-height:1.1;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-size: 12px;
      line-height:1.2;
    }
    .controls{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    button, .btn{
      appearance:none;
      border:1px solid var(--line);
      background: linear-gradient(180deg,#161a27,#12141c);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 600;
      font-size: 13px;
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease;
      display:inline-flex;
      gap: 8px;
      align-items:center;
      user-select:none;
    }
    button:active{ transform: translateY(1px); }
    button:hover{ border-color: rgba(122,162,255,.45); }

    .btn-ghost{
      background: transparent;
    }
    .btn-accent{
      border-color: rgba(122,162,255,.5);
      box-shadow: 0 0 0 4px rgba(122,162,255,.08) inset;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .search{
      flex: 1 1 260px;
      min-width: 220px;
      display:flex;
      gap:8px;
      align-items:center;
      background:#0f111a;
      border:1px solid var(--line);
      padding: 10px 12px;
      border-radius: 14px;
    }
    .search input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size: 14px;
    }
    .pillbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      border:1px solid var(--line);
      background: rgba(27,32,48,.75);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      display:inline-flex;
      gap: 8px;
      align-items:center;
      white-space:nowrap;
    }
    .chip b{ color: var(--text); font-weight: 700; }
    .chip .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(122,162,255,.12);
    }

    details.panel{
      border:1px solid var(--line);
      background: rgba(18,20,28,.85);
      border-radius: var(--radius);
      padding: 10px 12px;
    }
    details.panel > summary{
      cursor:pointer;
      font-weight: 800;
      font-size: 13px;
      color: var(--text);
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    details.panel > summary::-webkit-details-marker{ display:none; }
    .summaryRight{
      color:var(--muted);
      font-weight:600;
      font-size: 12px;
    }
    .panelGrid{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
    input[type="text"], input[type="number"], select, textarea{
      width:100%;
      background:#0f111a;
      border:1px solid var(--line);
      color:var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 14px;
      outline:none;
    }
    select{
      appearance: auto; /* native dropdown (works everywhere) */
    }
    textarea{ min-height: 72px; resize: vertical; }

    .inline{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .toggle{
      display:flex;
      gap: 8px;
      align-items:center;
      padding: 8px 10px;
      border:1px solid var(--line);
      background: rgba(15,17,26,.65);
      border-radius: 12px;
      font-size: 13px;
      color: var(--text);
      user-select:none;
    }
    .toggle input{ transform: scale(1.15); }

    .list{
      border:1px solid var(--line);
      background: rgba(18,20,28,.75);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .artistBlock{
      border-top:1px solid var(--line);
    }
    .artistHead{
      padding: 12px 12px;
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .artistLeft{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      min-width: 0;
      flex: 1 1 auto;
    }
    .badge{
      flex: 0 0 auto;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .4px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(122,162,255,.35);
      background: rgba(122,162,255,.10);
      color: var(--text);
      line-height:1;
      white-space:nowrap;
    }
    .artistName{
      margin:0;
      font-size: 15px;
      font-weight: 900;
      line-height:1.2;
      word-break: break-word;
      overflow-wrap:anywhere;
    }
    .artistMeta{
      margin-top: 3px;
      font-size: 12px;
      color: var(--muted);
    }
    .artistActions{
      flex: 0 0 auto;
      display:flex;
      gap: 8px;
    }
    .iconbtn{
      padding: 10px 10px;
      border-radius: 12px;
    }

    .songs{
      padding: 0 12px 12px;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .songRow{
      display:grid;
      grid-template-columns: auto 1fr auto;
      gap: 10px;
      align-items:start;
      padding: 10px 10px;
      border:1px solid var(--line);
      background: rgba(15,17,26,.55);
      border-radius: 14px;
    }
    .sIdx{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      padding-top: 2px;
      white-space:nowrap;
    }
    .songMain{
      min-width:0;
    }
    .songTitle{
      margin:0;
      font-size: 14px;
      font-weight: 900;
      line-height:1.25;
      word-break: break-word;
      overflow-wrap:anywhere;
    }
    .songSub{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tag{
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(27,32,48,.7);
      color: var(--text);
      font-size: 11px;
      font-weight: 800;
      white-space:nowrap;
    }
    .tag.muted{ color: var(--muted); font-weight: 700; }
    .fav{
      border-color: rgba(68,209,139,.35);
      background: rgba(68,209,139,.10);
    }
    .xfav{
      border-color: rgba(255,204,102,.35);
      background: rgba(255,204,102,.10);
    }

    .songActions{
      display:flex;
      gap: 6px;
      align-items:center;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 720px){
      .panelGrid{ grid-template-columns: 1fr 1fr; }
      .grid2{ grid-template-columns: 1fr 1fr; }
    }

    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height:1.3;
    }
    .hr{
      height:1px;
      background: var(--line);
      margin: 10px 0;
    }

    /* Charts */
    .charts{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 860px){
      .charts{ grid-template-columns: 1fr 1fr; }
    }
    .chartCard{
      border:1px solid var(--line);
      background: rgba(18,20,28,.80);
      border-radius: var(--radius);
      padding: 12px;
    }
    .chartTitle{
      margin:0 0 10px 0;
      font-size: 13px;
      font-weight: 900;
      color: var(--text);
    }
    canvas{ width:100%; height: 240px; display:block; }
    .smallCanvas{ height: 200px; }

    /* Prevent accidental horizontal scroll */
    html, body { overflow-x:hidden; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="toprow">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>My Music Index</h1>
            <p class="sub">Vertical, mobile-first list ‚Ä¢ Auto A‚ÄìZ ‚Ä¢ Import/Export for syncing</p>
          </div>
        </div>

        <div class="controls">
          <button class="btn-accent" id="toggleAdd">Ôºã Add New Song</button>
          <button class="btn" id="exportBtn">‚¨á Export</button>
          <label class="btn btn-ghost" for="importFile" style="cursor:pointer;">‚¨Ü Import</label>
          <input id="importFile" type="file" accept="application/json" hidden />
          <button class="btn btn-ghost" id="resetBtn" title="Clears local data on this device only">Reset Local</button>
        </div>
      </div>

      <div class="row">
        <div class="search">
          üîé
          <input id="search" type="text" placeholder="Search song or artist..." autocomplete="off" />
        </div>
        <div class="pillbar">
          <div class="chip"><span class="dot"></span><b id="statSongs">0</b> songs</div>
          <div class="chip"><span class="dot" style="background:var(--good)"></span><b id="statArtists">0</b> artists</div>
          <div class="chip"><span class="dot" style="background:var(--warn)"></span><b id="statFav">0</b> fav</div>
          <div class="chip"><span class="dot" style="background:var(--accent)"></span><b id="statXFav">0</b> x-fav</div>
        </div>
      </div>
    </header>

    <!-- Filters (collapsible) -->
    <details class="panel" id="filtersPanel" open>
      <summary>
        Filters
        <span class="summaryRight" id="filtersSummary">All</span>
      </summary>

      <div class="panelGrid">
        <div class="field">
          <label for="genreFilter">Genre</label>
          <select id="genreFilter"></select>
        </div>

        <div class="field">
          <label for="moodFilter">Mood</label>
          <select id="moodFilter"></select>
        </div>

        <div class="field">
          <label for="countryFilter">Country</label>
          <select id="countryFilter"></select>
        </div>

        <div class="field">
          <label>Favorites</label>
          <div class="inline">
            <label class="toggle"><input type="checkbox" id="onlyFav"> Only Favorite</label>
            <label class="toggle"><input type="checkbox" id="onlyXFav"> Only Extra Favorite</label>
          </div>
          <div class="hint">Tip: You can use search + filters together.</div>
        </div>
      </div>
    </details>

    <!-- Add new song (hidden until button) -->
    <details class="panel" id="addPanel">
      <summary>
        Add / Edit Song
        <span class="summaryRight" id="addSummary">Closed</span>
      </summary>

      <div class="grid2">
        <div class="field">
          <label for="artistInput">Artist</label>
          <input id="artistInput" type="text" placeholder="e.g. Radiohead" list="artistsList" />
          <datalist id="artistsList"></datalist>
        </div>

        <div class="field">
          <label for="titleInput">Song Title</label>
          <input id="titleInput" type="text" placeholder="e.g. Karma Police" list="songsList" />
          <datalist id="songsList"></datalist>
        </div>

        <div class="field">
          <label for="genreSelect">Genre</label>
          <select id="genreSelect"></select>
          <div class="inline">
            <input id="newGenre" type="text" placeholder="Add new genre (optional)" />
            <button id="addGenreBtn" type="button">Add</button>
          </div>
        </div>

        <div class="field">
          <label for="moodSelect">Mood</label>
          <select id="moodSelect"></select>
          <div class="inline">
            <input id="newMood" type="text" placeholder="Add new mood (optional)" />
            <button id="addMoodBtn" type="button">Add</button>
          </div>
        </div>

        <div class="field">
          <label for="countrySelect">Country</label>
          <select id="countrySelect"></select>
          <div class="inline">
            <input id="newCountry" type="text" placeholder="Add new country (optional)" />
            <button id="addCountryBtn" type="button">Add</button>
          </div>
        </div>

        <div class="field">
          <label>Flags</label>
          <div class="inline">
            <label class="toggle"><input type="checkbox" id="favInput"> Favorite</label>
            <label class="toggle"><input type="checkbox" id="xfavInput"> Extra Favorite</label>
          </div>
          <div class="hint">Extra Favorite = your ‚Äúrepeat / top‚Äù songs.</div>
        </div>

        <div class="field" style="grid-column: 1 / -1;">
          <label for="notesInput">Notes (optional)</label>
          <textarea id="notesInput" placeholder="Optional extra info..."></textarea>
        </div>

        <div class="inline" style="grid-column: 1 / -1; justify-content:flex-end;">
          <button class="btn-ghost" id="cancelEdit" type="button">Cancel</button>
          <button class="btn-accent" id="saveSong" type="button">Save Song</button>
        </div>

        <div class="hint" style="grid-column: 1 / -1;">
          Everything saves automatically to <b>this device</b>. Use Export/Import to move data to other devices.
        </div>
      </div>
    </details>

    <!-- Charts -->
    <div class="charts">
      <div class="chartCard">
        <p class="chartTitle">Genres (count)</p>
        <canvas id="genreChart" class="smallCanvas"></canvas>
      </div>
      <div class="chartCard">
        <p class="chartTitle">Top Artists (song count)</p>
        <canvas id="artistChart"></canvas>
      </div>
    </div>

    <!-- List -->
    <div class="list" id="list"></div>

    <p class="hint">
      Sync tip: Export on device A ‚Üí Import on device B. (GitHub hosts the page, but your data is local unless you import/export.)
    </p>
  </div>

<script>
(() => {
  // ---------- Storage ----------
  const STORAGE_KEY = "my_music_index_v1";
  const META_KEY = "my_music_index_meta_v1";

  const defaultGenres = [
    "Pop","Rock","Hip-Hop","R&B","Electronic","Classical","Jazz","Indie",
    "K-Pop","Country","Hard Rock","Gospel","Metal Rock","French"
  ];
  const defaultMoods = ["Happy","Sad","Energized","Calm","Instrumental","Chill","Focus","Party"];
  const defaultCountries = ["USA","UK","Netherlands","Korea","Japan","France","Germany","Canada","Sweden","Brazil"];

  const $ = (id) => document.getElementById(id);

  const state = {
    songs: [],
    meta: {
      genres: [...defaultGenres],
      moods: [...defaultMoods],
      countries: [...defaultCountries]
    },
    editingId: null,

    filters: {
      search: "",
      genre: "All",
      mood: "All",
      country: "All",
      onlyFav: false,
      onlyXFav: false
    }
  };

  function load() {
    const raw = localStorage.getItem(STORAGE_KEY);
    const metaRaw = localStorage.getItem(META_KEY);
    if (raw) {
      try { state.songs = JSON.parse(raw) || []; } catch(e){ state.songs = []; }
    }
    if (metaRaw) {
      try {
        const meta = JSON.parse(metaRaw);
        if (meta?.genres) state.meta.genres = uniq([...defaultGenres, ...meta.genres]);
        if (meta?.moods) state.meta.moods = uniq([...defaultMoods, ...meta.moods]);
        if (meta?.countries) state.meta.countries = uniq([...defaultCountries, ...meta.countries]);
      } catch(e){}
    }
  }

  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state.songs));
    localStorage.setItem(META_KEY, JSON.stringify(state.meta));
  }

  // ---------- Helpers ----------
  const uniq = (arr) => [...new Set(arr.map(x => (x ?? "").trim()).filter(Boolean))];
  const norm = (s) => (s ?? "").toString().trim();
  const lower = (s) => norm(s).toLowerCase();
  const cmpAZ = (a,b) => lower(a).localeCompare(lower(b));

  function pad(n, len){ return String(n).padStart(len, "0"); }

  // ---------- UI Refs ----------
  const listEl = $("list");
  const searchEl = $("search");

  const genreFilter = $("genreFilter");
  const moodFilter = $("moodFilter");
  const countryFilter = $("countryFilter");
  const onlyFav = $("onlyFav");
  const onlyXFav = $("onlyXFav");

  const addPanel = $("addPanel");
  const toggleAdd = $("toggleAdd");
  const addSummary = $("addSummary");

  const artistInput = $("artistInput");
  const titleInput = $("titleInput");
  const genreSelect = $("genreSelect");
  const moodSelect = $("moodSelect");
  const countrySelect = $("countrySelect");
  const favInput = $("favInput");
  const xfavInput = $("xfavInput");
  const notesInput = $("notesInput");

  const artistsList = $("artistsList");
  const songsList = $("songsList");

  // meta add buttons
  $("addGenreBtn").addEventListener("click", () => addMeta("genres", $("newGenre").value, "newGenre"));
  $("addMoodBtn").addEventListener("click", () => addMeta("moods", $("newMood").value, "newMood"));
  $("addCountryBtn").addEventListener("click", () => addMeta("countries", $("newCountry").value, "newCountry"));

  function addMeta(key, value, inputId){
    const v = norm(value);
    if (!v) return;
    state.meta[key] = uniq([...state.meta[key], v]).sort(cmpAZ);
    $(inputId).value = "";
    save();
    populateSelects();
    render();
    // set current select to new item for convenience
    if (key === "genres") genreSelect.value = v;
    if (key === "moods") moodSelect.value = v;
    if (key === "countries") countrySelect.value = v;
  }

  // ---------- Populate selects ----------
  function fillSelect(select, options, includeAll=false){
    select.innerHTML = "";
    if (includeAll){
      const o = document.createElement("option");
      o.value = "All"; o.textContent = "All";
      select.appendChild(o);
    }
    options.sort(cmpAZ).forEach(opt => {
      const o = document.createElement("option");
      o.value = opt; o.textContent = opt;
      select.appendChild(o);
    });
  }

  function populateSelects(){
    fillSelect(genreFilter, ["All", ...state.meta.genres], false);
    fillSelect(moodFilter, ["All", ...state.meta.moods], false);
    fillSelect(countryFilter, ["All", ...state.meta.countries], false);

    // Make them real "All" filters
    genreFilter.value = state.filters.genre;
    moodFilter.value = state.filters.mood;
    countryFilter.value = state.filters.country;

    // For add form (include a blank)
    genreSelect.innerHTML = `<option value="">‚Äî</option>` + state.meta.genres.sort(cmpAZ).map(g => `<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join("");
    moodSelect.innerHTML  = `<option value="">‚Äî</option>` + state.meta.moods.sort(cmpAZ).map(m => `<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("");
    countrySelect.innerHTML = `<option value="">‚Äî</option>` + state.meta.countries.sort(cmpAZ).map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
  }

  // ---------- Filters ----------
  function wireFilters(){
    searchEl.addEventListener("input", () => { state.filters.search = searchEl.value; render(); });

    genreFilter.addEventListener("change", () => { state.filters.genre = genreFilter.value || "All"; render(); });
    moodFilter.addEventListener("change", () => { state.filters.mood = moodFilter.value || "All"; render(); });
    countryFilter.addEventListener("change", () => { state.filters.country = countryFilter.value || "All"; render(); });

    onlyFav.addEventListener("change", () => { state.filters.onlyFav = onlyFav.checked; render(); });
    onlyXFav.addEventListener("change", () => { state.filters.onlyXFav = onlyXFav.checked; render(); });
  }

  // ---------- Add/Edit Panel behavior ----------
  toggleAdd.addEventListener("click", () => {
    addPanel.open = true;
    addSummary.textContent = "Open";
    state.editingId = null;
    clearForm();
    setTimeout(() => artistInput.focus(), 50);
    // scroll into view if needed
    addPanel.scrollIntoView({behavior:"smooth", block:"start"});
  });

  addPanel.addEventListener("toggle", () => {
    addSummary.textContent = addPanel.open ? "Open" : "Closed";
    if (!addPanel.open) state.editingId = null;
  });

  $("cancelEdit").addEventListener("click", () => {
    state.editingId = null;
    clearForm();
    addPanel.open = false;
  });

  $("saveSong").addEventListener("click", () => {
    const artist = norm(artistInput.value);
    const title = norm(titleInput.value);
    if (!artist || !title){
      alert("Please fill in Artist and Song Title.");
      return;
    }

    const record = {
      id: state.editingId ?? crypto.randomUUID(),
      artist,
      title,
      genre: norm(genreSelect.value),
      mood: norm(moodSelect.value),
      country: norm(countrySelect.value),
      favorite: !!favInput.checked,
      xfavorite: !!xfavInput.checked,
      notes: norm(notesInput.value),
      updatedAt: Date.now(),
      createdAt: state.editingId ? (state.songs.find(s=>s.id===state.editingId)?.createdAt ?? Date.now()) : Date.now()
    };

    // If Extra Favorite is checked, auto set Favorite too (optional but usually desired)
    if (record.xfavorite) record.favorite = true;

    const idx = state.songs.findIndex(s => s.id === record.id);
    if (idx >= 0) state.songs[idx] = record;
    else state.songs.push(record);

    save();
    clearForm();
    addPanel.open = false;
    render();
  });

  function clearForm(){
    artistInput.value = "";
    titleInput.value = "";
    genreSelect.value = "";
    moodSelect.value = "";
    countrySelect.value = "";
    favInput.checked = false;
    xfavInput.checked = false;
    notesInput.value = "";
    $("newGenre").value = "";
    $("newMood").value = "";
    $("newCountry").value = "";
  }

  function startEdit(id){
    const s = state.songs.find(x => x.id === id);
    if (!s) return;
    state.editingId = id;
    addPanel.open = true;
    addSummary.textContent = "Open";
    artistInput.value = s.artist ?? "";
    titleInput.value = s.title ?? "";
    genreSelect.value = s.genre ?? "";
    moodSelect.value = s.mood ?? "";
    countrySelect.value = s.country ?? "";
    favInput.checked = !!s.favorite;
    xfavInput.checked = !!s.xfavorite;
    notesInput.value = s.notes ?? "";
    addPanel.scrollIntoView({behavior:"smooth", block:"start"});
  }

  function delSong(id){
    if (!confirm("Delete this song?")) return;
    state.songs = state.songs.filter(s => s.id !== id);
    save();
    render();
  }

  // ---------- Import / Export ----------
  $("exportBtn").addEventListener("click", () => {
    const payload = {
      version: 1,
      exportedAt: new Date().toISOString(),
      meta: state.meta,
      songs: state.songs
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "my-music-index-export.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  });

  $("importFile").addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    e.target.value = "";
    if (!file) return;
    const text = await file.text();
    try{
      const payload = JSON.parse(text);
      if (!payload?.songs || !Array.isArray(payload.songs)) throw new Error("Invalid file");
      // merge meta
      if (payload.meta){
        state.meta.genres = uniq([...state.meta.genres, ...(payload.meta.genres || [])]).sort(cmpAZ);
        state.meta.moods = uniq([...state.meta.moods, ...(payload.meta.moods || [])]).sort(cmpAZ);
        state.meta.countries = uniq([...state.meta.countries, ...(payload.meta.countries || [])]).sort(cmpAZ);
      }
      // merge songs by id (import overrides)
      const byId = new Map(state.songs.map(s => [s.id, s]));
      payload.songs.forEach(s => {
        if (!s?.id) s.id = crypto.randomUUID();
        byId.set(s.id, s);
      });
      state.songs = [...byId.values()];
      save();
      populateSelects();
      render();
      alert("Imported! Data saved locally on this device.");
    } catch(err){
      alert("Import failed. Please select a valid export JSON file.");
    }
  });

  $("resetBtn").addEventListener("click", () => {
    if (!confirm("This clears data only on THIS device. Continue?")) return;
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(META_KEY);
    state.songs = [];
    state.meta = {
      genres: [...defaultGenres].sort(cmpAZ),
      moods: [...defaultMoods].sort(cmpAZ),
      countries: [...defaultCountries].sort(cmpAZ)
    };
    save();
    populateSelects();
    render();
  });

  // ---------- Rendering ----------
  function applyFilters(s){
    const q = lower(state.filters.search);
    if (q){
      const hay = `${s.artist} ${s.title}`.toLowerCase();
      if (!hay.includes(q)) return false;
    }
    if (state.filters.genre !== "All" && norm(s.genre) !== norm(state.filters.genre)) return false;
    if (state.filters.mood !== "All" && norm(s.mood) !== norm(state.filters.mood)) return false;
    if (state.filters.country !== "All" && norm(s.country) !== norm(state.filters.country)) return false;

    if (state.filters.onlyFav && !s.favorite) return false;
    if (state.filters.onlyXFav && !s.xfavorite) return false;

    return true;
  }

  function sortedSongs(list){
    return [...list].sort((a,b) => {
      const c1 = cmpAZ(a.artist, b.artist);
      if (c1 !== 0) return c1;
      return cmpAZ(a.title, b.title);
    });
  }

  function groupByArtist(list){
    const map = new Map();
    list.forEach(s => {
      const key = norm(s.artist);
      if (!map.has(key)) map.set(key, []);
      map.get(key).push(s);
    });
    // sort keys A-Z
    const keys = [...map.keys()].sort(cmpAZ);
    return keys.map(k => ({ artist: k, songs: sortedSongs(map.get(k)) }));
  }

  function escapeHtml(str){
    return (str ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function renderStats(filteredSorted){
    const allSorted = sortedSongs(state.songs);
    const artists = uniq(allSorted.map(s=>s.artist));
    const favCount = allSorted.filter(s=>s.favorite).length;
    const xfavCount = allSorted.filter(s=>s.xfavorite).length;

    $("statSongs").textContent = allSorted.length;
    $("statArtists").textContent = artists.length;
    $("statFav").textContent = favCount;
    $("statXFav").textContent = xfavCount;

    // filters summary
    const parts = [];
    if (state.filters.genre !== "All") parts.push(`Genre: ${state.filters.genre}`);
    if (state.filters.mood !== "All") parts.push(`Mood: ${state.filters.mood}`);
    if (state.filters.country !== "All") parts.push(`Country: ${state.filters.country}`);
    if (state.filters.onlyFav) parts.push("Fav only");
    if (state.filters.onlyXFav) parts.push("X-Fav only");
    if (norm(state.filters.search)) parts.push(`Search: "${state.filters.search.trim()}"`);
    $("filtersSummary").textContent = parts.length ? parts.join(" ‚Ä¢ ") : "All";
  }

  function renderDatalists(){
    const artists = uniq(state.songs.map(s=>s.artist)).sort(cmpAZ);
    artistsList.innerHTML = artists.map(a => `<option value="${escapeHtml(a)}"></option>`).join("");

    // Suggest song titles (not perfect without artist context, but helpful)
    const titles = uniq(state.songs.map(s=>s.title)).sort(cmpAZ);
    songsList.innerHTML = titles.slice(0, 2500).map(t => `<option value="${escapeHtml(t)}"></option>`).join("");
  }

  function renderList(){
    const filtered = state.songs.filter(applyFilters);
    const filteredSorted = sortedSongs(filtered);
    renderStats(filteredSorted);
    renderDatalists();

    // Numbering based on FULL sorted list (not filtered), so indexes are stable
    const allSorted = sortedSongs(state.songs);
    const artistOrder = uniq(allSorted.map(s => s.artist)).sort(cmpAZ);
    const artistIndex = new Map(artistOrder.map((a,i)=>[a, i+1])); // 1-based

    const globalSongIndex = new Map(allSorted.map((s,i)=>[s.id, i+1])); // 1-based global

    const groups = groupByArtist(filteredSorted);

    if (filteredSorted.length === 0){
      listEl.innerHTML = `<div style="padding:14px;color:var(--muted);">No results. Try clearing filters or adding a song.</div>`;
      return { filteredSorted, allSorted };
    }

    listEl.innerHTML = groups.map(g => {
      const aIdx = artistIndex.get(g.artist) ?? 0;

      // per-artist numbering in current (filtered) group should still follow A-Z within artist
      // We‚Äôll also compute per-artist numbering within FULL data for stability:
      const fullArtistSongs = allSorted.filter(s => lower(s.artist) === lower(g.artist));
      const fullArtistMap = new Map(fullArtistSongs.map((s,i)=>[s.id, i+1]));

      const artistBadge = `#A${aIdx}`;
      const artistMeta = `${fullArtistSongs.length} total song(s)`;

      const songsHtml = g.songs.map(s => {
        const gIdx = globalSongIndex.get(s.id) ?? 0;
        const within = fullArtistMap.get(s.id) ?? 0;
        const sIdx = `#S${pad(gIdx, 5)} ‚Ä¢ #${pad(aIdx,2)}.${pad(within,3)}`;

        const tags = [];
        if (s.genre) tags.push(`<span class="tag">${escapeHtml(s.genre)}</span>`);
        if (s.mood) tags.push(`<span class="tag">${escapeHtml(s.mood)}</span>`);
        if (s.country) tags.push(`<span class="tag muted">${escapeHtml(s.country)}</span>`);
        if (s.favorite) tags.push(`<span class="tag fav">‚òÖ Fav</span>`);
        if (s.xfavorite) tags.push(`<span class="tag xfav">‚òÖ‚òÖ X-Fav</span>`);

        return `
          <div class="songRow">
            <div class="sIdx">${escapeHtml(sIdx)}</div>
            <div class="songMain">
              <p class="songTitle">${escapeHtml(s.title)}</p>
              <div class="songSub">
                ${tags.join("")}
              </div>
            </div>
            <div class="songActions">
              <button class="iconbtn" title="Edit" onclick="window.__editSong('${s.id}')">‚úé</button>
              <button class="iconbtn" title="Delete" onclick="window.__delSong('${s.id}')">üóë</button>
            </div>
          </div>
        `;
      }).join("");

      return `
        <div class="artistBlock">
          <div class="artistHead">
            <div class="artistLeft">
              <div class="badge">${escapeHtml(artistBadge)}</div>
              <div style="min-width:0">
                <p class="artistName">${escapeHtml(g.artist)}</p>
                <div class="artistMeta">${escapeHtml(artistMeta)}</div>
              </div>
            </div>
            <div class="artistActions">
              <span class="chip"><b>${g.songs.length}</b> shown</span>
            </div>
          </div>
          <div class="songs">
            ${songsHtml}
          </div>
        </div>
      `;
    }).join("");

    return { filteredSorted, allSorted };
  }

  // ---------- Simple Charts (no libraries) ----------
  function drawBarChart(canvas, labels, values){
    const ctx = canvas.getContext("2d");
    const dpr = window.devicePixelRatio || 1;
    const w = canvas.clientWidth * dpr;
    const h = canvas.clientHeight * dpr;
    canvas.width = w; canvas.height = h;

    ctx.clearRect(0,0,w,h);

    const padL = 10*dpr, padR=10*dpr, padT=10*dpr, padB=28*dpr;
    const innerW = w - padL - padR;
    const innerH = h - padT - padB;

    const max = Math.max(1, ...values);
    const n = values.length;
    const gap = Math.max(6*dpr, innerW * 0.02);
    const barW = (innerW - gap*(n-1)) / Math.max(1,n);

    // baseline
    ctx.globalAlpha = 1;
    ctx.fillStyle = "rgba(255,255,255,0.10)";
    ctx.fillRect(padL, padT + innerH, innerW, 1*dpr);

    // bars
    for (let i=0;i<n;i++){
      const v = values[i];
      const bh = (v / max) * innerH;
      const x = padL + i*(barW+gap);
      const y = padT + (innerH - bh);

      // bar
      ctx.fillStyle = "rgba(122,162,255,0.65)";
      ctx.fillRect(x, y, barW, bh);

      // top highlight
      ctx.fillStyle = "rgba(255,255,255,0.12)";
      ctx.fillRect(x, y, barW, 2*dpr);

      // label (truncate)
      const label = labels[i].length > 10 ? labels[i].slice(0,10)+"‚Ä¶" : labels[i];
      ctx.fillStyle = "rgba(233,236,243,0.75)";
      ctx.font = `${12*dpr}px ui-sans-serif, system-ui`;
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      ctx.fillText(label, x + barW/2, padT + innerH + 6*dpr);
    }
  }

  function drawPieLike(canvas, labels, values){
    // Not a true pie (better readability on mobile): draw horizontal bars with counts.
    const ctx = canvas.getContext("2d");
    const dpr = window.devicePixelRatio || 1;
    const w = canvas.clientWidth * dpr;
    const h = canvas.clientHeight * dpr;
    canvas.width = w; canvas.height = h;
    ctx.clearRect(0,0,w,h);

    const pad = 12*dpr;
    const rowH = 20*dpr;
    const maxRows = Math.floor((h - pad*2) / rowH);
    const pairs = labels.map((l,i)=>({l, v: values[i]})).sort((a,b)=>b.v-a.v).slice(0, Math.max(1,maxRows));

    const max = Math.max(1, ...pairs.map(p=>p.v));
    const barMaxW = w - pad*2;

    ctx.font = `${12*dpr}px ui-sans-serif, system-ui`;
    ctx.textBaseline = "middle";

    pairs.forEach((p, idx) => {
      const y = pad + idx*rowH + rowH/2;
      const bw = (p.v / max) * (barMaxW*0.55);

      // label
      ctx.fillStyle = "rgba(233,236,243,0.85)";
      ctx.textAlign = "left";
      const label = p.l.length > 18 ? p.l.slice(0,18)+"‚Ä¶" : p.l;
      ctx.fillText(label, pad, y);

      // bar
      const bx = pad + barMaxW*0.40;
      ctx.fillStyle = "rgba(122,162,255,0.55)";
      ctx.fillRect(bx, y - 6*dpr, bw, 12*dpr);

      // value
      ctx.fillStyle = "rgba(154,163,178,0.9)";
      ctx.textAlign = "right";
      ctx.fillText(String(p.v), pad + barMaxW, y);
    });
  }

  function renderCharts(allSorted){
    // Genre counts
    const genreMap = new Map();
    allSorted.forEach(s => {
      const g = norm(s.genre) || "‚Äî";
      genreMap.set(g, (genreMap.get(g)||0)+1);
    });
    const genrePairs = [...genreMap.entries()].sort((a,b)=>b[1]-a[1]).slice(0, 12);
    drawPieLike($("genreChart"), genrePairs.map(x=>x[0]), genrePairs.map(x=>x[1]));

    // Top artists
    const artistMap = new Map();
    allSorted.forEach(s => {
      const a = norm(s.artist) || "‚Äî";
      artistMap.set(a, (artistMap.get(a)||0)+1);
    });
    const top = [...artistMap.entries()].sort((a,b)=>b[1]-a[1]).slice(0, 10);
    drawBarChart($("artistChart"), top.map(x=>x[0]), top.map(x=>x[1]));
  }

  function render(){
    // keep filter dropdown values synced
    state.filters.genre = genreFilter.value || "All";
    state.filters.mood = moodFilter.value || "All";
    state.filters.country = countryFilter.value || "All";
    state.filters.onlyFav = onlyFav.checked;
    state.filters.onlyXFav = onlyXFav.checked;

    const { allSorted } = renderList();
    renderCharts(allSorted);

    // save continuously? we already save on change actions. no need here.
  }

  // Make edit/delete accessible from inline onclick
  window.__editSong = (id) => startEdit(id);
  window.__delSong = (id) => delSong(id);

  // ---------- Init ----------
  function init(){
    load();
    state.meta.genres = uniq(state.meta.genres).sort(cmpAZ);
    state.meta.moods = uniq(state.meta.moods).sort(cmpAZ);
    state.meta.countries = uniq(state.meta.countries).sort(cmpAZ);

    // Setup filter selects with "All" option manually
    genreFilter.innerHTML = `<option value="All">All</option>` + state.meta.genres.map(g=>`<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join("");
    moodFilter.innerHTML = `<option value="All">All</option>` + state.meta.moods.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("");
    countryFilter.innerHTML = `<option value="All">All</option>` + state.meta.countries.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

    // defaults
    state.filters.genre = "All";
    state.filters.mood = "All";
    state.filters.country = "All";
    genreFilter.value = "All";
    moodFilter.value = "All";
    countryFilter.value = "All";

    populateSelects();
    wireFilters();

    // start with add panel closed; show summary accordingly
    addPanel.open = false;
    addSummary.textContent = "Closed";

    render();

    // redraw charts on resize
    window.addEventListener("resize", () => render());
  }

  init();
})();
</script>
</body>
</html>

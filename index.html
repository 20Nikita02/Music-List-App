<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>My Songs</title>
  <style>
    :root{
      --bg:#070a12;
      --panel:#0b1020;
      --panel2:#0b1227;
      --stroke:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.45);
      --chip:rgba(255,255,255,.08);
      --chip2:rgba(255,255,255,.10);
      --ok:rgba(80, 200, 140, .20);
      --warn:rgba(255, 210, 80, .20);
      --shadow:0 16px 50px rgba(0,0,0,.55);
      --r:18px;
      --r2:14px;
      --gap:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1000px 700px at 20% 10%, rgba(80,120,255,.20), transparent 55%),
                  radial-gradient(900px 700px at 90% 30%, rgba(255,120,200,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
    }

    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 80px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      margin-top:8px;margin-bottom:14px;
    }
    .title{
      display:flex;align-items:center;gap:10px;
    }
    .logo{
      width:38px;height:38px;border-radius:14px;
      background:linear-gradient(135deg, rgba(120,170,255,.22), rgba(255,120,200,.12));
      border:1px solid var(--stroke);
      display:grid;place-items:center;
      box-shadow:var(--shadow);
      flex:0 0 auto;
    }
    h1{font-size:22px;margin:0;letter-spacing:.2px}
    .sub{margin:2px 0 0;color:var(--muted);font-size:12px}

    .topbar{
      display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.2px;
      box-shadow:0 10px 35px rgba(0,0,0,.25);
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:linear-gradient(135deg, rgba(120,170,255,.24), rgba(255,255,255,.06));
    }
    .btn.danger{
      background:rgba(255,80,80,.10);
    }

    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:var(--gap);
    }
    @media(min-width:920px){
      .grid{grid-template-columns: 1fr 1fr;}
      .span2{grid-column:1 / -1;}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    details.card{
      padding:0;
    }
    details.card > summary{
      list-style:none;
      cursor:pointer;
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    details.card > summary::-webkit-details-marker{display:none}
    .summaryTitle{
      display:flex;align-items:center;gap:10px;font-weight:800;
    }
    .summaryMeta{color:var(--muted);font-size:12px}

    .content{padding:0 14px 14px}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{
      display:flex;flex-direction:column;gap:6px;
      min-width: 160px;
      flex:1 1 180px;
    }
    label{font-size:12px;color:var(--muted)}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
      font-size:14px;
      -webkit-appearance: none;
      appearance: none;
    }
    select{
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.6) 50%),
        linear-gradient(135deg, rgba(255,255,255,.6) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) calc(1em + 2px),
        calc(100% - 13px) calc(1em + 2px);
      background-size:5px 5px, 5px 5px;
      background-repeat:no-repeat;
      padding-right:34px;
    }
    .mini{
      flex:0 1 220px;
    }
    .inlineActions{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:10px
    }

    .toolbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin-bottom:10px;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
    }

    .search{
      flex:1 1 280px;
      min-width: 220px;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* Artist block */
    .artistBlock{
      border:1px solid var(--stroke);
      border-radius:var(--r);
      overflow:hidden;
      background:rgba(255,255,255,.03);
    }
    .artistHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      padding:12px 12px;
      background:rgba(0,0,0,.15);
    }
    .artistLeft{
      display:flex;align-items:flex-start;gap:10px;min-width:0;
    }
    .badge{
      flex:0 0 auto;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      font-weight:800;
      font-size:12px;
      letter-spacing:.2px;
      color:rgba(255,255,255,.85);
    }
    .artistName{
      font-weight:900;
      font-size:18px;
      line-height:1.1;
      margin-top:2px;
      overflow-wrap:anywhere;
    }
    .artistMeta{
      color:var(--muted);
      font-size:12px;
      margin-top:4px;
    }

    .songs{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    /* Song row: compact + wraps long titles */
    .songRow{
      border:1px solid var(--stroke);
      border-radius:16px;
      background:rgba(255,255,255,.03);
      padding:10px 10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .songMain{
      flex:1 1 auto;
      min-width:0;
    }
    .songTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .songTitleLine{
      min-width:0;
    }
    .songTitle{
      font-weight:900;
      font-size:15px;
      line-height:1.2;
      margin:0;
      overflow-wrap:anywhere;     /* wrap long titles */
      word-break:break-word;
      white-space:normal;
    }
    .songIds{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .idchip{
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      border-radius:999px;
      padding:5px 8px;
      font-weight:800;
      letter-spacing:.2px;
    }

    /* chips in ONE ROW (wrap if needed) */
    .chipsRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .chip{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:var(--chip);
      font-size:12px;
      color:rgba(255,255,255,.84);
      white-space:nowrap;
    }
    .chip.fav{background:var(--ok); font-weight:800}
    .chip.xfav{background:var(--warn); font-weight:900}
    .chip.muted{color:var(--muted)}
    .songActions{
      flex:0 0 auto;
      display:flex;
      gap:8px;
    }
    .iconBtn{
      width:40px;height:40px;border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.85);
      cursor:pointer;
      display:grid;place-items:center;
    }

    .smallNote{
      color:var(--muted2);
      font-size:12px;
      line-height:1.4;
      margin-top:8px;
    }

    .hr{height:1px;background:var(--stroke);margin:12px 0}

    /* Chart (simple bars) */
    .chart{
      display:flex;flex-direction:column;gap:8px;margin-top:8px;
    }
    .barRow{
      display:flex;align-items:center;gap:10px;
    }
    .barLabel{
      width:120px;max-width:42vw;
      color:var(--muted);
      font-size:12px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .barTrack{
      flex:1;
      height:10px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      border-radius:999px;
      overflow:hidden;
    }
    .barFill{
      height:100%;
      background:rgba(140,170,255,.55);
      width:0%;
    }
    .barValue{
      width:44px;text-align:right;color:var(--muted);font-size:12px;
    }

    .hidden{display:none !important;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>

<body>
  <div class="wrap">

    <header>
      <div class="title">
        <div class="logo">ðŸŽµ</div>
        <div>
          <h1>All Songs</h1>
          <div class="sub">Compact â€¢ vertical scroll â€¢ fast add/edit â€¢ export/import</div>
        </div>
      </div>
      <div class="topbar">
        <button class="btn primary" id="toggleAddBtn">Add new song</button>
        <button class="btn" id="exportBtn">Export</button>
        <button class="btn" id="importBtn">Import</button>
        <input type="file" id="importFile" accept="application/json" class="hidden" />
      </div>
    </header>

    <div class="grid">
      <!-- Filters (collapsed by default) -->
      <details class="card span2" id="filtersCard">
        <summary>
          <div class="summaryTitle">ðŸ”Ž Filters</div>
          <div class="summaryMeta" id="filterMeta">Collapsed</div>
        </summary>
        <div class="content">
          <div class="toolbar">
            <input class="search" id="search" placeholder="Search song or artist..." />
            <div class="pill" id="statsPill">0 songs â€¢ 0 artists</div>
          </div>

          <div class="row">
            <div class="field mini">
              <label>Genre</label>
              <select id="genreFilter"></select>
            </div>
            <div class="field mini">
              <label>Mood</label>
              <select id="moodFilter"></select>
            </div>
            <div class="field mini">
              <label>Country</label>
              <select id="countryFilter"></select>
            </div>
            <div class="field mini">
              <label>Favorite</label>
              <select id="favFilter">
                <option value="all">All</option>
                <option value="fav">Fav</option>
                <option value="xfav">X-Fav</option>
                <option value="anyfav">Fav or X-Fav</option>
                <option value="none">No fav</option>
              </select>
            </div>
          </div>

          <div class="inlineActions">
            <button class="btn" id="clearFiltersBtn">Clear filters</button>
          </div>
          <div class="smallNote">
            Tip: keep Filters collapsed most of the time for maximum vertical space.
          </div>
        </div>
      </details>

      <!-- Add Song form (hidden until button) -->
      <div class="card span2 hidden" id="addCard">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div style="font-weight:900;font-size:16px">âž• Add / Edit Song</div>
          <button class="btn" id="closeAddBtn">Close</button>
        </div>
        <div class="hr"></div>

        <div class="row">
          <div class="field">
            <label>Song Title</label>
            <input id="songTitle" list="titleSuggestions" placeholder="e.g. Blinding Lights" />
            <datalist id="titleSuggestions"></datalist>
          </div>
          <div class="field">
            <label>Artist</label>
            <input id="artistName" list="artistSuggestions" placeholder="e.g. The Weeknd" />
            <datalist id="artistSuggestions"></datalist>
          </div>
        </div>

        <div class="row">
          <div class="field mini">
            <label>Genre</label>
            <select id="genreSelect"></select>
            <div class="row" style="margin-top:6px">
              <input id="newGenre" placeholder="Add new genreâ€¦" />
              <button class="btn" id="addGenreBtn">Add</button>
            </div>
          </div>

          <div class="field mini">
            <label>Mood</label>
            <select id="moodSelect"></select>
            <div class="row" style="margin-top:6px">
              <input id="newMood" placeholder="Add new moodâ€¦" />
              <button class="btn" id="addMoodBtn">Add</button>
            </div>
          </div>

          <div class="field mini">
            <label>Country</label>
            <select id="countrySelect"></select>
            <div class="row" style="margin-top:6px">
              <input id="newCountry" placeholder="Add new countryâ€¦" />
              <button class="btn" id="addCountryBtn">Add</button>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="field mini">
            <label>Favorite</label>
            <select id="favSelect">
              <option value="none">None</option>
              <option value="fav">Fav</option>
              <option value="xfav">X-Fav</option>
            </select>
          </div>
        </div>

        <div class="inlineActions">
          <button class="btn primary" id="saveBtn">Save</button>
          <button class="btn" id="resetBtn">Reset</button>
          <button class="btn danger hidden" id="deleteBtn">Delete</button>
          <span class="smallNote" id="editHint"></span>
        </div>

        <div class="smallNote">
          Data saves automatically on this device (localStorage). Use Export/Import to move data to another device.
        </div>
      </div>

      <!-- Charts (collapsed by default) -->
      <details class="card span2" id="chartsCard">
        <summary>
          <div class="summaryTitle">ðŸ“Š Charts (compact)</div>
          <div class="summaryMeta">Collapsed</div>
        </summary>
        <div class="content">
          <div style="display:grid;grid-template-columns:1fr;gap:12px">
            <div>
              <div style="font-weight:900;margin-bottom:6px">Genres (top)</div>
              <div class="chart" id="genreChart"></div>
            </div>
            <div>
              <div style="font-weight:900;margin-bottom:6px">Moods (top)</div>
              <div class="chart" id="moodChart"></div>
            </div>
          </div>
          <div class="smallNote">
            Charts are collapsed by default so your list stays compact for 5000+ songs.
          </div>
        </div>
      </details>

      <!-- List -->
      <div class="card span2">
        <div class="toolbar">
          <div class="pill mono" id="countPill">Songs: 0 â€¢ Artists: 0</div>
          <div class="pill mono" id="sortPill">Sort: Artist Aâ€“Z â†’ Song Aâ€“Z</div>
        </div>
        <div class="list" id="list"></div>

        <div class="smallNote">
          Sync tip: Export on device A â†’ Import on device B. GitHub hosts the page, but your data is local unless you export/import.
        </div>
      </div>
    </div>
  </div>

<script>
  // -------------------------
  // Storage
  // -------------------------
  const STORE_KEY = "mySongs.v4";
  const PREF_KEY  = "mySongs.prefs.v1";

  function loadState(){
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return { songs: [], vocab: defaultVocab() };
    try{
      const parsed = JSON.parse(raw);
      if(!parsed.songs) parsed.songs = [];
      if(!parsed.vocab) parsed.vocab = defaultVocab();
      // merge in defaults if missing
      parsed.vocab = mergeVocab(defaultVocab(), parsed.vocab);
      return parsed;
    }catch(e){
      return { songs: [], vocab: defaultVocab() };
    }
  }
  function saveState(){
    localStorage.setItem(STORE_KEY, JSON.stringify(state));
  }

  function loadPrefs(){
    const raw = localStorage.getItem(PREF_KEY);
    if(!raw) return {};
    try{return JSON.parse(raw)}catch(e){return {}}
  }
  function savePrefs(){
    localStorage.setItem(PREF_KEY, JSON.stringify(prefs));
  }

  // -------------------------
  // Default vocab (pick lists)
  // -------------------------
  function defaultVocab(){
    return {
      genres: [
        "Pop","Hip-Hop","R&B","Rock","Hard Rock","Metal Rock","Country","Gospel","K-Pop",
        "Jazz","Classical","Electronic","EDM","Lo-fi","Indie","Alternative","Instrumental",
        "French","Afrobeats","Reggaeton","Soundtrack","Other"
      ],
      moods: ["Happy","Sad","Energized","Calm","Instrumental","Chill","Focus","Romantic","Angry","Other"],
      countries: ["USA","UK","Netherlands","France","Germany","Japan","Korea","Nigeria","Brazil","Other"]
    };
  }
  function mergeVocab(base, custom){
    const out = {...base};
    for(const key of ["genres","moods","countries"]){
      const a = Array.isArray(base[key]) ? base[key] : [];
      const b = Array.isArray(custom[key]) ? custom[key] : [];
      out[key] = Array.from(new Set([...a, ...b])).filter(Boolean);
    }
    return out;
  }

  // -------------------------
  // State
  // -------------------------
  let state = loadState();
  let prefs = loadPrefs();

  // -------------------------
  // Elements
  // -------------------------
  const listEl = document.getElementById("list");
  const statsPill = document.getElementById("statsPill");
  const countPill = document.getElementById("countPill");

  const searchEl = document.getElementById("search");
  const genreFilter = document.getElementById("genreFilter");
  const moodFilter = document.getElementById("moodFilter");
  const countryFilter = document.getElementById("countryFilter");
  const favFilter = document.getElementById("favFilter");
  const clearFiltersBtn = document.getElementById("clearFiltersBtn");

  const addCard = document.getElementById("addCard");
  const toggleAddBtn = document.getElementById("toggleAddBtn");
  const closeAddBtn = document.getElementById("closeAddBtn");

  const songTitleEl = document.getElementById("songTitle");
  const artistNameEl = document.getElementById("artistName");
  const genreSelect = document.getElementById("genreSelect");
  const moodSelect = document.getElementById("moodSelect");
  const countrySelect = document.getElementById("countrySelect");
  const favSelect = document.getElementById("favSelect");

  const newGenreEl = document.getElementById("newGenre");
  const addGenreBtn = document.getElementById("addGenreBtn");
  const newMoodEl = document.getElementById("newMood");
  const addMoodBtn = document.getElementById("addMoodBtn");
  const newCountryEl = document.getElementById("newCountry");
  const addCountryBtn = document.getElementById("addCountryBtn");

  const saveBtn = document.getElementById("saveBtn");
  const resetBtn = document.getElementById("resetBtn");
  const deleteBtn = document.getElementById("deleteBtn");
  const editHint = document.getElementById("editHint");

  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");
  const importFile = document.getElementById("importFile");

  const titleSuggestions = document.getElementById("titleSuggestions");
  const artistSuggestions = document.getElementById("artistSuggestions");

  const genreChart = document.getElementById("genreChart");
  const moodChart = document.getElementById("moodChart");

  const filtersCard = document.getElementById("filtersCard");
  const filterMeta = document.getElementById("filterMeta");

  // -------------------------
  // Helpers
  // -------------------------
  function norm(s){ return (s||"").trim(); }
  function keyify(s){ return norm(s).toLowerCase(); }
  function pad(num, len){ return String(num).padStart(len,"0"); }

  function sortSongsForDisplay(songs){
    // sort by Artist Aâ€“Z, then Song Title Aâ€“Z
    return [...songs].sort((a,b)=>{
      const aa = keyify(a.artist), bb = keyify(b.artist);
      if(aa < bb) return -1;
      if(aa > bb) return 1;
      const at = keyify(a.title), bt = keyify(b.title);
      return at.localeCompare(bt);
    });
  }

  function uniqueSorted(arr){
    return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>keyify(a).localeCompare(keyify(b)));
  }

  function setSelectOptions(selectEl, options, includeAll){
    const cur = selectEl.value;
    selectEl.innerHTML = "";
    if(includeAll){
      const opt = document.createElement("option");
      opt.value = "all";
      opt.textContent = "All";
      selectEl.appendChild(opt);
    }
    for(const item of options){
      const opt = document.createElement("option");
      opt.value = item;
      opt.textContent = item;
      selectEl.appendChild(opt);
    }
    // keep previous if possible
    if([...selectEl.options].some(o=>o.value===cur)) selectEl.value = cur;
  }

  function rebuildPickers(){
    const v = state.vocab;

    setSelectOptions(genreSelect, v.genres, false);
    setSelectOptions(moodSelect, v.moods, false);
    setSelectOptions(countrySelect, v.countries, false);

    // filters
    setSelectOptions(genreFilter, v.genres, true);
    setSelectOptions(moodFilter, v.moods, true);
    setSelectOptions(countryFilter, v.countries, true);

    // load filter prefs (if any)
    if(prefs.genreFilter && [...genreFilter.options].some(o=>o.value===prefs.genreFilter)) genreFilter.value = prefs.genreFilter;
    if(prefs.moodFilter && [...moodFilter.options].some(o=>o.value===prefs.moodFilter)) moodFilter.value = prefs.moodFilter;
    if(prefs.countryFilter && [...countryFilter.options].some(o=>o.value===prefs.countryFilter)) countryFilter.value = prefs.countryFilter;
    if(prefs.favFilter && [...favFilter.options].some(o=>o.value===prefs.favFilter)) favFilter.value = prefs.favFilter;
    if(typeof prefs.search === "string") searchEl.value = prefs.search;
  }

  function addToVocab(type, value){
    const val = norm(value);
    if(!val) return;
    const list = state.vocab[type];
    const exists = list.some(x=>keyify(x)===keyify(val));
    if(!exists){
      list.push(val);
      state.vocab = mergeVocab(state.vocab, state.vocab);
      saveState();
      rebuildPickers();
    }
  }

  function updateSuggestions(){
    const artists = uniqueSorted(state.songs.map(s=>s.artist));
    const titles  = uniqueSorted(state.songs.map(s=>s.title));

    artistSuggestions.innerHTML = artists.map(a=>`<option value="${escapeHtml(a)}"></option>`).join("");
    titleSuggestions.innerHTML  = titles.map(t=>`<option value="${escapeHtml(t)}"></option>`).join("");
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  // -------------------------
  // Numbering (ONLY 2)
  // Artist numbering: A1, A2.. alphabetically
  // Song numbering: S00001.. in display order
  // -------------------------
  function computeNumbering(displaySongs){
    const artists = uniqueSorted(displaySongs.map(s=>s.artist));
    const artistIndex = new Map();
    artists.forEach((name, i)=>artistIndex.set(keyify(name), i+1));

    // Song index in display order
    const songIndex = new Map();
    displaySongs.forEach((s, i)=>songIndex.set(s.id, i+1));

    return { artistIndex, songIndex };
  }

  // -------------------------
  // Filtering
  // -------------------------
  function getFilteredSongs(){
    const q = keyify(searchEl.value);
    const g = genreFilter.value;
    const m = moodFilter.value;
    const c = countryFilter.value;
    const f = favFilter.value;

    let songs = sortSongsForDisplay(state.songs);

    if(q){
      songs = songs.filter(s=>{
        const hay = `${s.title} ${s.artist}`.toLowerCase();
        return hay.includes(q);
      });
    }
    if(g !== "all") songs = songs.filter(s=> (s.genre||"") === g);
    if(m !== "all") songs = songs.filter(s=> (s.mood||"") === m);
    if(c !== "all") songs = songs.filter(s=> (s.country||"") === c);

    if(f !== "all"){
      if(f === "fav") songs = songs.filter(s=>s.fav==="fav");
      if(f === "xfav") songs = songs.filter(s=>s.fav==="xfav");
      if(f === "anyfav") songs = songs.filter(s=>s.fav==="fav" || s.fav==="xfav");
      if(f === "none") songs = songs.filter(s=>!s.fav || s.fav==="none");
    }

    // persist prefs
    prefs.search = searchEl.value || "";
    prefs.genreFilter = g;
    prefs.moodFilter = m;
    prefs.countryFilter = c;
    prefs.favFilter = f;
    savePrefs();

    return songs;
  }

  // -------------------------
  // Charts (compact, top 8)
  // -------------------------
  function buildChart(el, counts, maxItems=8){
    el.innerHTML = "";
    const entries = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,maxItems);
    const max = entries.length ? entries[0][1] : 1;

    for(const [label, value] of entries){
      const row = document.createElement("div");
      row.className = "barRow";
      row.innerHTML = `
        <div class="barLabel">${escapeHtml(label)}</div>
        <div class="barTrack"><div class="barFill" style="width:${Math.round((value/max)*100)}%"></div></div>
        <div class="barValue">${value}</div>
      `;
      el.appendChild(row);
    }
    if(!entries.length){
      const empty = document.createElement("div");
      empty.className = "smallNote";
      empty.textContent = "No data yet.";
      el.appendChild(empty);
    }
  }

  function renderCharts(displaySongs){
    const genreCounts = {};
    const moodCounts = {};
    for(const s of displaySongs){
      const g = s.genre || "Other";
      const m = s.mood  || "Other";
      genreCounts[g] = (genreCounts[g]||0)+1;
      moodCounts[m]  = (moodCounts[m]||0)+1;
    }
    buildChart(genreChart, genreCounts, 10);
    buildChart(moodChart, moodCounts, 10);
  }

  // -------------------------
  // Render list (compact)
  // -------------------------
  function render(){
    const displaySongs = getFilteredSongs();
    const { artistIndex, songIndex } = computeNumbering(displaySongs);

    // stats
    const artistCount = uniqueSorted(displaySongs.map(s=>s.artist)).length;
    countPill.textContent = `Songs: ${displaySongs.length} â€¢ Artists: ${artistCount}`;
    statsPill.textContent = `${displaySongs.length} songs â€¢ ${artistCount} artists`;

    // filters meta
    const active =
      (searchEl.value.trim() ? 1:0) +
      (genreFilter.value!=="all" ? 1:0) +
      (moodFilter.value!=="all" ? 1:0) +
      (countryFilter.value!=="all" ? 1:0) +
      (favFilter.value!=="all" ? 1:0);
    filterMeta.textContent = active ? `${active} active` : "Collapsed";

    // group by artist
    const groups = new Map();
    for(const s of displaySongs){
      const k = s.artist || "Unknown";
      if(!groups.has(k)) groups.set(k, []);
      groups.get(k).push(s);
    }
    const artistNames = uniqueSorted([...groups.keys()]);

    listEl.innerHTML = "";
    for(const artistName of artistNames){
      const songs = groups.get(artistName) || [];
      const aNum = artistIndex.get(keyify(artistName)) || 0;

      const block = document.createElement("div");
      block.className = "artistBlock";

      const header = document.createElement("div");
      header.className = "artistHeader";

      header.innerHTML = `
        <div class="artistLeft">
          <div class="badge mono">#A${aNum}</div>
          <div style="min-width:0">
            <div class="artistName">${escapeHtml(artistName)}</div>
            <div class="artistMeta">${songs.length} song(s)</div>
          </div>
        </div>
      `;

      const songsEl = document.createElement("div");
      songsEl.className = "songs";

      for(const s of songs){
        const sNum = songIndex.get(s.id) || 0;
        const songRow = document.createElement("div");
        songRow.className = "songRow";

        const favChip =
          s.fav === "fav"  ? `<span class="chip fav">â˜… Fav</span>` :
          s.fav === "xfav" ? `<span class="chip xfav">â˜…â˜… X-Fav</span>` : "";

        // compact chips: genre, mood, country in ONE ROW (wrap)
        const chips = `
          <div class="chipsRow">
            ${s.genre ? `<span class="chip">${escapeHtml(s.genre)}</span>` : `<span class="chip muted">No genre</span>`}
            ${s.mood ? `<span class="chip">${escapeHtml(s.mood)}</span>` : `<span class="chip muted">No mood</span>`}
            ${s.country ? `<span class="chip">${escapeHtml(s.country)}</span>` : `<span class="chip muted">No country</span>`}
            ${favChip}
          </div>
        `;

        songRow.innerHTML = `
          <div class="songMain">
            <div class="songTop">
              <div class="songTitleLine">
                <p class="songTitle">${escapeHtml(s.title)}</p>
                <div class="songIds">
                  <span class="idchip mono">#S${pad(sNum,5)}</span>
                </div>
              </div>
              <div class="songActions">
                <button class="iconBtn" title="Edit" data-act="edit" data-id="${s.id}">âœŽ</button>
                <button class="iconBtn" title="Delete" data-act="del" data-id="${s.id}">ðŸ—‘</button>
              </div>
            </div>
            ${chips}
          </div>
        `;
        songsEl.appendChild(songRow);
      }

      block.appendChild(header);
      block.appendChild(songsEl);
      listEl.appendChild(block);
    }

    renderCharts(displaySongs);
    updateSuggestions();
  }

  // -------------------------
  // Add/Edit
  // -------------------------
  let editingId = null;

  function resetForm(){
    editingId = null;
    songTitleEl.value = "";
    artistNameEl.value = "";
    genreSelect.value = state.vocab.genres[0] || "Other";
    moodSelect.value = state.vocab.moods[0] || "Other";
    countrySelect.value = state.vocab.countries[0] || "Other";
    favSelect.value = "none";
    deleteBtn.classList.add("hidden");
    editHint.textContent = "";
  }

  function openAddForm(){
    addCard.classList.remove("hidden");
    toggleAddBtn.textContent = "Add new song";
    songTitleEl.focus();
  }

  function closeAddForm(){
    addCard.classList.add("hidden");
    resetForm();
  }

  function upsertSong(){
    const title = norm(songTitleEl.value);
    const artist = norm(artistNameEl.value);
    if(!title || !artist){
      alert("Please enter both Song Title and Artist.");
      return;
    }

    const songObj = {
      id: editingId || crypto.randomUUID(),
      title,
      artist,
      genre: genreSelect.value || "",
      mood: moodSelect.value || "",
      country: countrySelect.value || "",
      fav: favSelect.value || "none"
    };

    if(editingId){
      const idx = state.songs.findIndex(s=>s.id===editingId);
      if(idx >= 0) state.songs[idx] = songObj;
    }else{
      state.songs.push(songObj);
    }
    saveState();
    render();
    resetForm();
    // keep the form open for fast entry
    songTitleEl.focus();
  }

  function startEdit(id){
    const s = state.songs.find(x=>x.id===id);
    if(!s) return;
    editingId = id;

    songTitleEl.value = s.title || "";
    artistNameEl.value = s.artist || "";
    if(s.genre && [...genreSelect.options].some(o=>o.value===s.genre)) genreSelect.value = s.genre;
    if(s.mood && [...moodSelect.options].some(o=>o.value===s.mood)) moodSelect.value = s.mood;
    if(s.country && [...countrySelect.options].some(o=>o.value===s.country)) countrySelect.value = s.country;
    favSelect.value = s.fav || "none";

    deleteBtn.classList.remove("hidden");
    editHint.textContent = `Editing: ${s.artist} â€” ${s.title}`;
    openAddForm();
  }

  function deleteSong(id){
    if(!confirm("Delete this song?")) return;
    state.songs = state.songs.filter(s=>s.id!==id);
    saveState();
    render();
    resetForm();
  }

  // -------------------------
  // Export / Import
  // -------------------------
  function exportData(){
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "my-songs-export.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function importDataFromFile(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const imported = JSON.parse(reader.result);
        if(!imported || !Array.isArray(imported.songs)){
          alert("Invalid file (missing songs array).");
          return;
        }
        // merge + keep vocab
        const merged = {
          songs: imported.songs.map(s=>({
            id: s.id || crypto.randomUUID(),
            title: norm(s.title),
            artist: norm(s.artist),
            genre: s.genre || "",
            mood: s.mood || "",
            country: s.country || "",
            fav: s.fav || "none"
          })).filter(s=>s.title && s.artist),
          vocab: mergeVocab(defaultVocab(), imported.vocab || state.vocab || defaultVocab())
        };
        state = merged;
        saveState();
        rebuildPickers();
        render();
        alert("Import complete âœ…");
      }catch(e){
        alert("Could not import this file.");
      }
    };
    reader.readAsText(file);
  }

  // -------------------------
  // Events
  // -------------------------
  toggleAddBtn.addEventListener("click", ()=>{
    if(addCard.classList.contains("hidden")){
      openAddForm();
    }else{
      closeAddForm();
    }
  });
  closeAddBtn.addEventListener("click", closeAddForm);

  saveBtn.addEventListener("click", upsertSong);
  resetBtn.addEventListener("click", resetForm);
  deleteBtn.addEventListener("click", ()=>{
    if(editingId) deleteSong(editingId);
  });

  addGenreBtn.addEventListener("click", ()=>{
    addToVocab("genres", newGenreEl.value);
    newGenreEl.value = "";
  });
  addMoodBtn.addEventListener("click", ()=>{
    addToVocab("moods", newMoodEl.value);
    newMoodEl.value = "";
  });
  addCountryBtn.addEventListener("click", ()=>{
    addToVocab("countries", newCountryEl.value);
    newCountryEl.value = "";
  });

  // filters
  const rerender = ()=>render();
  searchEl.addEventListener("input", rerender);
  genreFilter.addEventListener("change", rerender);
  moodFilter.addEventListener("change", rerender);
  countryFilter.addEventListener("change", rerender);
  favFilter.addEventListener("change", rerender);

  clearFiltersBtn.addEventListener("click", ()=>{
    searchEl.value = "";
    genreFilter.value = "all";
    moodFilter.value = "all";
    countryFilter.value = "all";
    favFilter.value = "all";
    prefs = {};
    savePrefs();
    render();
  });

  // list actions
  listEl.addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const act = btn.dataset.act;
    const id  = btn.dataset.id;
    if(act === "edit") startEdit(id);
    if(act === "del") deleteSong(id);
  });

  exportBtn.addEventListener("click", exportData);
  importBtn.addEventListener("click", ()=>importFile.click());
  importFile.addEventListener("change", ()=>{
    const file = importFile.files && importFile.files[0];
    if(file) importDataFromFile(file);
    importFile.value = "";
  });

  // -------------------------
  // Init
  // -------------------------
  rebuildPickers();
  resetForm();

  // Optional: keep filters collapsed always on load
  filtersCard.open = false;
  document.getElementById("chartsCard").open = false;

  // Example starter data if empty (you can delete later)
  if(state.songs.length === 0){
    state.songs = [
      {id:crypto.randomUUID(), title:"Giant Steps", artist:"John Coltrane", genre:"Jazz", mood:"Energized", country:"USA", fav:"none"},
      {id:crypto.randomUUID(), title:"Bohemian Rhapsody", artist:"Queen", genre:"Rock", mood:"Energized", country:"UK", fav:"fav"},
      {id:crypto.randomUUID(), title:"Blinding Lights", artist:"The Weeknd", genre:"Pop", mood:"Energized", country:"Canada", fav:"xfav"}
    ];
    // Add Canada to countries automatically
    addToVocab("countries","Canada");
    saveState();
  }

  render();
</script>
</body>
</html>

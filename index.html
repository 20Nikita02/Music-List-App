<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Song Library</title>
  <style>
    :root{
      --bg0:#0b0f1a;
      --bg1:#10162a;
      --card:rgba(20, 26, 44, 0.72);
      --card2:rgba(25, 33, 54, 0.65);
      --stroke:rgba(255,255,255,0.08);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.65);
      --muted2:rgba(255,255,255,0.45);
      --chip:rgba(255,255,255,0.08);
      --chip2:rgba(255,255,255,0.11);
      --shadow: 0 18px 40px rgba(0,0,0,0.45);
      --r:18px;
      --r2:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: radial-gradient(1200px 700px at 20% 0%, rgba(102, 78, 255, .22), transparent 60%),
                  radial-gradient(900px 600px at 80% 10%, rgba(90, 200, 250, .12), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    .wrap{
      max-width: 860px;
      margin: 0 auto;
      padding: 18px 14px 120px;
    }
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }
    .title{
      display:flex; gap:10px; align-items:center;
    }
    .title .icon{
      width:40px;height:40px;border-radius:14px;
      display:grid;place-items:center;
      background: rgba(255,255,255,0.06);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    h1{font-size:20px;margin:0}
    .subtitle{font-size:12px;color:var(--muted); margin-top:2px}
    .pillrow{
      display:flex; gap:8px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }
    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .stack{display:flex; flex-direction:column; gap:12px;}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap;}
    button{
      appearance:none;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 11px 14px;
      border-radius: 14px;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,0.20);
    }
    button:active{transform: translateY(1px)}
    button.primary{
      background: linear-gradient(180deg, rgba(124, 110, 255, .35), rgba(124, 110, 255, .18));
      border-color: rgba(160, 150, 255, .30);
    }
    button.ghost{
      background: rgba(255,255,255,0.04);
    }
    .smallnote{color:var(--muted2);font-size:12px;line-height:1.35}
    details{
      border-radius: var(--r);
      overflow:hidden;
    }
    details > summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      border-radius: var(--r);
    }
    details[open] > summary{
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }
    details > summary::-webkit-details-marker{display:none}
    .summaryTitle{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
    }
    .summaryRight{color:var(--muted);font-size:12px}
    .detailsBody{
      padding: 14px;
      border:1px solid var(--stroke);
      border-top:none;
      border-bottom-left-radius: var(--r);
      border-bottom-right-radius: var(--r);
      background: rgba(255,255,255,0.03);
    }

    /* form */
    .formgrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 2px}
    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      outline:none;
      background: rgba(0,0,0,0.18);
      color: var(--text);
      font-size: 15px;
    }
    select{
      background: rgba(0,0,0,0.22);
    }
    input::placeholder{color: rgba(255,255,255,0.35)}
    .row2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;}
    .inlineAdd{
      display:flex; gap:10px; align-items:center;
    }
    .inlineAdd input{flex:1}
    .inlineAdd button{padding: 10px 12px; border-radius: 12px; font-size: 13px;}
    .seg{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 6px;
    }
    .toggle{
      display:flex; align-items:center; gap:10px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.04);
    }
    .toggle input{width:18px;height:18px;margin:0}
    .toggle span{font-weight:700}
    .toggle small{display:block;color:var(--muted);font-weight:600}

    /* list */
    .listHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      margin-bottom: 8px;
    }
    .search{
      flex:1;
      min-width: 180px;
      max-width: 420px;
    }
    .metaLine{
      display:flex; gap:8px; flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
    }
    .artistCard{
      background: var(--card2);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      padding: 12px;
    }
    .artistTop{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom: 8px;
    }
    .artistLeft{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      font-weight: 900;
      font-size: 12px;
      flex: 0 0 auto;
    }
    .artistName{
      font-weight: 900;
      font-size: 18px;
      line-height: 1.15;
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    .artistSub{color:var(--muted); font-size:12px; margin-top:2px}
    .artistRight{color:var(--muted);font-size:12px; white-space:nowrap}

    .songRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.18);
      margin-top: 10px;
    }
    .songMain{
      min-width: 0;
      flex:1;
    }
    .songTitleLine{
      display:flex;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .songNo{
      font-weight:900;
      font-size: 12px;
      color: rgba(255,255,255,0.75);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      flex: 0 0 auto;
    }
    .songTitle{
      font-weight:900;
      font-size: 16px;
      line-height: 1.2;
      word-break: break-word;
      overflow-wrap: anywhere;
      min-width: 0;
      flex: 1;
    }
    .chips{
      display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px;
    }
    .chip{
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      background: var(--chip);
      border: 1px solid rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.82);
      font-weight: 700;
    }
    .chip.fav{
      background: rgba(80, 200, 120, 0.14);
      border-color: rgba(80, 200, 120, 0.20);
    }
    .chip.xfav{
      background: rgba(255, 200, 90, 0.16);
      border-color: rgba(255, 200, 90, 0.22);
    }
    .actions{
      display:flex; gap:8px; flex:0 0 auto;
    }
    .iconbtn{
      width: 44px; height: 44px;
      display:grid; place-items:center;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.09);
      background: rgba(255,255,255,0.05);
      cursor:pointer;
    }
    .iconbtn:active{transform: translateY(1px)}
    .muted{color:var(--muted)}
    canvas{width:100%; height:200px; display:block;}
    .chartBox{padding-top:10px}
    .chartHelp{font-size:12px;color:var(--muted);margin-top:8px}

    @media (min-width: 740px){
      .formgrid{grid-template-columns: 1fr 1fr;}
      .span2{grid-column: 1 / -1;}
      .row2{grid-template-columns: 1fr 1fr;}
      .row3{grid-template-columns: 1fr 1fr 1fr;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <div class="icon">ðŸŽµ</div>
        <div>
          <h1>All Songs</h1>
          <div class="subtitle">Vertical-only browsing â€¢ Artist Aâ€“Z â†’ Song Aâ€“Z â€¢ Local save + Export/Import</div>
        </div>
      </div>
      <div class="pillrow">
        <div class="pill" id="pillSongs">Songs: 0</div>
        <div class="pill" id="pillArtists">Artists: 0</div>
      </div>
    </div>

    <div class="stack">
      <!-- Controls -->
      <div class="card">
        <div class="btnrow">
          <button class="primary" id="btnShowForm">Add new song</button>
          <button class="ghost" id="btnExport">Export (.json)</button>
          <button class="ghost" id="btnImport">Import (.json)</button>
          <input type="file" id="importFile" accept="application/json" style="display:none" />
        </div>
        <div style="height:10px"></div>
        <div class="smallnote">
          Data saves automatically on this device (localStorage). Use Export/Import to move data to another device (GitHub hosts the page, but your data stays local unless you export/import).
        </div>
      </div>

      <!-- Add form (hidden by default) -->
      <div class="card" id="formCard" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;">
          <div style="font-weight:900;">Add / Edit Song</div>
          <button class="ghost" id="btnCloseForm" type="button">Close</button>
        </div>

        <form id="songForm">
          <div class="formgrid">
            <div class="span2">
              <label>Song title</label>
              <input id="songTitle" placeholder="e.g. Blinding Lights" list="songTitleList" required />
              <datalist id="songTitleList"></datalist>
            </div>

            <div class="span2">
              <label>Artist</label>
              <input id="artistName" placeholder="e.g. The Weeknd" list="artistList" required />
              <datalist id="artistList"></datalist>
            </div>

            <div>
              <label>Genre</label>
              <select id="genreSelect"></select>
              <div class="inlineAdd" style="margin-top:8px;">
                <input id="genreNew" placeholder="Add new genreâ€¦" />
                <button type="button" id="btnAddGenre">Add</button>
              </div>
            </div>

            <div>
              <label>Mood</label>
              <select id="moodSelect"></select>
              <div class="inlineAdd" style="margin-top:8px;">
                <input id="moodNew" placeholder="Add new moodâ€¦" />
                <button type="button" id="btnAddMood">Add</button>
              </div>
            </div>

            <div>
              <label>Country</label>
              <select id="countrySelect"></select>
              <div class="inlineAdd" style="margin-top:8px;">
                <input id="countryNew" placeholder="Add new countryâ€¦" />
                <button type="button" id="btnAddCountry">Add</button>
              </div>
            </div>

            <div>
              <label>Favorite</label>
              <select id="favSelect">
                <option value="none">None</option>
                <option value="fav">â˜… Fav</option>
                <option value="xfav">â˜…â˜… X-Fav</option>
              </select>
            </div>

            <div class="span2 btnrow" style="margin-top:4px;">
              <button class="primary" type="submit" id="btnSave">Save</button>
              <button class="ghost" type="button" id="btnClearForm">Clear</button>
            </div>
          </div>
          <input type="hidden" id="editingId" value="" />
        </form>
      </div>

      <!-- Filters (collapsed by default) -->
      <details class="filterBox">
        <summary>
          <div class="summaryTitle">ðŸ§° Filters</div>
          <div class="summaryRight">Collapsed</div>
        </summary>
        <div class="detailsBody">
          <div class="formgrid">
            <div class="span2">
              <label>Search (artist or song)</label>
              <input id="searchInput" class="search" placeholder="Type to searchâ€¦" />
            </div>

            <div>
              <label>Genre</label>
              <select id="filterGenre"></select>
            </div>

            <div>
              <label>Mood</label>
              <select id="filterMood"></select>
            </div>

            <div>
              <label>Country</label>
              <select id="filterCountry"></select>
            </div>

            <div>
              <label>Favorite</label>
              <select id="filterFav">
                <option value="all">All</option>
                <option value="fav">â˜… Fav</option>
                <option value="xfav">â˜…â˜… X-Fav</option>
                <option value="none">None</option>
              </select>
            </div>

            <div class="span2 btnrow" style="margin-top:4px;">
              <button class="primary" type="button" id="btnApplyFilters">Apply</button>
              <button class="ghost" type="button" id="btnResetFilters">Reset</button>
            </div>
          </div>
        </div>
      </details>

      <!-- Charts (collapsed by default) -->
      <details class="chartCard">
        <summary>
          <div class="summaryTitle">ðŸ“Š Genre chart</div>
          <div class="summaryRight">Collapsed</div>
        </summary>
        <div class="detailsBody">
          <div class="chartBox">
            <canvas id="genreChart" width="800" height="220"></canvas>
            <div class="chartHelp">Shows your genre distribution (based on current filtered view).</div>
          </div>
        </div>
      </details>

      <!-- List -->
      <div class="card">
        <div class="listHeader">
          <div class="metaLine" id="sortLine">Sort: Artist Aâ€“Z â†’ Song Aâ€“Z</div>
          <div class="metaLine" id="shownLine">0 shown</div>
        </div>
        <div id="list"></div>
      </div>
    </div>
  </div>

<script>
/** ---------------------------
 * Storage
 * -------------------------- */
const STORAGE_KEY = "song_library_v3";

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/** ---------------------------
 * Defaults
 * -------------------------- */
const DEFAULT_GENRES = [
  "Pop","Hip-Hop","R&B","Rock","Hard Rock","Metal Rock","Jazz","Classical","Electronic",
  "K-pop","Country","Gospel","French","Instrumental","Indie","Other"
];
const DEFAULT_MOODS = ["Happy","Sad","Energized","Calm","Instrumental","Chill","Focus","Other"];
const DEFAULT_COUNTRIES = ["Unknown","USA","UK","Canada","France","Germany","Korea","Japan","Netherlands","Other"];

/** ---------------------------
 * State
 * -------------------------- */
let state = loadState() || {
  songs: [], // {id, title, artist, genre, mood, country, fav}
  genres: DEFAULT_GENRES.slice(),
  moods: DEFAULT_MOODS.slice(),
  countries: DEFAULT_COUNTRIES.slice(),
  filters: { q:"", genre:"all", mood:"all", country:"all", fav:"all" }
};

function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

/** ---------------------------
 * Elements
 * -------------------------- */
const pillSongs = document.getElementById("pillSongs");
const pillArtists = document.getElementById("pillArtists");
const shownLine = document.getElementById("shownLine");

const listEl = document.getElementById("list");

const formCard = document.getElementById("formCard");
const btnShowForm = document.getElementById("btnShowForm");
const btnCloseForm = document.getElementById("btnCloseForm");
const btnClearForm = document.getElementById("btnClearForm");
const songForm = document.getElementById("songForm");

const editingId = document.getElementById("editingId");
const songTitle = document.getElementById("songTitle");
const artistName = document.getElementById("artistName");
const favSelect = document.getElementById("favSelect");

const genreSelect = document.getElementById("genreSelect");
const moodSelect = document.getElementById("moodSelect");
const countrySelect = document.getElementById("countrySelect");

const genreNew = document.getElementById("genreNew");
const moodNew = document.getElementById("moodNew");
const countryNew = document.getElementById("countryNew");
const btnAddGenre = document.getElementById("btnAddGenre");
const btnAddMood = document.getElementById("btnAddMood");
const btnAddCountry = document.getElementById("btnAddCountry");

const searchInput = document.getElementById("searchInput");
const filterGenre = document.getElementById("filterGenre");
const filterMood = document.getElementById("filterMood");
const filterCountry = document.getElementById("filterCountry");
const filterFav = document.getElementById("filterFav");
const btnApplyFilters = document.getElementById("btnApplyFilters");
const btnResetFilters = document.getElementById("btnResetFilters");

const btnExport = document.getElementById("btnExport");
const btnImport = document.getElementById("btnImport");
const importFile = document.getElementById("importFile");

const artistList = document.getElementById("artistList");
const songTitleList = document.getElementById("songTitleList");

const genreChartCanvas = document.getElementById("genreChart");
const ctx = genreChartCanvas.getContext("2d");

/** ---------------------------
 * Helpers
 * -------------------------- */
function norm(s){ return (s||"").trim(); }
function key(s){ return norm(s).toLowerCase(); }

function compareAZ(a,b){
  return key(a).localeCompare(key(b), undefined, {numeric:true, sensitivity:"base"});
}

function sortSongs(songs){
  return songs.slice().sort((a,b)=>{
    const aa = compareAZ(a.artist, b.artist);
    if(aa !== 0) return aa;
    return compareAZ(a.title, b.title);
  });
}

function uniqueArtistsFromSongs(songs){
  const set = new Map();
  for(const s of songs){
    const k = key(s.artist);
    if(!set.has(k)) set.set(k, norm(s.artist));
  }
  return Array.from(set.values()).sort(compareAZ);
}

function setSelectOptions(selectEl, list, includeAll){
  const value = selectEl.value;
  selectEl.innerHTML = "";

  if(includeAll){
    const optAll = document.createElement("option");
    optAll.value = "all";
    optAll.textContent = "All";
    selectEl.appendChild(optAll);
  }

  for(const item of list){
    const opt = document.createElement("option");
    opt.value = item;
    opt.textContent = item;
    selectEl.appendChild(opt);
  }

  // restore if possible
  if(value && Array.from(selectEl.options).some(o=>o.value===value)){
    selectEl.value = value;
  }
}

function refreshDatalists(){
  const artists = uniqueArtistsFromSongs(state.songs);
  artistList.innerHTML = artists.map(a=>`<option value="${escapeHtml(a)}"></option>`).join("");

  const titlesSet = new Map();
  for(const s of state.songs){
    const k = key(s.title);
    if(!titlesSet.has(k)) titlesSet.set(k, norm(s.title));
  }
  const titles = Array.from(titlesSet.values()).sort(compareAZ);
  songTitleList.innerHTML = titles.map(t=>`<option value="${escapeHtml(t)}"></option>`).join("");
}

function escapeHtml(str){
  return (str||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}

/** ---------------------------
 * Filters & view
 * -------------------------- */
function applyFiltersToSongs(){
  const f = state.filters;
  const q = key(f.q);

  return state.songs.filter(s=>{
    if(q){
      const hay = (key(s.artist) + " " + key(s.title));
      if(!hay.includes(q)) return false;
    }
    if(f.genre !== "all" && norm(s.genre) !== f.genre) return false;
    if(f.mood !== "all" && norm(s.mood) !== f.mood) return false;
    if(f.country !== "all" && norm(s.country) !== f.country) return false;
    if(f.fav !== "all"){
      if(f.fav === "none" && (s.fav !== "none")) return false;
      if(f.fav !== "none" && s.fav !== f.fav) return false;
    }
    return true;
  });
}

/** ---------------------------
 * Rendering
 * -------------------------- */
function render(){
  // ensure selects options
  setSelectOptions(genreSelect, state.genres, false);
  setSelectOptions(moodSelect, state.moods, false);
  setSelectOptions(countrySelect, state.countries, false);

  setSelectOptions(filterGenre, state.genres, true);
  setSelectOptions(filterMood, state.moods, true);
  setSelectOptions(filterCountry, state.countries, true);

  // totals
  const artistsAll = uniqueArtistsFromSongs(state.songs);
  pillSongs.textContent = `Songs: ${state.songs.length}`;
  pillArtists.textContent = `Artists: ${artistsAll.length}`;

  // filtered
  const filtered = sortSongs(applyFiltersToSongs());
  shownLine.textContent = `${filtered.length} shown`;

  // numbering:
  // - artist numbers based on filtered *artist list* in Aâ€“Z
  // - song numbers based on filtered sorted list 1..N
  const artistsFiltered = uniqueArtistsFromSongs(filtered);
  const artistIndex = new Map();
  artistsFiltered.forEach((a, i)=> artistIndex.set(key(a), i+1));

  // group songs by artist
  const byArtist = new Map();
  for(const s of filtered){
    const k = key(s.artist);
    if(!byArtist.has(k)) byArtist.set(k, {artist: norm(s.artist), songs: []});
    byArtist.get(k).songs.push(s);
  }

  // render list
  listEl.innerHTML = "";
  let songCounter = 0;

  for(const artistNameReal of artistsFiltered){
    const k = key(artistNameReal);
    const group = byArtist.get(k);
    if(!group) continue;

    const artistNo = artistIndex.get(k) || 0;

    const artistCard = document.createElement("div");
    artistCard.className = "artistCard";

    const top = document.createElement("div");
    top.className = "artistTop";

    const left = document.createElement("div");
    left.className = "artistLeft";

    const badge = document.createElement("div");
    badge.className = "badge";
    badge.textContent = `A${artistNo}`;

    const nameWrap = document.createElement("div");
    nameWrap.style.minWidth = "0";

    const name = document.createElement("div");
    name.className = "artistName";
    name.textContent = group.artist;

    const sub = document.createElement("div");
    sub.className = "artistSub";
    sub.textContent = `${group.songs.length} song(s)`;

    nameWrap.appendChild(name);
    nameWrap.appendChild(sub);

    left.appendChild(badge);
    left.appendChild(nameWrap);

    const right = document.createElement("div");
    right.className = "artistRight";
    right.textContent = "";

    top.appendChild(left);
    top.appendChild(right);

    artistCard.appendChild(top);

    // songs in this artist already sorted by title due to global sort, but ensure:
    const songsSorted = group.songs.slice().sort((a,b)=>compareAZ(a.title,b.title));

    for(const s of songsSorted){
      songCounter += 1;

      const row = document.createElement("div");
      row.className = "songRow";

      const main = document.createElement("div");
      main.className = "songMain";

      const titleLine = document.createElement("div");
      titleLine.className = "songTitleLine";

      const no = document.createElement("div");
      no.className = "songNo";
      no.textContent = `S${songCounter}`;

      const t = document.createElement("div");
      t.className = "songTitle";
      t.textContent = s.title;

      titleLine.appendChild(no);
      titleLine.appendChild(t);

      const chips = document.createElement("div");
      chips.className = "chips";

      // compact side-by-side chips
      if(s.genre) chips.appendChild(makeChip(s.genre));
      if(s.mood) chips.appendChild(makeChip(s.mood));
      if(s.country) chips.appendChild(makeChip(s.country));

      if(s.fav === "fav") chips.appendChild(makeChip("â˜… Fav", "fav"));
      if(s.fav === "xfav") chips.appendChild(makeChip("â˜…â˜… X-Fav", "xfav"));

      main.appendChild(titleLine);
      main.appendChild(chips);

      const actions = document.createElement("div");
      actions.className = "actions";

      const editBtn = document.createElement("button");
      editBtn.className = "iconbtn";
      editBtn.type = "button";
      editBtn.title = "Edit";
      editBtn.innerHTML = "âœï¸";
      editBtn.addEventListener("click", ()=>startEdit(s.id));

      const delBtn = document.createElement("button");
      delBtn.className = "iconbtn";
      delBtn.type = "button";
      delBtn.title = "Delete";
      delBtn.innerHTML = "ðŸ—‘ï¸";
      delBtn.addEventListener("click", ()=>deleteSong(s.id));

      actions.appendChild(editBtn);
      actions.appendChild(delBtn);

      row.appendChild(main);
      row.appendChild(actions);

      artistCard.appendChild(row);
    }

    listEl.appendChild(artistCard);
  }

  refreshDatalists();
  drawGenreChart(filtered);
  saveState();
}

function makeChip(text, type){
  const c = document.createElement("div");
  c.className = "chip" + (type ? ` ${type}` : "");
  c.textContent = text;
  return c;
}

/** ---------------------------
 * Chart (Genre only)
 * -------------------------- */
function drawGenreChart(songs){
  // count genres
  const counts = new Map();
  for(const s of songs){
    const g = norm(s.genre) || "Unknown";
    counts.set(g, (counts.get(g)||0) + 1);
  }
  // sort by count desc
  const entries = Array.from(counts.entries()).sort((a,b)=>b[1]-a[1]).slice(0, 10);

  // clear
  ctx.clearRect(0,0,genreChartCanvas.width,genreChartCanvas.height);

  const W = genreChartCanvas.width;
  const H = genreChartCanvas.height;
  const pad = 24;
  const barH = 16;
  const gap = 10;

  // background subtle
  ctx.fillStyle = "rgba(255,255,255,0.03)";
  ctx.fillRect(0,0,W,H);

  if(entries.length === 0){
    ctx.fillStyle = "rgba(255,255,255,0.7)";
    ctx.font = "700 16px system-ui";
    ctx.fillText("No data yet", pad, H/2);
    return;
  }

  const max = Math.max(...entries.map(e=>e[1]));
  const startY = pad;
  ctx.font = "700 12px system-ui";
  ctx.fillStyle = "rgba(255,255,255,0.75)";

  entries.forEach((e, i)=>{
    const [label, val] = e;
    const y = startY + i*(barH+gap);
    const barW = Math.max(4, Math.round((W - pad*2 - 120) * (val / max)));

    // label
    ctx.fillStyle = "rgba(255,255,255,0.72)";
    ctx.fillText(label, pad, y + 13);

    // bar
    const bx = pad + 120;
    ctx.fillStyle = "rgba(124, 110, 255, 0.55)";
    ctx.fillRect(bx, y, barW, barH);

    // value
    ctx.fillStyle = "rgba(255,255,255,0.75)";
    ctx.fillText(String(val), bx + barW + 10, y + 13);
  });
}

/** ---------------------------
 * Form show/hide
 * -------------------------- */
function showForm(){
  formCard.style.display = "block";
  // scroll to form nicely on mobile
  formCard.scrollIntoView({behavior:"smooth", block:"start"});
}
function hideForm(){
  formCard.style.display = "none";
  clearForm();
}
btnShowForm.addEventListener("click", ()=>{
  clearForm();
  showForm();
});
btnCloseForm.addEventListener("click", hideForm);

function clearForm(){
  editingId.value = "";
  songTitle.value = "";
  artistName.value = "";
  favSelect.value = "none";
  // keep current selections; but if empty, set first option
  if(!genreSelect.value) genreSelect.value = state.genres[0] || "Other";
  if(!moodSelect.value) moodSelect.value = state.moods[0] || "Other";
  if(!countrySelect.value) countrySelect.value = state.countries[0] || "Unknown";
  genreNew.value = "";
  moodNew.value = "";
  countryNew.value = "";
}
btnClearForm.addEventListener("click", clearForm);

songForm.addEventListener("submit", (e)=>{
  e.preventDefault();
  const title = norm(songTitle.value);
  const artist = norm(artistName.value);
  if(!title || !artist) return;

  const payload = {
    title,
    artist,
    genre: norm(genreSelect.value) || "",
    mood: norm(moodSelect.value) || "",
    country: norm(countrySelect.value) || "",
    fav: favSelect.value || "none"
  };

  const id = editingId.value;
  if(id){
    const idx = state.songs.findIndex(s=>s.id===id);
    if(idx >= 0){
      state.songs[idx] = {...state.songs[idx], ...payload};
    }
  }else{
    state.songs.push({id: uid(), ...payload});
  }

  render();
  hideForm(); // âœ… after Save, hide form
});

/** ---------------------------
 * CRUD
 * -------------------------- */
function startEdit(id){
  const s = state.songs.find(x=>x.id===id);
  if(!s) return;

  editingId.value = s.id;
  songTitle.value = s.title;
  artistName.value = s.artist;

  // ensure these exist
  if(s.genre && !state.genres.includes(s.genre)){ state.genres.push(s.genre); }
  if(s.mood && !state.moods.includes(s.mood)){ state.moods.push(s.mood); }
  if(s.country && !state.countries.includes(s.country)){ state.countries.push(s.country); }

  // refresh selects then set value
  setSelectOptions(genreSelect, state.genres, false);
  setSelectOptions(moodSelect, state.moods, false);
  setSelectOptions(countrySelect, state.countries, false);

  genreSelect.value = s.genre || state.genres[0] || "Other";
  moodSelect.value = s.mood || state.moods[0] || "Other";
  countrySelect.value = s.country || state.countries[0] || "Unknown";
  favSelect.value = s.fav || "none";

  showForm();
}
function deleteSong(id){
  if(!confirm("Delete this song?")) return;
  state.songs = state.songs.filter(s=>s.id!==id);
  render();
}

/** ---------------------------
 * Add new tags
 * -------------------------- */
function addToList(listName, inputEl, selectEl, filterSelectEl){
  const v = norm(inputEl.value);
  if(!v) return;

  const arr = state[listName];
  if(!arr.some(x=>key(x)===key(v))){
    arr.push(v);
    arr.sort(compareAZ);
  }
  inputEl.value = "";
  setSelectOptions(selectEl, arr, false);
  if(filterSelectEl) setSelectOptions(filterSelectEl, arr, true);
  selectEl.value = v;
  render();
}
btnAddGenre.addEventListener("click", ()=>addToList("genres", genreNew, genreSelect, filterGenre));
btnAddMood.addEventListener("click", ()=>addToList("moods", moodNew, moodSelect, filterMood));
btnAddCountry.addEventListener("click", ()=>addToList("countries", countryNew, countrySelect, filterCountry));

/** ---------------------------
 * Filters
 * -------------------------- */
btnApplyFilters.addEventListener("click", ()=>{
  state.filters.q = norm(searchInput.value);
  state.filters.genre = filterGenre.value || "all";
  state.filters.mood = filterMood.value || "all";
  state.filters.country = filterCountry.value || "all";
  state.filters.fav = filterFav.value || "all";
  render();
});
btnResetFilters.addEventListener("click", ()=>{
  state.filters = { q:"", genre:"all", mood:"all", country:"all", fav:"all" };
  searchInput.value = "";
  filterGenre.value = "all";
  filterMood.value = "all";
  filterCountry.value = "all";
  filterFav.value = "all";
  render();
});

// keep search field responsive but not spam-render too hard
let searchTimer = null;
searchInput.addEventListener("input", ()=>{
  clearTimeout(searchTimer);
  searchTimer = setTimeout(()=>{
    state.filters.q = norm(searchInput.value);
    render();
  }, 140);
});

/** ---------------------------
 * Export / Import
 * -------------------------- */
btnExport.addEventListener("click", ()=>{
  const data = {
    version: 3,
    exportedAt: new Date().toISOString(),
    songs: state.songs,
    genres: state.genres,
    moods: state.moods,
    countries: state.countries
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "song-library-export.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

btnImport.addEventListener("click", ()=> importFile.click());

importFile.addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const text = await file.text();
    const data = JSON.parse(text);

    if(!data || !Array.isArray(data.songs)){
      alert("Invalid file. Expected exported JSON with songs array.");
      return;
    }

    // merge or replace? We'll replace for simplicity
    if(!confirm("Import will replace your current data on this device. Continue?")) return;

    state.songs = data.songs.map(s=>({
      id: s.id || uid(),
      title: norm(s.title),
      artist: norm(s.artist),
      genre: norm(s.genre),
      mood: norm(s.mood),
      country: norm(s.country),
      fav: s.fav || "none"
    }));

    state.genres = Array.isArray(data.genres) ? data.genres.map(norm).filter(Boolean) : DEFAULT_GENRES.slice();
    state.moods = Array.isArray(data.moods) ? data.moods.map(norm).filter(Boolean) : DEFAULT_MOODS.slice();
    state.countries = Array.isArray(data.countries) ? data.countries.map(norm).filter(Boolean) : DEFAULT_COUNTRIES.slice();

    // sort lists
    state.genres.sort(compareAZ);
    state.moods.sort(compareAZ);
    state.countries.sort(compareAZ);

    // reset filters
    state.filters = { q:"", genre:"all", mood:"all", country:"all", fav:"all" };
    searchInput.value = "";
    filterFav.value = "all";

    render();
    alert("Imported successfully.");
  }catch(err){
    alert("Import failed: " + err.message);
  }finally{
    importFile.value = "";
  }
});

/** ---------------------------
 * Init
 * -------------------------- */
function init(){
  // set initial selects for filters + form
  setSelectOptions(genreSelect, state.genres, false);
  setSelectOptions(moodSelect, state.moods, false);
  setSelectOptions(countrySelect, state.countries, false);

  setSelectOptions(filterGenre, state.genres, true);
  setSelectOptions(filterMood, state.moods, true);
  setSelectOptions(filterCountry, state.countries, true);

  // restore filters UI
  searchInput.value = state.filters.q || "";
  filterGenre.value = state.filters.genre || "all";
  filterMood.value = state.filters.mood || "all";
  filterCountry.value = state.filters.country || "all";
  filterFav.value = state.filters.fav || "all";

  render();
}
init();
</script>
</body>
</html>

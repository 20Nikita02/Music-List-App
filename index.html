<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Songs List</title>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#11131a;
      --muted:#8b93a7;
      --text:#eef0f7;
      --line:#22263a;
      --accent:#7c5cff;
      --accent2:#2dd4bf;
      --danger:#ff4d6d;
      --ok:#27c281;
      --chip:#1a1f33;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #07080c, var(--bg));
      color:var(--text);
    }
    header{
      position:sticky; top:0;
      background: rgba(11,12,16,.85);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      z-index: 50;
    }
    .wrap{max-width:920px;margin:0 auto;padding:14px 14px 18px}
    .title{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    h1{font-size:18px;margin:0;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted);margin-top:3px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .input, select, button{
      border:1px solid var(--line);
      background: #0f111a;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 14px;
      outline:none;
    }
    .input{flex:1;min-width:180px}
    select{min-width:150px}
    button{
      cursor:pointer;
      background: linear-gradient(180deg, #1a1f33, #111426);
    }
    button.primary{
      border-color: rgba(124,92,255,.5);
      background: linear-gradient(180deg, rgba(124,92,255,.35), rgba(124,92,255,.12));
    }
    button.danger{
      border-color: rgba(255,77,109,.45);
      background: linear-gradient(180deg, rgba(255,77,109,.25), rgba(255,77,109,.08));
    }
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{
      background: var(--chip);
      border:1px solid var(--line);
      color: var(--muted);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
    }
    main{padding: 12px 14px 26px}
    .section{max-width:920px;margin:0 auto}
    .cards{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .card{
      background: radial-gradient(1200px 400px at 20% 0%, rgba(124,92,255,.10), transparent 60%),
                  radial-gradient(900px 300px at 80% 0%, rgba(45,212,191,.08), transparent 55%),
                  var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px 12px;
      box-shadow: var(--shadow);
    }
    .cardHead{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .artistLine{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .artistName{font-weight:700}
    .artistMeta{color:var(--muted);font-size:12px}
    .artistIndex{
      font-size:12px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      color: var(--muted);
      background:#0f111a;
    }
    .songList{
      margin-top:10px;
      display:flex;flex-direction:column;gap:8px;
    }
    .song{
      padding:10px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(15,17,26,.55);
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .songLeft{min-width:0}
    .songTitle{
      font-weight:650;
      line-height:1.2;
      word-break: break-word;
    }
    .songMeta{
      display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;
      color: var(--muted);
      font-size: 12px;
    }
    .pill{
      padding:3px 8px;
      border-radius:999px;
      background:#0f111a;
      border:1px solid rgba(255,255,255,.08);
      color: var(--muted);
    }
    .fav{border-color: rgba(124,92,255,.45); color:#d8d2ff}
    .xfav{border-color: rgba(45,212,191,.45); color:#bdfdf3}
    .songRight{
      display:flex;gap:8px;align-items:center;flex-shrink:0;
    }
    .iconBtn{
      width:40px;height:38px;
      display:grid;place-items:center;
      border-radius: 12px;
      border:1px solid var(--line);
      background:#0f111a;
      cursor:pointer;
    }
    .iconBtn:hover{border-color: rgba(124,92,255,.35)}
    .tiny{font-size:12px;color:var(--muted)}
    .empty{
      border:1px dashed rgba(255,255,255,.15);
      padding: 16px;
      border-radius: var(--radius);
      color: var(--muted);
      text-align:center;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.6);
      display:none;
      z-index: 100;
      padding: 16px;
    }
    .modal{
      max-width: 560px;
      margin: 40px auto;
      background: var(--card);
      border:1px solid var(--line);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      padding: 14px 14px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
    }
    .modalHeader h2{margin:0;font-size:16px}
    .modalBody{padding:14px 14px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .grid .full{grid-column: 1 / -1}
    label{display:block;font-size:12px;color:var(--muted);margin: 0 0 6px 2px}
    .checkRow{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .checkRow label{margin:0;color:var(--text);font-size:14px}
    .checkRow input{transform: scale(1.15)}
    .modalFooter{
      padding: 12px 14px;
      border-top:1px solid var(--line);
      display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;
    }
    .hint{
      font-size:12px;color:var(--muted);
      margin-top: 10px;
      line-height:1.35;
    }

    @media (max-width: 560px){
      .grid{grid-template-columns: 1fr}
      select{min-width: 140px}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="title">
      <div>
        <h1>My Songs</h1>
        <div class="sub" id="statsLine">Loading…</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;">
        <button class="primary" id="addBtn">+ Add</button>
      </div>
    </div>

    <div class="row">
      <input class="input" id="search" placeholder="Search song or artist…" autocomplete="off" />
      <select id="filterFav">
        <option value="all">All</option>
        <option value="fav">Favorites</option>
        <option value="xfav">Extra favorites</option>
      </select>
      <select id="filterMood"></select>
      <select id="filterGenre"></select>
      <button id="exportBtn">Export</button>
      <button id="importBtn">Import</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <button class="danger" id="wipeBtn" title="Deletes local data">Reset</button>
    </div>

    <div class="chips" id="quickChips"></div>
  </div>
</header>

<main>
  <div class="section">
    <div class="cards" id="cards"></div>
    <div id="empty" class="empty" style="display:none;">No songs yet. Tap <b>Add</b> to start.</div>
  </div>
</main>

<!-- Modal -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHeader">
      <h2 id="modalTitle">Add song</h2>
      <button class="iconBtn" id="closeModal" aria-label="Close">✕</button>
    </div>
    <div class="modalBody">
      <div class="grid">
        <div class="full">
          <label>Artist</label>
          <input class="input" id="mArtist" placeholder="e.g. Radiohead" />
        </div>
        <div class="full">
          <label>Song title</label>
          <input class="input" id="mTitle" placeholder="e.g. Karma Police" />
        </div>

        <div>
          <label>Mood</label>
          <select id="mMood"></select>
        </div>
        <div>
          <label>Genre</label>
          <select id="mGenre"></select>
        </div>

        <div class="full">
          <div class="checkRow">
            <label><input type="checkbox" id="mFav" /> Favorite</label>
            <label><input type="checkbox" id="mXFav" /> Extra favorite</label>
          </div>
          <div class="hint">
            Tip: “Extra favorite” is for your repeat songs / top-tier picks.
          </div>
        </div>
      </div>
    </div>
    <div class="modalFooter">
      <button class="danger" id="deleteBtn" style="display:none;">Delete</button>
      <button id="cancelBtn">Cancel</button>
      <button class="primary" id="saveBtn">Save</button>
    </div>
  </div>
</div>

<script>
  // ====== Config: preset tags ======
  const MOODS = ["Any mood", "Happy", "Sad", "Energized", "Calm", "Instrumental"];
  const GENRES = ["Any genre", "Pop", "Rock", "Hip-Hop", "R&B", "Electronic", "Jazz", "Classical", "Indie", "Metal", "Folk", "Other"];

  // ====== Storage ======
  const STORAGE_KEY = "mySongs_v1";
  function loadData(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    }catch(e){
      return [];
    }
  }
  function saveData(list){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
  }

  // Each item: { id, artist, title, mood, genre, fav, xfav, createdAt }
  let songs = loadData();

  // ====== Helpers ======
  const $ = (id)=>document.getElementById(id);
  const norm = (s)=> (s||"").toString().trim();
  const normKey = (s)=> norm(s).toLowerCase();

  function sortSongs(list){
    return [...list].sort((a,b)=>{
      const aa = normKey(a.artist), ba = normKey(b.artist);
      if(aa < ba) return -1;
      if(aa > ba) return 1;
      const at = normKey(a.title), bt = normKey(b.title);
      if(at < bt) return -1;
      if(at > bt) return 1;
      return (a.createdAt||0) - (b.createdAt||0);
    });
  }

  function groupByArtist(sortedList){
    const map = new Map();
    for(const s of sortedList){
      const key = norm(s.artist) || "Unknown artist";
      if(!map.has(key)) map.set(key, []);
      map.get(key).push(s);
    }
    return map; // insertion order follows sortedList
  }

  function uniqueArtistsCount(list){
    const set = new Set(list.map(x=>normKey(x.artist)||"unknown artist"));
    return set.size;
  }

  function setSelectOptions(selectEl, options){
    selectEl.innerHTML = "";
    for(const opt of options){
      const o = document.createElement("option");
      o.value = opt;
      o.textContent = opt;
      selectEl.appendChild(o);
    }
  }

  // ====== UI State ======
  let editingId = null;

  // ====== Render ======
  function render(){
    const q = normKey($("search").value);
    const favFilter = $("filterFav").value;
    const moodFilter = $("filterMood").value;
    const genreFilter = $("filterGenre").value;

    // Filter
    let filtered = songs.filter(s=>{
      const hay = (normKey(s.artist) + " " + normKey(s.title));
      if(q && !hay.includes(q)) return false;

      if(favFilter === "fav" && !s.fav) return false;
      if(favFilter === "xfav" && !s.xfav) return false;

      if(moodFilter && moodFilter !== "Any mood" && (s.mood || "Any mood") !== moodFilter) return false;
      if(genreFilter && genreFilter !== "Any genre" && (s.genre || "Any genre") !== genreFilter) return false;

      return true;
    });

    const sorted = sortSongs(filtered);

    // Stats line (based on ALL songs, not filtered)
    const totalSongs = songs.length;
    const totalArtists = uniqueArtistsCount(songs);
    const favs = songs.filter(s=>s.fav).length;
    const xfavs = songs.filter(s=>s.xfav).length;
    $("statsLine").textContent =
      `${totalSongs} songs • ${totalArtists} artists • ${favs} favorites • ${xfavs} extra favorites`;

    // Quick chips
    const chips = [
      `Showing: ${sorted.length}`,
      q ? `Search: “${$("search").value.trim()}”` : "Search: —",
      `Fav filter: ${favFilter}`,
      `Mood: ${moodFilter}`,
      `Genre: ${genreFilter}`
    ];
    $("quickChips").innerHTML = chips.map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join("");

    // Empty
    $("empty").style.display = (songs.length === 0) ? "block" : "none";

    // Build cards grouped by artist
    const cards = $("cards");
    cards.innerHTML = "";
    if(sorted.length === 0 && songs.length > 0){
      cards.innerHTML = `<div class="empty">No results. Try changing filters.</div>`;
      return;
    }

    const grouped = groupByArtist(sorted);
    const artistNames = Array.from(grouped.keys());

    // Artist index numbering (1..N artists in filtered set)
    artistNames.forEach((artistName, artistIdx0)=>{
      const artistIdx = artistIdx0 + 1;
      const list = grouped.get(artistName);

      // Global song numbering in filtered set (1..N songs)
      // We'll compute global index by walking sorted list once with a map
    });

    const globalIndex = new Map();
    sorted.forEach((s, i)=> globalIndex.set(s.id, i+1));

    artistNames.forEach((artistName, artistIdx0)=>{
      const artistIdx = artistIdx0 + 1;
      const list = grouped.get(artistName);

      // Per-artist song numbering
      const card = document.createElement("div");
      card.className = "card";

      const head = document.createElement("div");
      head.className = "cardHead";

      const left = document.createElement("div");
      const line = document.createElement("div");
      line.className = "artistLine";

      line.innerHTML = `
        <span class="artistIndex">Artist #${artistIdx}</span>
        <span class="artistName">${escapeHtml(artistName)}</span>
        <span class="artistMeta">${list.length} song${list.length===1?"":"s"}</span>
      `;

      left.appendChild(line);

      const addHere = document.createElement("button");
      addHere.className = "iconBtn";
      addHere.title = "Add song to this artist";
      addHere.textContent = "+";
      addHere.onclick = ()=> openModal({ artist: artistName });

      head.appendChild(left);
      head.appendChild(addHere);
      card.appendChild(head);

      const songList = document.createElement("div");
      songList.className = "songList";

      list.forEach((s, idx0)=>{
        const perArtistNum = idx0 + 1;
        const globalNum = globalIndex.get(s.id);

        const song = document.createElement("div");
        song.className = "song";

        const metaPills = [];
        // show mood/genre visually as pills, no horizontal table
        if(s.mood && s.mood !== "Any mood") metaPills.push(`<span class="pill">${escapeHtml(s.mood)}</span>`);
        if(s.genre && s.genre !== "Any genre") metaPills.push(`<span class="pill">${escapeHtml(s.genre)}</span>`);
        if(s.fav) metaPills.push(`<span class="pill fav">★ Favorite</span>`);
        if(s.xfav) metaPills.push(`<span class="pill xfav">✦ Extra</span>`);

        song.innerHTML = `
          <div class="songLeft">
            <div class="songTitle">
              <span class="tiny">#${globalNum} • ${escapeHtml(artistName)} • ${perArtistNum}/${list.length}</span><br/>
              ${escapeHtml(s.title)}
            </div>
            <div class="songMeta">${metaPills.join("")}</div>
          </div>
          <div class="songRight">
            <button class="iconBtn" title="Edit" aria-label="Edit">✎</button>
          </div>
        `;

        song.querySelector("button").onclick = ()=> openModal(s);
        songList.appendChild(song);
      });

      card.appendChild(songList);
      cards.appendChild(card);
    });
  }

  function escapeHtml(str){
    return (str ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ====== Modal logic ======
  function openModal(itemOrPreset){
    $("modalBack").style.display = "block";
    const isEdit = itemOrPreset && itemOrPreset.id;

    editingId = isEdit ? itemOrPreset.id : null;
    $("modalTitle").textContent = isEdit ? "Edit song" : "Add song";
    $("deleteBtn").style.display = isEdit ? "inline-block" : "none";

    $("mArtist").value = itemOrPreset?.artist ?? "";
    $("mTitle").value  = itemOrPreset?.title ?? "";
    $("mMood").value   = itemOrPreset?.mood ?? "Any mood";
    $("mGenre").value  = itemOrPreset?.genre ?? "Any genre";
    $("mFav").checked  = !!itemOrPreset?.fav;
    $("mXFav").checked = !!itemOrPreset?.xfav;

    // If Extra favorite checked, also set favorite automatically (optional behavior)
    $("mXFav").onchange = ()=>{
      if($("mXFav").checked) $("mFav").checked = true;
    };

    setTimeout(()=> $("mTitle").focus(), 60);
  }
  function closeModal(){
    $("modalBack").style.display = "none";
    editingId = null;
  }

  function upsertSong(){
    const artist = norm($("mArtist").value);
    const title  = norm($("mTitle").value);
    const mood   = $("mMood").value || "Any mood";
    const genre  = $("mGenre").value || "Any genre";
    const fav    = $("mFav").checked;
    const xfav   = $("mXFav").checked;

    if(!artist || !title){
      alert("Please fill in Artist and Song Title.");
      return;
    }

    if(editingId){
      const idx = songs.findIndex(s=>s.id === editingId);
      if(idx >= 0){
        songs[idx] = { ...songs[idx], artist, title, mood, genre, fav, xfav };
      }
    }else{
      songs.push({
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
        artist, title, mood, genre, fav, xfav,
        createdAt: Date.now()
      });
    }

    // Always keep local storage updated
    saveData(songs);
    closeModal();
    render();
  }

  function deleteSong(){
    if(!editingId) return;
    if(!confirm("Delete this song?")) return;
    songs = songs.filter(s=>s.id !== editingId);
    saveData(songs);
    closeModal();
    render();
  }

  // ====== Export/Import ======
  function exportJson(){
    const payload = {
      version: 1,
      exportedAt: new Date().toISOString(),
      songs
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "my-songs-export.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function importJsonFile(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const obj = JSON.parse(reader.result);
        const incoming = Array.isArray(obj) ? obj : obj.songs;
        if(!Array.isArray(incoming)) throw new Error("Invalid file");
        // Basic sanitize
        const cleaned = incoming.map(s=>({
          id: s.id || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2)),
          artist: norm(s.artist),
          title: norm(s.title),
          mood: s.mood || "Any mood",
          genre: s.genre || "Any genre",
          fav: !!s.fav,
          xfav: !!s.xfav,
          createdAt: s.createdAt || Date.now()
        })).filter(s=>s.artist && s.title);

        songs = cleaned;
        saveData(songs);
        render();
        alert("Import successful!");
      }catch(e){
        alert("Import failed. Please select a valid export JSON file.");
      }
    };
    reader.readAsText(file);
  }

  // ====== Init ======
  function init(){
    // Populate filters + modal selects
    setSelectOptions($("filterMood"), MOODS);
    setSelectOptions($("filterGenre"), GENRES);
    setSelectOptions($("mMood"), MOODS);
    setSelectOptions($("mGenre"), GENRES);

    // Defaults
    $("filterMood").value = "Any mood";
    $("filterGenre").value = "Any genre";

    // Events
    $("addBtn").onclick = ()=> openModal({});
    $("closeModal").onclick = closeModal;
    $("cancelBtn").onclick = closeModal;
    $("saveBtn").onclick = upsertSong;
    $("deleteBtn").onclick = deleteSong;

    $("modalBack").addEventListener("click", (e)=>{
      if(e.target === $("modalBack")) closeModal();
    });

    ["search","filterFav","filterMood","filterGenre"].forEach(id=>{
      $(id).addEventListener("input", render);
      $(id).addEventListener("change", render);
    });

    $("exportBtn").onclick = exportJson;
    $("importBtn").onclick = ()=> $("importFile").click();
    $("importFile").onchange = (e)=>{
      const f = e.target.files?.[0];
      if(f) importJsonFile(f);
      e.target.value = "";
    };

    $("wipeBtn").onclick = ()=>{
      if(!confirm("Reset will delete all local data on this device/browser. Continue?")) return;
      songs = [];
      saveData(songs);
      render();
    };

    // First render
    render();
  }

  init();
</script>
</body>
</html>

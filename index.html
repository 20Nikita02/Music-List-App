<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Songs</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121826; --muted:#8aa0b8; --text:#e7eef7;
      --line:#1f2a3a; --accent:#7dd3fc; --accent2:#a78bfa;
      --good:#34d399; --warn:#fbbf24;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:linear-gradient(180deg, #070a0f, #0b0f14);
      color:var(--text);
    }
    .wrap{max-width:900px; margin:0 auto; padding:16px}
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      position:sticky; top:0; background:rgba(11,15,20,.9); backdrop-filter: blur(10px);
      padding:12px 0; z-index:10;
    }
    h1{font-size:18px; margin:0; letter-spacing:.3px}
    .btn{
      border:1px solid var(--line); background:rgba(18,24,38,.7);
      color:var(--text); padding:10px 12px; border-radius:12px;
      cursor:pointer; font-weight:600;
    }
    .btn:hover{border-color:#2b3a52}
    .btn.primary{border-color:rgba(125,211,252,.4); box-shadow:0 0 0 2px rgba(125,211,252,.08) inset}
    .btn.danger{border-color:rgba(251,113,133,.35)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .card{
      background:rgba(18,24,38,.75);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .grid{display:grid; gap:12px}
    .grid.two{grid-template-columns:1fr}
    @media(min-width:720px){ .grid.two{grid-template-columns:1.2fr .8fr} }

    details.card{padding:0}
    details.card > summary{
      list-style:none; cursor:pointer; padding:14px;
      display:flex; align-items:center; justify-content:space-between;
      user-select:none;
    }
    details.card > summary::-webkit-details-marker{display:none}
    .chev{opacity:.8}
    details[open] .chev{transform:rotate(180deg)}
    .content{padding:0 14px 14px 14px}

    label{font-size:12px; color:var(--muted); display:block; margin:10px 0 6px}
    input, select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0c1220;
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus{border-color:rgba(125,211,252,.55); box-shadow:0 0 0 3px rgba(125,211,252,.12)}
    .small{font-size:12px; color:var(--muted)}
    .pill{
      display:inline-flex; gap:6px; align-items:center;
      padding:5px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(12,18,32,.8);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .pill.good{color:#b7f7dd; border-color:rgba(52,211,153,.35)}
    .pill.warn{color:#ffe7b0; border-color:rgba(251,191,36,.35)}
    .split{
      display:grid; grid-template-columns:1fr; gap:10px;
    }
    @media(min-width:560px){ .split{grid-template-columns:1fr 1fr} }

    .list{display:flex; flex-direction:column; gap:10px}
    .artistCard{
      border:1px solid var(--line);
      background:rgba(18,24,38,.6);
      border-radius:var(--radius);
      padding:12px;
    }
    .artistTop{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      margin-bottom:10px;
    }
    .artistName{font-weight:800; letter-spacing:.2px}
    .artistMeta{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .songRow{
      border-top:1px dashed rgba(31,42,58,.8);
      padding-top:10px; margin-top:10px;
      display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center;
    }
    .songTitle{font-weight:650}
    .songSub{font-size:12px; color:var(--muted); margin-top:2px}
    .iconBtn{
      border:1px solid var(--line);
      background:#0c1220;
      color:var(--text);
      border-radius:12px;
      padding:9px 10px;
      cursor:pointer;
    }
    .iconBtn:hover{border-color:#2b3a52}
    .muted{color:var(--muted)}
    .right{display:flex; gap:8px; align-items:center}
    .star{
      width:18px; height:18px; display:inline-block; vertical-align:middle;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,.25));
    }
    .footerRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between}
    .hr{height:1px; background:var(--line); margin:10px 0}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:16px; background:rgba(18,24,38,.95); border:1px solid var(--line);
      padding:10px 12px; border-radius:999px; font-size:13px; color:var(--text);
      display:none; z-index:999;
    }
    .inlineRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .inlineRow > *{flex:1}
    .inlineRow .btn{flex:0 0 auto}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>My Songs</h1>
    <div class="row">
      <button class="btn primary" id="toggleAdd">Add New Song</button>
      <button class="btn" id="exportBtn">Export</button>
      <label class="btn" for="importFile" style="cursor:pointer;">Import</label>
      <input id="importFile" type="file" accept="application/json" style="display:none;" />
      <button class="btn danger" id="clearBtn" title="This clears only this device">Clear (device)</button>
    </div>
  </header>

  <div class="grid two">
    <div class="grid">

      <!-- Add form hidden until button -->
      <div class="card" id="addCard" style="display:none;">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div style="font-weight:800;">Add a song</div>
            <div class="small">Fast entry — works great on mobile.</div>
          </div>
          <button class="btn" id="closeAdd">Close</button>
        </div>

        <div class="split" style="margin-top:10px;">
          <div>
            <label>Artist</label>
            <input id="artistInput" list="artistSuggestions" placeholder="e.g. Radiohead" autocomplete="off" />
            <datalist id="artistSuggestions"></datalist>
          </div>
          <div>
            <label>Song title</label>
            <input id="titleInput" list="songSuggestions" placeholder="e.g. Karma Police" autocomplete="off" />
            <datalist id="songSuggestions"></datalist>
          </div>
        </div>

        <div class="split">
          <div>
            <label>Genre</label>
            <select id="genreSelect"></select>
            <div id="newGenreRow" class="inlineRow" style="margin-top:8px; display:none;">
              <input id="newGenreInput" placeholder="Type new genre..." />
              <button class="btn" id="addGenreBtn">Add</button>
            </div>
          </div>
          <div>
            <label>Mood</label>
            <select id="moodSelect"></select>
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <label style="margin:0; display:flex; gap:10px; align-items:center;">
            <input type="checkbox" id="favCheck" style="width:auto;" />
            <span>Favorite</span>
          </label>
          <label style="margin:0; display:flex; gap:10px; align-items:center;">
            <input type="checkbox" id="xFavCheck" style="width:auto;" />
            <span>Extra Favorite</span>
          </label>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="addBtn">Save song</button>
          <span class="small muted" id="addHint"></span>
        </div>
      </div>

      <!-- Collapsible Filters -->
      <details class="card" open>
        <summary>
          <div>
            <div style="font-weight:800;">Filters</div>
            <div class="small">Collapsed = more space. Open when you need it.</div>
          </div>
          <div class="chev">▾</div>
        </summary>
        <div class="content">
          <div class="split">
            <div>
              <label>Search</label>
              <input id="searchInput" placeholder="Search artist or song..." />
            </div>
            <div>
              <label>Filter: Favorites</label>
              <select id="favFilter">
                <option value="all">All</option>
                <option value="fav">Favorite only</option>
                <option value="xfav">Extra Favorite only</option>
                <option value="anyfav">Favorite or Extra Favorite</option>
              </select>
            </div>
          </div>

          <div class="split">
            <div>
              <label>Filter: Genre</label>
              <select id="genreFilter"></select>
            </div>
            <div>
              <label>Filter: Mood</label>
              <select id="moodFilter"></select>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn" id="resetFilters">Reset filters</button>
            <span class="small muted">Tip: everything is always sorted A–Z.</span>
          </div>
        </div>
      </details>

      <!-- Main list -->
      <div class="card">
        <div class="footerRow">
          <div class="artistMeta">
            <span class="pill" id="totalSongsPill">Songs: 0</span>
            <span class="pill" id="totalArtistsPill">Artists: 0</span>
            <span class="pill good" id="favPill">Fav: 0</span>
            <span class="pill warn" id="xFavPill">X-Fav: 0</span>
          </div>
          <div class="small muted">Tap a song to edit.</div>
        </div>
        <div class="hr"></div>
        <div id="list" class="list"></div>
      </div>

    </div>

    <!-- Side: quick guide -->
    <div class="grid">
      <div class="card">
        <div style="font-weight:800;">No horizontal scrolling</div>
        <div class="small" style="margin-top:6px;">
          This layout is built for vertical scrolling only. Important info (artist + title + numbering) is always visible.
        </div>
        <div class="hr"></div>
        <div class="small">
          <b>Sync between devices:</b><br/>
          Use <b>Export</b> on device A → save JSON → on device B use <b>Import</b>.
          (Automatic sync via GitHub alone is not possible without a backend.)
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // ======= Storage =======
  const STORAGE_KEY = "mySongsDB_v1";
  const STORAGE_KEY_GENRES = "mySongsGenres_v1";

  function loadSongs(){
    try{
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    }catch{ return []; }
  }
  function saveSongs(songs){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(songs));
  }

  const DEFAULT_GENRES = [
    "Pop","Rock","Hip-Hop","R&B","Jazz","Classical","Electronic","Indie",
    "K-pop","Country","Hard Rock","Gospel","Metal Rock","French"
  ];

  const DEFAULT_MOODS = ["Any","Happy","Sad","Energetic","Calm","Instrumental"];

  function loadGenres(){
    try{
      const g = JSON.parse(localStorage.getItem(STORAGE_KEY_GENRES));
      if(Array.isArray(g) && g.length) return g;
    }catch{}
    return [...DEFAULT_GENRES];
  }
  function saveGenres(genres){
    localStorage.setItem(STORAGE_KEY_GENRES, JSON.stringify(genres));
  }

  // ======= UI refs =======
  const listEl = document.getElementById("list");

  const addCard = document.getElementById("addCard");
  const toggleAddBtn = document.getElementById("toggleAdd");
  const closeAddBtn = document.getElementById("closeAdd");

  const artistInput = document.getElementById("artistInput");
  const titleInput = document.getElementById("titleInput");

  const genreSelect = document.getElementById("genreSelect");
  const moodSelect = document.getElementById("moodSelect");
  const favCheck = document.getElementById("favCheck");
  const xFavCheck = document.getElementById("xFavCheck");
  const addBtn = document.getElementById("addBtn");
  const addHint = document.getElementById("addHint");

  const searchInput = document.getElementById("searchInput");
  const favFilter = document.getElementById("favFilter");
  const genreFilter = document.getElementById("genreFilter");
  const moodFilter = document.getElementById("moodFilter");
  const resetFilters = document.getElementById("resetFilters");

  const totalSongsPill = document.getElementById("totalSongsPill");
  const totalArtistsPill = document.getElementById("totalArtistsPill");
  const favPill = document.getElementById("favPill");
  const xFavPill = document.getElementById("xFavPill");

  const exportBtn = document.getElementById("exportBtn");
  const importFile = document.getElementById("importFile");
  const clearBtn = document.getElementById("clearBtn");

  const artistSuggestions = document.getElementById("artistSuggestions");
  const songSuggestions = document.getElementById("songSuggestions");

  const newGenreRow = document.getElementById("newGenreRow");
  const newGenreInput = document.getElementById("newGenreInput");
  const addGenreBtn = document.getElementById("addGenreBtn");

  const toastEl = document.getElementById("toast");

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=> toastEl.style.display="none", 1800);
  }

  // ======= Data =======
  let songs = loadSongs();
  let genres = loadGenres();

  // Song schema:
  // { id, artist, title, genre, mood, fav, xfav, createdAt }

  // ======= Helpers =======
  function norm(s){ return (s||"").trim(); }
  function sortAZ(a,b){
    return a.localeCompare(b, undefined, { sensitivity:"base" });
  }
  function uniqueArtistsFromSongs(arr){
    const set = new Set(arr.map(x => x.artist.toLowerCase()));
    return set.size;
  }
  function rebuildSuggestions(){
    const artists = [...new Set(songs.map(s=>s.artist).filter(Boolean))].sort(sortAZ);
    const titles = [...new Set(songs.map(s=>s.title).filter(Boolean))].sort(sortAZ);

    artistSuggestions.innerHTML = artists.map(a=>`<option value="${escapeHtml(a)}"></option>`).join("");
    songSuggestions.innerHTML = titles.map(t=>`<option value="${escapeHtml(t)}"></option>`).join("");
  }
  function escapeHtml(str){
    return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  function buildSelectOptions(selectEl, options, { includeAny=false, anyLabel="Any", extraOptions=[] }={}){
    const opts = [];
    if(includeAny) opts.push({value:"any", label:anyLabel});
    for(const o of options) opts.push({value:o, label:o});
    for(const ex of extraOptions) opts.push(ex);
    selectEl.innerHTML = opts.map(o=>`<option value="${escapeHtml(o.value)}">${escapeHtml(o.label)}</option>`).join("");
  }

  function initSelects(){
    // Add form selects
    buildSelectOptions(genreSelect, genres, {
      includeAny: true, anyLabel: "Choose genre…",
      extraOptions: [{value:"__add__", label:"+ Add new genre…"}]
    });
    buildSelectOptions(moodSelect, DEFAULT_MOODS.filter(m=>m!=="Any"), { includeAny:true, anyLabel:"Choose mood…" });

    // Filter selects
    buildSelectOptions(genreFilter, genres, { includeAny:true, anyLabel:"Any genre" });
    buildSelectOptions(moodFilter, DEFAULT_MOODS.filter(m=>m!=="Any"), { includeAny:true, anyLabel:"Any mood" });
  }

  function applyAddGenreUI(){
    if(genreSelect.value === "__add__"){
      newGenreRow.style.display = "flex";
      newGenreInput.focus();
    } else {
      newGenreRow.style.display = "none";
    }
  }

  // ======= Rendering =======
  function getFilteredSongs(){
    let arr = [...songs];

    // always keep clean sorting baseline later
    const q = norm(searchInput.value).toLowerCase();
    if(q){
      arr = arr.filter(s =>
        s.artist.toLowerCase().includes(q) ||
        s.title.toLowerCase().includes(q)
      );
    }

    // favorite filter
    const ff = favFilter.value;
    if(ff === "fav") arr = arr.filter(s=>!!s.fav);
    if(ff === "xfav") arr = arr.filter(s=>!!s.xfav);
    if(ff === "anyfav") arr = arr.filter(s=>!!s.fav || !!s.xfav);

    // genre filter
    const gf = genreFilter.value;
    if(gf !== "any") arr = arr.filter(s => (s.genre||"") === gf);

    // mood filter
    const mf = moodFilter.value;
    if(mf !== "any") arr = arr.filter(s => (s.mood||"") === mf);

    // Sort by Artist A-Z then Title A-Z
    arr.sort((a,b)=>{
      const c = sortAZ(a.artist, b.artist);
      if(c !== 0) return c;
      return sortAZ(a.title, b.title);
    });

    return arr;
  }

  function render(){
    const arr = getFilteredSongs();

    // Pills counts based on FULL songs, not filtered
    const totalSongs = songs.length;
    const totalArtists = uniqueArtistsFromSongs(songs);
    const totalFav = songs.filter(s=>s.fav).length;
    const totalXFav = songs.filter(s=>s.xfav).length;

    totalSongsPill.textContent = `Songs: ${totalSongs}`;
    totalArtistsPill.textContent = `Artists: ${totalArtists}`;
    favPill.textContent = `Fav: ${totalFav}`;
    xFavPill.textContent = `X-Fav: ${totalXFav}`;

    // Group by artist
    const grouped = new Map();
    for(const s of arr){
      if(!grouped.has(s.artist)) grouped.set(s.artist, []);
      grouped.get(s.artist).push(s);
    }

    const artistNames = [...grouped.keys()].sort(sortAZ);

    listEl.innerHTML = "";
    if(arr.length === 0){
      listEl.innerHTML = `<div class="small muted">No results. Try clearing filters or adding songs.</div>`;
      return;
    }

    // Global song index (in filtered list)
    let globalIndex = 0;

    // Artist numbering (in filtered list)
    artistNames.forEach((artist, aIdx)=>{
      const songsOfArtist = grouped.get(artist) || [];
      // songs already sorted in arr, but ensure:
      songsOfArtist.sort((x,y)=>sortAZ(x.title,y.title));

      const artistCard = document.createElement("div");
      artistCard.className = "artistCard";

      const top = document.createElement("div");
      top.className = "artistTop";

      const left = document.createElement("div");
      left.innerHTML = `
        <div class="artistName">#${aIdx+1} ${escapeHtml(artist)}</div>
        <div class="small muted">${songsOfArtist.length} song(s)</div>
      `;

      const meta = document.createElement("div");
      meta.className = "artistMeta";
      // show most common mood/genre? keep minimal: just a pill count
      meta.innerHTML = `
        <span class="pill">${songsOfArtist.length} songs</span>
      `;

      top.appendChild(left);
      top.appendChild(meta);
      artistCard.appendChild(top);

      songsOfArtist.forEach((s, idx)=>{
        globalIndex++;
        const row = document.createElement("div");
        row.className = "songRow";

        const num = document.createElement("div");
        num.className = "small muted";
        num.innerHTML = `<div>#${globalIndex}</div><div class="small muted">(${idx+1})</div>`; // global + within-artist

        const mid = document.createElement("div");
        const badges = [];
        if(s.genre) badges.push(`<span class="pill">${escapeHtml(s.genre)}</span>`);
        if(s.mood) badges.push(`<span class="pill">${escapeHtml(s.mood)}</span>`);
        if(s.fav) badges.push(`<span class="pill good">★ Fav</span>`);
        if(s.xfav) badges.push(`<span class="pill warn">✦ X-Fav</span>`);

        mid.innerHTML = `
          <div class="songTitle">${escapeHtml(s.title)}</div>
          <div class="songSub">${badges.join(" ")}</div>
        `;

        const right = document.createElement("div");
        right.className = "right";
        right.innerHTML = `
          <button class="iconBtn" title="Edit">Edit</button>
          <button class="iconBtn" title="Delete">Del</button>
        `;

        // Edit on tap
        right.children[0].addEventListener("click", ()=> openEdit(s.id));
        right.children[1].addEventListener("click", ()=> deleteSong(s.id));

        // Also allow tapping middle to edit
        mid.style.cursor = "pointer";
        mid.addEventListener("click", ()=> openEdit(s.id));

        row.appendChild(num);
        row.appendChild(mid);
        row.appendChild(right);
        artistCard.appendChild(row);
      });

      listEl.appendChild(artistCard);
    });
  }

  // ======= CRUD =======
  function addSong(){
    const artist = norm(artistInput.value);
    const title = norm(titleInput.value);

    const genreVal = genreSelect.value;
    const moodVal = moodSelect.value;

    if(!artist || !title){
      addHint.textContent = "Artist and Song Title are required.";
      toast("Fill Artist + Song Title");
      return;
    }
    if(genreVal === "any" || genreVal === "__add__" || moodVal === "any"){
      // allow empty genre/mood if user doesn't care
    }

    // Prevent exact duplicates (same artist + title)
    const exists = songs.some(s =>
      s.artist.toLowerCase() === artist.toLowerCase() &&
      s.title.toLowerCase() === title.toLowerCase()
    );
    if(exists){
      addHint.textContent = "This song already exists.";
      toast("Already exists");
      return;
    }

    const song = {
      id: crypto.randomUUID(),
      artist,
      title,
      genre: (genreVal !== "any" && genreVal !== "__add__") ? genreVal : "",
      mood: (moodVal !== "any") ? moodVal : "",
      fav: !!favCheck.checked,
      xfav: !!xFavCheck.checked,
      createdAt: Date.now()
    };

    songs.push(song);
    saveSongs(songs);

    addHint.textContent = "";
    favCheck.checked = false;
    xFavCheck.checked = false;
    titleInput.value = "";
    // keep artist for speed if adding many for same artist
    toast("Saved");

    rebuildSuggestions();
    render();
  }

  function deleteSong(id){
    songs = songs.filter(s=>s.id !== id);
    saveSongs(songs);
    rebuildSuggestions();
    render();
    toast("Deleted");
  }

  function openEdit(id){
    const s = songs.find(x=>x.id === id);
    if(!s) return;

    // Simple prompt-based edit (minimal + mobile friendly)
    // If you want a modal later, we can do it too.
    const newArtist = norm(prompt("Edit artist:", s.artist) ?? s.artist);
    if(!newArtist) return;

    const newTitle = norm(prompt("Edit song title:", s.title) ?? s.title);
    if(!newTitle) return;

    const newGenre = norm(prompt("Edit genre (leave empty for none):", s.genre || "") ?? (s.genre || ""));
    const newMood = norm(prompt("Edit mood (leave empty for none):", s.mood || "") ?? (s.mood || ""));

    const fav = confirm("Favorite? OK = yes, Cancel = no");
    const xfav = confirm("Extra Favorite? OK = yes, Cancel = no");

    s.artist = newArtist;
    s.title = newTitle;
    s.genre = newGenre;
    s.mood = newMood;
    s.fav = fav;
    s.xfav = xfav;

    saveSongs(songs);
    rebuildSuggestions();
    render();
    toast("Updated");
  }

  // ======= Export / Import =======
  function exportJSON(){
    const payload = {
      version: 1,
      exportedAt: new Date().toISOString(),
      genres,
      songs
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "my-songs-export.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("Exported JSON");
  }

  function importJSON(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        if(!data || !Array.isArray(data.songs)) throw new Error("Invalid file");
        songs = data.songs.map(s=>({
          id: s.id || crypto.randomUUID(),
          artist: norm(s.artist),
          title: norm(s.title),
          genre: norm(s.genre||""),
          mood: norm(s.mood||""),
          fav: !!s.fav,
          xfav: !!s.xfav,
          createdAt: s.createdAt || Date.now()
        })).filter(s=>s.artist && s.title);

        if(Array.isArray(data.genres) && data.genres.length){
          genres = [...new Set(data.genres.map(norm).filter(Boolean))];
        } else {
          genres = loadGenres();
        }

        saveSongs(songs);
        saveGenres(genres);
        initSelects();
        rebuildSuggestions();
        render();
        toast("Imported");
      }catch(e){
        console.error(e);
        toast("Import failed");
        alert("Import failed: file is not valid.");
      }
    };
    reader.readAsText(file);
  }

  // ======= Events =======
  toggleAddBtn.addEventListener("click", ()=>{
    addCard.style.display = (addCard.style.display === "none") ? "block" : "none";
    if(addCard.style.display === "block") artistInput.focus();
  });
  closeAddBtn.addEventListener("click", ()=> addCard.style.display = "none");

  addBtn.addEventListener("click", addSong);

  genreSelect.addEventListener("change", applyAddGenreUI);

  addGenreBtn.addEventListener("click", ()=>{
    const g = norm(newGenreInput.value);
    if(!g){ toast("Type a genre"); return; }
    const exists = genres.some(x=>x.toLowerCase() === g.toLowerCase());
    if(!exists){
      genres.push(g);
      genres.sort(sortAZ);
      saveGenres(genres);
    }
    initSelects();
    genreSelect.value = g;
    applyAddGenreUI();
    newGenreInput.value = "";
    toast("Genre added");
    render();
  });

  searchInput.addEventListener("input", render);
  favFilter.addEventListener("change", render);
  genreFilter.addEventListener("change", render);
  moodFilter.addEventListener("change", render);

  resetFilters.addEventListener("click", ()=>{
    searchInput.value = "";
    favFilter.value = "all";
    genreFilter.value = "any";
    moodFilter.value = "any";
    render();
    toast("Filters reset");
  });

  exportBtn.addEventListener("click", exportJSON);

  importFile.addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if(f) importJSON(f);
    importFile.value = "";
  });

  clearBtn.addEventListener("click", ()=>{
    if(confirm("Clear songs on THIS device only?")){
      songs = [];
      saveSongs(songs);
      toast("Cleared");
      rebuildSuggestions();
      render();
    }
  });

  // ======= Init =======
  initSelects();
  applyAddGenreUI();
  rebuildSuggestions();
  render();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Songs</title>
  <style>
    :root{
      --bg:#0b0f18;
      --panel:#0f1626;
      --panel2:#0c1322;
      --text:#e9eefc;
      --muted:#a9b4d6;
      --line:rgba(255,255,255,.08);
      --chip:rgba(255,255,255,.08);
      --chip2:rgba(255,255,255,.12);
      --good:rgba(80,220,160,.18);
      --gold:rgba(255,215,120,.18);
      --danger:rgba(255,90,110,.16);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      background: radial-gradient(1000px 800px at 20% 0%, #121c34 0%, var(--bg) 55%, #070a10 100%);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:820px;margin:0 auto;padding:18px 14px 40px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 6px 16px;
    }
    .title{
      display:flex;align-items:center;gap:10px;min-width:0;
    }
    .icon{
      width:40px;height:40px;border-radius:14px;
      display:grid;place-items:center;
      background: linear-gradient(145deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .sub{margin:2px 0 0;color:var(--muted);font-size:13px}

    .btnbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:600;
      cursor:pointer;
      box-shadow: 0 8px 18px rgba(0,0,0,.25);
    }
    button:active{transform:translateY(1px)}
    .primary{background: rgba(80,160,255,.18); border-color: rgba(80,160,255,.25)}
    .danger{background: var(--danger); border-color: rgba(255,90,110,.25)}
    .ghost{background: transparent}

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      margin:10px 0 14px;
    }
    .panelHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 14px;
      background: rgba(0,0,0,.18);
      border-bottom:1px solid var(--line);
    }
    .panelHead h2{
      margin:0;font-size:15px;color:var(--text);letter-spacing:.2px;
    }
    .panelBody{padding:12px 14px}

    .statsRow{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      color:var(--muted);font-size:13px;
    }
    .pill{
      padding:6px 10px;border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      display:inline-flex;gap:8px;align-items:center;
    }
    .pill strong{color:var(--text)}
    .tiny{font-size:12px;color:var(--muted)}

    .collapsibleBtn{
      display:inline-flex;gap:8px;align-items:center;
      font-weight:700;
    }
    .chev{opacity:.8}

    /* Form */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:520px){ .grid{grid-template-columns: 1fr} }

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(233,238,252,.35)}
    .row{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center
    }
    .row > *{flex:1 1 auto}
    .toggles{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:6px
    }
    .toggle{
      display:flex;align-items:center;gap:8px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      padding:10px 12px;border-radius:14px;
      user-select:none;
    }
    .toggle input{width:auto}

    .inlineAdd{
      display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap
    }
    .inlineAdd input{flex:1 1 160px}
    .inlineAdd button{flex:0 0 auto}

    /* Filters */
    .filters{
      display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end
    }
    .filters .field{flex:1 1 160px;min-width:150px}
    .filters .field.small{flex:0 0 140px}
    .filtersActions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    /* List */
    .list{
      display:flex;flex-direction:column;gap:10px;
    }
    .artistBlock{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    .artistHead{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .artistLeft{display:flex;gap:10px;align-items:flex-start;min-width:0}
    .badge{
      flex:0 0 auto;
      font-weight:800;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      letter-spacing:.3px;
      white-space:nowrap;
    }
    .artistName{
      font-size:16px;font-weight:850;line-height:1.25;margin:0;
      overflow-wrap:anywhere;
    }
    .artistMeta{color:var(--muted);font-size:12px;margin-top:2px}
    .artistRight{color:var(--muted);font-size:12px;white-space:nowrap}

    .songs{
      padding:10px 10px 12px;
      display:flex;flex-direction:column;gap:10px;
    }
    .songCard{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.03);
      padding:10px 10px;
    }
    .songTop{
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between
    }
    .songLeft{display:flex;gap:10px;align-items:flex-start;min-width:0}
    .songTitle{
      margin:0;
      font-weight:850;
      line-height:1.25;
      overflow-wrap:anywhere; /* long titles wrap nicely */
    }
    .songSub{
      margin:3px 0 0;
      font-size:12px;color:var(--muted);
      overflow-wrap:anywhere;
    }
    .songActions{
      display:flex;gap:8px;flex:0 0 auto;
    }
    .iconBtn{
      width:40px;height:40px;border-radius:14px;
      display:grid;place-items:center;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      cursor:pointer;
    }
    .iconBtn:active{transform:translateY(1px)}
    .iconBtn.danger{background: var(--danger)}
    .chips{
      display:flex;gap:8px;flex-wrap:wrap;margin-top:10px
    }
    .chip{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--chip);
      font-size:12px;
      color:var(--text);
      white-space:nowrap;
    }
    .chip.good{background: var(--good)}
    .chip.gold{background: var(--gold)}
    .chip.dim{background: rgba(255,255,255,.04);color:var(--muted)}
    .foot{
      margin-top:14px;color:var(--muted);font-size:12px;opacity:.95
    }
    .hidden{display:none !important}
    .divider{height:1px;background:var(--line);margin:10px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <div class="icon">ðŸŽµ</div>
        <div style="min-width:0">
          <h1>All Songs</h1>
          <div class="sub">Vertical scroll â€¢ Alphabetical â€¢ Export/Import for sync</div>
        </div>
      </div>
      <div class="btnbar">
        <button class="primary" id="toggleAddBtn">+ Add new song</button>
        <button id="exportBtn">Export</button>
        <button id="importBtn">Import</button>
        <button class="danger" id="resetBtn" title="Delete all local data">Reset</button>
      </div>
    </header>

    <!-- Stats (compact) -->
    <div class="panel">
      <div class="panelHead">
        <h2>Overview</h2>
        <span class="tiny" id="lastSaved"></span>
      </div>
      <div class="panelBody">
        <div class="statsRow" id="statsRow"></div>
        <div class="foot">Sync tip: Export on device A â†’ Import on device B. GitHub hosts the page, but your data is local until you export/import.</div>
      </div>
    </div>

    <!-- Add form (hidden until button) -->
    <div class="panel hidden" id="addPanel">
      <div class="panelHead">
        <h2>Add / Edit song</h2>
        <button class="ghost" id="closeAddBtn">Close</button>
      </div>
      <div class="panelBody">
        <form id="songForm" autocomplete="off">
          <input type="hidden" id="editingId" value="" />
          <div class="grid">
            <div>
              <label>Song title</label>
              <input id="songTitle" placeholder="e.g. Blinding Lights" list="songSuggestions" required />
              <datalist id="songSuggestions"></datalist>
            </div>
            <div>
              <label>Artist</label>
              <input id="artistName" placeholder="e.g. The Weeknd" list="artistSuggestions" required />
              <datalist id="artistSuggestions"></datalist>
            </div>
          </div>

          <div class="grid" style="margin-top:10px">
            <div>
              <label>Genre</label>
              <select id="genreSelect"></select>
              <div class="inlineAdd">
                <input id="newGenre" placeholder="Add new genreâ€¦" />
                <button type="button" id="addGenreBtn">Add</button>
              </div>
            </div>
            <div>
              <label>Mood</label>
              <select id="moodSelect"></select>
              <div class="inlineAdd">
                <input id="newMood" placeholder="Add new moodâ€¦" />
                <button type="button" id="addMoodBtn">Add</button>
              </div>
            </div>
          </div>

          <div class="grid" style="margin-top:10px">
            <div>
              <label>Country (artist origin)</label>
              <select id="countrySelect"></select>
              <div class="inlineAdd">
                <input id="newCountry" placeholder="Add new countryâ€¦" />
                <button type="button" id="addCountryBtn">Add</button>
              </div>
            </div>
            <div>
              <label>Optional notes (hidden in list, shown in details)</label>
              <input id="notes" placeholder="Anything extraâ€¦" />
            </div>
          </div>

          <div class="toggles">
            <label class="toggle"><input type="checkbox" id="fav" /> â˜… Favorite</label>
            <label class="toggle"><input type="checkbox" id="xfav" /> â˜…â˜… Extra favorite</label>
          </div>

          <div class="filtersActions" style="margin-top:12px">
            <button class="primary" type="submit" id="saveBtn">Save</button>
            <button type="button" id="cancelEditBtn">Cancel edit</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Filters (collapsible) -->
    <div class="panel">
      <div class="panelHead">
        <button class="ghost collapsibleBtn" id="toggleFiltersBtn">
          <span class="chev" id="filtersChev">â–¾</span> Filters & Search
        </button>
        <span class="tiny" id="shownCount"></span>
      </div>
      <div class="panelBody" id="filtersBody">
        <div class="filters">
          <div class="field" style="flex: 1 1 240px">
            <label>Search (song or artist)</label>
            <input id="q" placeholder="type to searchâ€¦" />
          </div>
          <div class="field">
            <label>Genre</label>
            <select id="fGenre"></select>
          </div>
          <div class="field">
            <label>Mood</label>
            <select id="fMood"></select>
          </div>
          <div class="field">
            <label>Country</label>
            <select id="fCountry"></select>
          </div>
          <div class="field small">
            <label>Favorite</label>
            <select id="fFav">
              <option value="any">Any</option>
              <option value="fav">â˜… Favorite</option>
              <option value="xfav">â˜…â˜… Extra favorite</option>
            </select>
          </div>
        </div>
        <div class="filtersActions">
          <button type="button" id="clearFiltersBtn">Clear filters</button>
        </div>
      </div>
    </div>

    <!-- List -->
    <div class="list" id="list"></div>
  </div>

<script>
/* =========================
   Storage & Defaults
========================= */
const LS_KEY = "mySongs_v3_compact";
const META_KEY = "mySongs_meta_v3";

const DEFAULT_GENRES = [
  "Pop","Rock","Hip-Hop","R&B","Jazz","Classical","Electronic","Indie",
  "K-Pop","Country","Hard Rock","Gospel","Metal Rock","French"
];
const DEFAULT_MOODS = ["Happy","Sad","Energized","Instrumental","Calm"];
const DEFAULT_COUNTRIES = ["Unknown","USA","UK","Netherlands","France","Japan","Korea","Germany"];

let state = {
  songs: [],
  meta: {
    genres: [...DEFAULT_GENRES],
    moods: [...DEFAULT_MOODS],
    countries: [...DEFAULT_COUNTRIES],
    lastSaved: null
  }
};

function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function norm(s){ return (s||"").trim(); }
function normKey(s){ return norm(s).toLowerCase(); }

function load(){
  const raw = localStorage.getItem(LS_KEY);
  const metaRaw = localStorage.getItem(META_KEY);
  if(raw){
    try{ state.songs = JSON.parse(raw) || []; }catch(e){ state.songs = []; }
  }
  if(metaRaw){
    try{
      const m = JSON.parse(metaRaw);
      if(m && m.genres && m.moods && m.countries){
        state.meta = m;
      }
    }catch(e){}
  }
  // ensure defaults exist (no duplicates)
  state.meta.genres = mergeUnique(DEFAULT_GENRES, state.meta.genres);
  state.meta.moods = mergeUnique(DEFAULT_MOODS, state.meta.moods);
  state.meta.countries = mergeUnique(DEFAULT_COUNTRIES, state.meta.countries);
}

function save(){
  state.meta.lastSaved = new Date().toISOString();
  localStorage.setItem(LS_KEY, JSON.stringify(state.songs));
  localStorage.setItem(META_KEY, JSON.stringify(state.meta));
  render();
}

function mergeUnique(base, arr){
  const set = new Set();
  [...base, ...(arr||[])].forEach(v => {
    const t = norm(v);
    if(t) set.add(t);
  });
  return [...set];
}

/* =========================
   Sorting & Indexing
   - Artist index: #A001 (alphabetical artist)
   - Song index:   #S00001 (alphabetical global within artist->title)
========================= */
function getSortedSongs(){
  const songs = [...state.songs];
  songs.sort((a,b)=>{
    const aa = normKey(a.artist);
    const ba = normKey(b.artist);
    if(aa < ba) return -1;
    if(aa > ba) return 1;
    const at = normKey(a.title);
    const bt = normKey(b.title);
    if(at < bt) return -1;
    if(at > bt) return 1;
    return 0;
  });
  return songs;
}

function buildIndexes(sortedSongs){
  // artist order map
  const artists = [];
  const artistMap = new Map(); // artistKey -> index (1-based)
  sortedSongs.forEach(s=>{
    const key = normKey(s.artist);
    if(!artistMap.has(key)){
      artists.push(s.artist);
      artistMap.set(key, artists.length);
    }
  });

  // add indexes to view model
  const view = [];
  let globalSong = 0;
  sortedSongs.forEach(s=>{
    globalSong += 1;
    const aIdx = artistMap.get(normKey(s.artist));
    view.push({
      ...s,
      artistIndex: aIdx,
      songIndex: globalSong
    });
  });

  return { view, artistCount: artists.length, songCount: globalSong };
}

function pad(n, len){
  const s = String(n);
  return s.length >= len ? s : ("0".repeat(len - s.length) + s);
}

/* =========================
   UI helpers
========================= */
const el = (id)=>document.getElementById(id);

function fillSelect(selectEl, options, extraFirstOptionText=null){
  selectEl.innerHTML = "";
  if(extraFirstOptionText){
    const op = document.createElement("option");
    op.value = "any";
    op.textContent = extraFirstOptionText;
    selectEl.appendChild(op);
  }
  options.forEach(v=>{
    const op = document.createElement("option");
    op.value = v;
    op.textContent = v;
    selectEl.appendChild(op);
  });
}

function updateSuggestions(){
  const artistSet = new Set(state.songs.map(s=>norm(s.artist)).filter(Boolean));
  const songSet = new Set(state.songs.map(s=>norm(s.title)).filter(Boolean));
  const artistDL = el("artistSuggestions");
  const songDL = el("songSuggestions");
  artistDL.innerHTML = "";
  songDL.innerHTML = "";
  [...artistSet].sort((a,b)=>a.localeCompare(b)).forEach(a=>{
    const o=document.createElement("option"); o.value=a; artistDL.appendChild(o);
  });
  [...songSet].sort((a,b)=>a.localeCompare(b)).forEach(t=>{
    const o=document.createElement("option"); o.value=t; songDL.appendChild(o);
  });
}

/* =========================
   Filters
========================= */
function getFilters(){
  return {
    q: normKey(el("q").value),
    genre: el("fGenre").value,
    mood: el("fMood").value,
    country: el("fCountry").value,
    fav: el("fFav").value
  };
}

function passesFilters(song, f){
  const hay = (normKey(song.title) + " " + normKey(song.artist));
  if(f.q && !hay.includes(f.q)) return false;

  if(f.genre !== "any" && f.genre !== (song.genre||"")) return false;
  if(f.mood !== "any" && f.mood !== (song.mood||"")) return false;
  if(f.country !== "any" && f.country !== (song.country||"")) return false;

  if(f.fav === "fav" && !song.fav) return false;
  if(f.fav === "xfav" && !song.xfav) return false;

  return true;
}

/* =========================
   Render
========================= */
function render(){
  // selects
  fillSelect(el("genreSelect"), state.meta.genres);
  fillSelect(el("moodSelect"), state.meta.moods);
  fillSelect(el("countrySelect"), state.meta.countries);

  fillSelect(el("fGenre"), state.meta.genres, "Any");
  fillSelect(el("fMood"), state.meta.moods, "Any");
  fillSelect(el("fCountry"), state.meta.countries, "Any");

  updateSuggestions();

  const sorted = getSortedSongs();
  const { view, artistCount, songCount } = buildIndexes(sorted);

  // filtered view
  const f = getFilters();
  const filtered = view.filter(s => passesFilters(s, f));

  // stats (compact)
  const favCount = state.songs.filter(s=>s.fav).length;
  const xfavCount = state.songs.filter(s=>s.xfav).length;

  el("statsRow").innerHTML = `
    <span class="pill">Artists: <strong>${artistCount}</strong></span>
    <span class="pill">Songs: <strong>${songCount}</strong></span>
    <span class="pill">â˜… Fav: <strong>${favCount}</strong></span>
    <span class="pill">â˜…â˜… X-Fav: <strong>${xfavCount}</strong></span>
  `;

  el("lastSaved").textContent = state.meta.lastSaved
    ? ("Saved: " + new Date(state.meta.lastSaved).toLocaleString())
    : "";

  el("shownCount").textContent = `${filtered.length} shown`;

  // group by artist (already alphabetical)
  const byArtist = new Map(); // artistKey -> {artistName, artistIndex, items}
  filtered.forEach(s=>{
    const k = normKey(s.artist);
    if(!byArtist.has(k)) byArtist.set(k, { artistName: s.artist, artistIndex: s.artistIndex, items: [] });
    byArtist.get(k).items.push(s);
  });

  const list = el("list");
  list.innerHTML = "";

  // render each artist block
  [...byArtist.values()].sort((a,b)=>a.artistIndex - b.artistIndex).forEach(group=>{
    const block = document.createElement("div");
    block.className = "artistBlock";

    const aBadge = `#A${pad(group.artistIndex,3)}`;
    const count = group.items.length;

    block.innerHTML = `
      <div class="artistHead">
        <div class="artistLeft">
          <span class="badge">${aBadge}</span>
          <div style="min-width:0">
            <p class="artistName">${escapeHtml(group.artistName)}</p>
            <div class="artistMeta">${count} song(s)</div>
          </div>
        </div>
        <div class="artistRight">${count} shown</div>
      </div>
      <div class="songs"></div>
    `;

    const songsWrap = block.querySelector(".songs");
    group.items.forEach(s=>{
      const card = document.createElement("div");
      card.className = "songCard";

      // ONLY ONE song number globally
      const sBadge = `#S${pad(s.songIndex,5)}`;

      const chips = [];
      if(s.genre) chips.push(`<span class="chip dim">${escapeHtml(s.genre)}</span>`);
      if(s.mood) chips.push(`<span class="chip dim">${escapeHtml(s.mood)}</span>`);
      if(s.country) chips.push(`<span class="chip dim">${escapeHtml(s.country)}</span>`);
      if(s.fav) chips.push(`<span class="chip good">â˜… Fav</span>`);
      if(s.xfav) chips.push(`<span class="chip gold">â˜…â˜… X-Fav</span>`);

      card.innerHTML = `
        <div class="songTop">
          <div class="songLeft">
            <span class="badge">${sBadge}</span>
            <div style="min-width:0">
              <p class="songTitle">${escapeHtml(s.title)}</p>
              <p class="songSub">${escapeHtml(s.artist)}</p>
              ${chips.length ? `<div class="chips">${chips.join("")}</div>` : ``}
            </div>
          </div>
          <div class="songActions">
            <button class="iconBtn" title="Edit" data-edit="${s.id}">âœŽ</button>
            <button class="iconBtn danger" title="Delete" data-del="${s.id}">ðŸ—‘</button>
          </div>
        </div>
      `;

      songsWrap.appendChild(card);
    });

    list.appendChild(block);
  });

  // bind edit/delete
  list.querySelectorAll("[data-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-del");
      if(confirm("Delete this song?")){
        state.songs = state.songs.filter(s=>s.id !== id);
        save();
      }
    });
  });
  list.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-edit");
      startEdit(id);
    });
  });
}

function escapeHtml(str){
  return (str||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* =========================
   Add/Edit
========================= */
function openAddPanel(open=true){
  el("addPanel").classList.toggle("hidden", !open);
}

function clearForm(){
  el("editingId").value = "";
  el("songTitle").value = "";
  el("artistName").value = "";
  el("notes").value = "";
  el("fav").checked = false;
  el("xfav").checked = false;
  // default selects
  el("genreSelect").selectedIndex = 0;
  el("moodSelect").selectedIndex = 0;
  el("countrySelect").selectedIndex = 0;
}

function startEdit(id){
  const s = state.songs.find(x=>x.id===id);
  if(!s) return;
  openAddPanel(true);
  el("editingId").value = s.id;
  el("songTitle").value = s.title || "";
  el("artistName").value = s.artist || "";
  el("notes").value = s.notes || "";
  setSelectValue(el("genreSelect"), s.genre || state.meta.genres[0]);
  setSelectValue(el("moodSelect"), s.mood || state.meta.moods[0]);
  setSelectValue(el("countrySelect"), s.country || state.meta.countries[0]);
  el("fav").checked = !!s.fav;
  el("xfav").checked = !!s.xfav;
  // scroll to form top on mobile
  window.scrollTo({top:0, behavior:"smooth"});
}

function setSelectValue(sel, v){
  const idx = [...sel.options].findIndex(o=>o.value===v);
  sel.selectedIndex = idx >= 0 ? idx : 0;
}

el("songForm").addEventListener("submit", (e)=>{
  e.preventDefault();
  const id = el("editingId").value || uid();
  const title = norm(el("songTitle").value);
  const artist = norm(el("artistName").value);
  if(!title || !artist) return;

  const payload = {
    id,
    title,
    artist,
    genre: el("genreSelect").value || "",
    mood: el("moodSelect").value || "",
    country: el("countrySelect").value || "",
    notes: norm(el("notes").value),
    fav: el("fav").checked,
    xfav: el("xfav").checked
  };

  const existing = state.songs.findIndex(s=>s.id===id);
  if(existing >= 0) state.songs[existing] = payload;
  else state.songs.push(payload);

  save();
  clearForm();
  openAddPanel(false);
});

el("cancelEditBtn").addEventListener("click", ()=>{
  clearForm();
});

/* =========================
   Add custom Genre/Mood/Country
========================= */
function addToList(kind, inputId){
  const val = norm(el(inputId).value);
  if(!val) return;
  const arr = state.meta[kind];
  if(!arr.includes(val)){
    arr.push(val);
    arr.sort((a,b)=>a.localeCompare(b));
    el(inputId).value = "";
    save();
  }else{
    el(inputId).value = "";
  }
}

el("addGenreBtn").addEventListener("click", ()=>addToList("genres","newGenre"));
el("addMoodBtn").addEventListener("click", ()=>addToList("moods","newMood"));
el("addCountryBtn").addEventListener("click", ()=>addToList("countries","newCountry"));

/* =========================
   Filters interactions
========================= */
["q","fGenre","fMood","fCountry","fFav"].forEach(id=>{
  el(id).addEventListener("input", render);
  el(id).addEventListener("change", render);
});

el("clearFiltersBtn").addEventListener("click", ()=>{
  el("q").value = "";
  el("fGenre").value = "any";
  el("fMood").value = "any";
  el("fCountry").value = "any";
  el("fFav").value = "any";
  render();
});

/* Collapsible filters */
let filtersOpen = true;
el("toggleFiltersBtn").addEventListener("click", ()=>{
  filtersOpen = !filtersOpen;
  el("filtersBody").classList.toggle("hidden", !filtersOpen);
  el("filtersChev").textContent = filtersOpen ? "â–¾" : "â–¸";
});

/* Add panel toggle */
el("toggleAddBtn").addEventListener("click", ()=>{
  const isHidden = el("addPanel").classList.contains("hidden");
  openAddPanel(isHidden);
  if(isHidden){
    clearForm();
    window.scrollTo({top:0, behavior:"smooth"});
  }
});
el("closeAddBtn").addEventListener("click", ()=>openAddPanel(false));

/* =========================
   Export / Import (Sync)
========================= */
function download(filename, text){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([text], {type:"application/json"}));
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

el("exportBtn").addEventListener("click", ()=>{
  const payload = {
    version: 3,
    exportedAt: new Date().toISOString(),
    meta: state.meta,
    songs: state.songs
  };
  download("my-songs-export.json", JSON.stringify(payload, null, 2));
});

el("importBtn").addEventListener("click", async ()=>{
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "application/json";
  inp.onchange = async () => {
    const file = inp.files?.[0];
    if(!file) return;
    const text = await file.text();
    try{
      const data = JSON.parse(text);
      if(!data || !Array.isArray(data.songs)) throw new Error("Invalid file");

      // merge or replace? We'll replace for simplicity.
      state.songs = data.songs.map(s=>({
        id: s.id || uid(),
        title: norm(s.title),
        artist: norm(s.artist),
        genre: s.genre || "",
        mood: s.mood || "",
        country: s.country || "",
        notes: s.notes || "",
        fav: !!s.fav,
        xfav: !!s.xfav
      })).filter(s=>s.title && s.artist);

      if(data.meta && data.meta.genres && data.meta.moods && data.meta.countries){
        state.meta.genres = mergeUnique(DEFAULT_GENRES, data.meta.genres);
        state.meta.moods = mergeUnique(DEFAULT_MOODS, data.meta.moods);
        state.meta.countries = mergeUnique(DEFAULT_COUNTRIES, data.meta.countries);
      }
      save();
      alert("Import complete âœ…");
    }catch(e){
      alert("Import failed. Please choose a valid export file.");
    }
  };
  inp.click();
});

/* Reset */
el("resetBtn").addEventListener("click", ()=>{
  if(confirm("This will delete ALL local data on this device. Continue?")){
    localStorage.removeItem(LS_KEY);
    localStorage.removeItem(META_KEY);
    state.songs = [];
    state.meta = {
      genres:[...DEFAULT_GENRES],
      moods:[...DEFAULT_MOODS],
      countries:[...DEFAULT_COUNTRIES],
      lastSaved:null
    };
    save();
  }
});

/* =========================
   Init
========================= */
load();

// Example starter items (only if empty)
if(state.songs.length === 0){
  state.songs = [
    {id:uid(), title:"Giant Steps", artist:"John Coltrane", genre:"Jazz", mood:"Energized", country:"USA", notes:"", fav:false, xfav:false},
    {id:uid(), title:"Bohemian Rhapsody", artist:"Queen", genre:"Rock", mood:"Energized", country:"UK", notes:"", fav:true, xfav:false},
    {id:uid(), title:"Blinding Lights", artist:"The Weeknd", genre:"Pop", mood:"Happy", country:"Canada", notes:"", fav:false, xfav:true}
  ];
  // Ensure Canada exists if not in defaults
  if(!state.meta.countries.includes("Canada")) state.meta.countries.push("Canada");
  state.meta.countries.sort((a,b)=>a.localeCompare(b));
  save();
} else {
  render();
}
</script>
</body>
  </html>

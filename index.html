<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>All Songs</title>
  <style>
    :root{
      --bg1:#0a0f1c;
      --bg2:#120b2a;
      --card:#0f1524cc;
      --card2:#0f1524f2;
      --stroke:#ffffff14;
      --stroke2:#ffffff1f;
      --text:#eaf0ff;
      --muted:#a9b3d6;
      --muted2:#93a0c9;
      --pill:#1a233a;
      --pill2:#151c2e;
      --accent:#7aa2ff;
      --good:#39d98a;
      --warn:#f7c948;
      --danger:#ff5c7a;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --r:22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 30% 0%, #1b2b6a40, transparent 60%),
                  radial-gradient(900px 600px at 80% 30%, #6a3bf740, transparent 55%),
                  linear-gradient(160deg, var(--bg1), var(--bg2));
      background-attachment: fixed;
    }

    .wrap{
      max-width:760px;
      margin:0 auto;
      padding:18px 14px 40px;
      position:relative;
    }
    .title{
      display:flex; align-items:center; gap:12px;
      padding:18px 16px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, #101a33ee, #0f1524ee);
      border-radius:28px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      margin-bottom:0;
    }
    
    .stickySearch{
      position:sticky;
      top:10px;
      z-index:20;
      margin-top:12px;
      padding:12px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, #101a33ee, #0f1524ee);
      border-radius:20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }
    
    @media (max-width:640px){
      .stickySearch{
        top:8px;
        padding:10px;
        margin-top:10px;
      }
      .title{
        padding:14px 12px;
      }
    }
    
    .stickySearch .input{
      width:100%;
      padding:14px 16px;
      border-radius:16px;
      border:1px solid var(--stroke2);
      background:linear-gradient(180deg, #0b1020, #0f1524);
      color:var(--text);
      outline:none;
      font-size:15px;
    }
    
    .stickySearch .input::placeholder{
      color:#93a0c9aa;
    }
    .icon{
      width:42px;height:42px;border-radius:14px;
      display:grid;place-items:center;
      border:1px solid var(--stroke2);
      background: linear-gradient(180deg,#121b33,#0b1020);
      flex:0 0 auto;
    }
    .icon svg{opacity:.9}
    h1{font-size:28px;margin:0;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:12.5px;margin-top:2px}

    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    
    .countsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (min-width:640px){
      .countsGrid{
        grid-template-columns: repeat(4, auto);
      }
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, #0f1524d6, #0f1524aa);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      color:var(--muted);
      font-size:12.5px;
      white-space:nowrap;
    }
    .pill strong{color:var(--text); font-weight:700}
    .pill .dot{opacity:.55}

    .card{
      margin-top:12px;
      border-radius: var(--r);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, #0f1524e6, #0f1524c6);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .cardHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:14px 14px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(180deg,#101a33b0,#0f1524b0);
    }
    .cardHeadLeft{display:flex; align-items:center; gap:10px; min-width:0}
    .cardHeadTitle{font-weight:800; letter-spacing:.2px}
    .cardHeadHint{color:var(--muted); font-size:12px}
    .collapseBtn{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg,#121b33,#0b1020);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      font-weight:700;
      font-size:12.5px;
    }
    .collapseBtn:active{transform: translateY(1px)}
    .cardBody{padding:12px 14px}
    .hidden{display:none !important}

    .grid2{display:grid; grid-template-columns: 1fr; gap:12px}
    @media (min-width:740px){
      .grid2{grid-template-columns: 1fr 1fr}
    }
    
    .grid3{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (min-width:740px){
      .grid3{grid-template-columns: 1fr 1fr 1fr}
    }

    .field label{
      display:block;
      color:var(--muted);
      font-size:12px;
      margin:0 0 5px 2px;
    }
    .input, select{
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, #0b1020, #0f1524);
      color:var(--text);
      outline:none;
    }
    .input::placeholder{color:#93a0c988}
    select{appearance:none; background-image: linear-gradient(45deg,transparent 50%, #a9b3d6 50%), linear-gradient(135deg, #a9b3d6 50%, transparent 50%); background-position: calc(100% - 18px) calc(1em + 2px), calc(100% - 13px) calc(1em + 2px); background-size: 5px 5px, 5px 5px; background-repeat:no-repeat; padding-right:34px;}

    .inlineAdd{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      margin-top:10px;
    }
    .btn{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg,#121b33,#0b1020);
      color:var(--text);
      padding:11px 14px;
      border-radius:16px;
      cursor:pointer;
      font-weight:800;
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{background:linear-gradient(180deg,#0f1524,#0b1020); color:var(--muted)}
    .btn.danger{border-color:#ff5c7a55; background:linear-gradient(180deg,#2a1220,#0b1020)}
    .btn.small{padding:9px 12px; border-radius:14px; font-size:12.5px}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}

    .help{
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
      margin-top:8px;
    }

    .listWrap{margin-top:12px}
    .artistBlock{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, #0f1524e8, #0f1524c8);
      border-radius: var(--r);
      margin:12px 0;
      overflow:hidden;
    }
    .artistHead{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px;
      padding:12px 12px;
      border-bottom:1px solid var(--stroke);
      background:linear-gradient(180deg,#101a33b0,#0f1524b0);
    }
    .artistLeft{display:flex; gap:10px; align-items:flex-start; min-width:0}
    .badge{
      flex:0 0 auto;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg,#121b33,#0b1020);
      padding:7px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      color:var(--text);
    }
    .artistName{
      font-size:20px;
      font-weight:900;
      line-height:1.1;
      margin:0;
      word-break:break-word;
    }
    .artistMeta{color:var(--muted); font-size:12.5px; margin-top:4px}
    .artistRight{color:var(--muted); font-size:12px; padding-top:4px}

    .songCard{
      padding:12px 12px;
      display:flex;
      gap:10px;
      border-top:1px solid var(--stroke);
      align-items:flex-start;
    }
    .songMain{min-width:0; flex:1 1 auto}
    .songTop{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:10px;
    }
    .songTitle{
      font-weight:900;
      font-size:16px;
      line-height:1.15;
      margin:0;
      word-break:break-word;
    }
    .songSub{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg,#0b1020,#0f1524);
      color:var(--muted);
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }
    .tag.good{border-color:#39d98a33; background:linear-gradient(180deg,#0e2a1f,#0b1020); color:#c6ffe5}
    .tag.warn{border-color:#f7c94833; background:linear-gradient(180deg,#2a2412,#0b1020); color:#fff4c6}
    .tag.star{border-color:#7aa2ff33; background:linear-gradient(180deg,#101a33,#0b1020); color:#d7e2ff}
    
    .songId{
      color:var(--muted);
      font-size:12.5px;
      font-weight:700;
      margin-top:4px;
    }
    .actions{
      display:flex;
      gap:8px;
      flex:0 0 auto;
      align-items:flex-start;
    }
    .iconBtn{
      width:44px; height:44px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg,#121b33,#0b1020);
      cursor:pointer;
      display:grid; place-items:center;
      color:var(--muted);
    }
    .iconBtn:active{transform: translateY(1px)}
    .iconBtn.danger{border-color:#ff5c7a55; color:#ffd1da; background:linear-gradient(180deg,#2a1220,#0b1020)}

    .empty{
      color:var(--muted);
      text-align:center;
      padding:28px 10px;
      border:1px dashed var(--stroke2);
      border-radius: var(--r);
      margin-top:12px;
    }

    /* Charts */
    .chartWrap{
      border:1px solid var(--stroke);
      border-radius: var(--r);
      background:linear-gradient(180deg,#0b1020,#0f1524);
      padding:12px;
    }
    .chartTitle{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .chartTitle span{font-weight:900}
    .chartTitle small{color:var(--muted); font-weight:700}
    canvas{width:100%; height:auto; display:block; border-radius:14px}

    .tinyNote{opacity:.75}
    
    /* Genre Visualization (Hybrid) */
    .genreViz{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    
    .topGenres{
      padding:8px;
    }
    
    .topGenresTitle{
      font-size:12px;
      font-weight:800;
      color:var(--muted);
      margin-bottom:10px;
      text-align:center;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .bubbleCloud{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:center;
    }
    
    .bubble{
      display:inline-flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:12px 16px;
      border-radius:999px;
      border:1px solid rgba(122,162,255,0.3);
      background: linear-gradient(180deg, rgba(122,162,255,0.25), rgba(122,162,255,0.12));
      transition: all 0.2s ease;
      cursor:pointer;
      min-width:0;
    }
    
    .bubble:active{transform: scale(0.95)}
    
    .bubble.size-xl{padding:18px 24px}
    .bubble.size-lg{padding:15px 20px}
    .bubble.size-md{padding:12px 16px}
    .bubble.size-sm{padding:10px 14px}
    
    .bubbleName{
      font-weight:900;
      color:var(--text);
      font-size:13px;
      line-height:1.2;
      word-break:break-word;
    }
    
    .size-xl .bubbleName{font-size:16px}
    .size-lg .bubbleName{font-size:14px}
    .size-md .bubbleName{font-size:13px}
    .size-sm .bubbleName{font-size:12px}
    
    .bubbleCount{
      font-size:11px;
      color:var(--muted);
      margin-top:3px;
      font-weight:700;
    }
    
    .size-xl .bubbleCount{font-size:12px}
    .size-lg .bubbleCount{font-size:11px}
    
    .restGenres{
      border-top:1px solid var(--stroke);
      padding-top:12px;
    }
    
    .restGenresHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
      padding:0 4px;
    }
    
    .restGenresTitle{
      font-size:12px;
      font-weight:800;
      color:var(--muted);
    }
    
    .expandBtn{
      background:none;
      border:1px solid var(--stroke);
      color:var(--text);
      padding:6px 12px;
      border-radius:999px;
      font-size:11px;
      font-weight:800;
      cursor:pointer;
      transition: all 0.2s ease;
    }
    
    .expandBtn:active{transform: scale(0.95)}
    
    .compactList{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:6px;
      max-height:200px;
      overflow:hidden;
      transition: max-height 0.3s ease;
    }
    
    .compactList.expanded{
      max-height:2000px;
    }
    
    @media (min-width:500px){
      .compactList{
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    .compactGenre{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, #0b1020, #0f1524);
      font-size:12px;
      gap:6px;
    }
    
    .compactGenreName{
      font-weight:800;
      color:var(--text);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }
    
    .compactGenreCount{
      font-weight:800;
      color:var(--accent);
      font-size:11px;
      white-space:nowrap;
      flex-shrink:0;
    }
    
    .genreStats{
      text-align:center;
      padding:12px;
      border-top:1px solid var(--stroke);
      margin-top:12px;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }
  </style>
</head>
<body>
<div class="wrap">

  <div class="title">
    <div class="icon" aria-hidden="true">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
        <path d="M9 18V5l12-2v13" stroke="#cfe0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="7" cy="18" r="3" stroke="#cfe0ff" stroke-width="2"/>
        <circle cx="19" cy="16" r="3" stroke="#cfe0ff" stroke-width="2"/>
      </svg>
    </div>
    <div style="min-width:0">
      <h1>All Songs</h1>
      <div class="subtitle">Vertical, compact, searchable â€¢ Artist Aâ€“Z â†’ Song Aâ€“Z â€¢ Export/Import for other devices</div>
    </div>
  </div>

  <!-- Sticky Search Bar -->
  <div class="stickySearch">
    <input class="input" id="quickSearch" placeholder="ðŸ” Quick search (artist or song)..." autocomplete="off" />
  </div>

  <div class="countsGrid" id="countsRow">
    <div class="pill"><strong id="countSongs">0</strong><span class="dot">â€¢</span> Songs</div>
    <div class="pill"><strong id="countArtists">0</strong><span class="dot">â€¢</span> Artists</div>
    <div class="pill"><strong id="countGenres">0</strong><span class="dot">â€¢</span> Genres</div>
    <div class="pill"><strong id="countCountries">0</strong><span class="dot">â€¢</span> Countries</div>
  </div>

  <!-- Filters -->
  <div class="card" id="filtersCard">
    <div class="cardHead">
      <div class="cardHeadLeft">
        <div>
          <div class="cardHeadTitle">Filters</div>
          <div class="cardHeadHint">Keep this collapsed most of the time</div>
        </div>
      </div>
      <button class="collapseBtn" id="filtersToggle">Collapsed â–¾</button>
    </div>
    <div class="cardBody hidden" id="filtersBody">

      <div class="grid3">
        <div class="field">
          <label>Favorite</label>
          <select id="favFilter">
            <option value="any">Any</option>
            <option value="none">None</option>
            <option value="fav">Fav</option>
            <option value="xfav">X-Fav</option>
          </select>
        </div>
        <div class="field">
          <label>Genre</label>
          <select id="genreFilter"></select>
        </div>
        <div class="field">
          <label>Language</label>
          <select id="langFilter"></select>
        </div>
      </div>

      <div class="grid3">
        <div class="field">
          <label>Country</label>
          <select id="countryFilter"></select>
        </div>
        <div class="field">
          <label>Sort</label>
          <select id="sortMode">
            <option value="artist_song">Artist Aâ€“Z â†’ Song Aâ€“Z</option>
          </select>
        </div>
        <div></div>
      </div>

      <div class="btnRow">
        <button class="btn" id="applyFilters">Save</button>
        <button class="btn secondary" id="resetFilters">Reset</button>
      </div>

      <div class="help">
        Data saves automatically on this device (localStorage). Use Export/Import to move your data to another device.
      </div>
    </div>
  </div>

  <!-- Add Song -->
  <div class="card">
    <div class="cardHead">
      <div class="cardHeadLeft">
        <div>
          <div class="cardHeadTitle">Add / Edit</div>
          <div class="cardHeadHint">Minimal form, opens only when needed</div>
        </div>
      </div>
      <button class="collapseBtn" id="addToggle">Add new song â–¾</button>
    </div>

    <div class="cardBody hidden" id="addBody">
      <div class="grid2">
        <div class="field">
          <label>Song title</label>
          <input class="input" id="songTitle" placeholder="e.g. Blinding Lights" />
        </div>
        <div class="field">
          <label>Artist</label>
          <input class="input" id="artistName" placeholder="e.g. The Weeknd" list="artistsList" />
          <datalist id="artistsList"></datalist>
        </div>

        <div class="field">
          <label>Genre</label>
          <select id="genreSelect"></select>
          <div class="inlineAdd">
            <input class="input" id="newGenre" placeholder="Add new genreâ€¦" />
            <button class="btn small" id="addGenreBtn">Add</button>
          </div>
        </div>

        <div class="field">
          <label>Language</label>
          <select id="langSelect"></select>
          <div class="inlineAdd">
            <input class="input" id="newLang" placeholder="Add new languageâ€¦" />
            <button class="btn small" id="addLangBtn">Add</button>
          </div>
        </div>

        <div class="field">
          <label>Country</label>
          <select id="countrySelect"></select>
          <div class="inlineAdd">
            <input class="input" id="newCountry" placeholder="Add new countryâ€¦" />
            <button class="btn small" id="addCountryBtn">Add</button>
          </div>
        </div>

        <div class="field">
          <label>Favorite</label>
          <select id="favSelect">
            <option value="none">None</option>
            <option value="fav">â˜… Fav</option>
            <option value="xfav">â˜…â˜… X-Fav</option>
          </select>
        </div>
      </div>

      <div class="btnRow">
        <button class="btn" id="saveSongBtn">Save</button>
        <button class="btn secondary" id="clearFormBtn">Clear</button>
      </div>

      <div class="btnRow">
        <button class="btn secondary" id="exportBtn">Export (.json)</button>
        <label class="btn secondary" for="importFile" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
          Import (.json)
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </label>
      </div>

      <div class="help tinyNote">
        Sync tip: Export on device A â†’ Import on device B. (GitHub hosts the page, but your data stays local unless you export/import.)
      </div>
    </div>
  </div>

  <!-- Genre Visualization -->
  <div class="card">
    <div class="cardHead">
      <div class="cardHeadLeft">
        <div>
          <div class="cardHeadTitle">ðŸŽµ Genre Overview</div>
          <div class="cardHeadHint">Your music genres visualized</div>
        </div>
      </div>
      <button class="collapseBtn" id="genresToggle">Collapsed â–¾</button>
    </div>
    <div class="cardBody hidden" id="genresBody">
      <div class="genreViz">
        <div class="topGenres">
          <div class="topGenresTitle">ðŸ”¥ Most Played</div>
          <div class="bubbleCloud" id="topBubbles"></div>
        </div>
        
        <div class="restGenres" id="restGenresSection" style="display:none">
          <div class="restGenresHeader">
            <div class="restGenresTitle">Other Genres (<span id="restCount">0</span>)</div>
            <button class="expandBtn" id="expandBtn">Show all</button>
          </div>
          <div class="compactList" id="restList"></div>
        </div>
        
        <div class="genreStats">
          Total: <strong><span id="totalGenresCount">0</span> genres</strong>
        </div>
      </div>
    </div>
  </div>

  <!-- List -->
  <div class="listWrap" id="list"></div>

  <div class="help" style="text-align:center; margin-top:18px;">
    Built for vertical scrolling only â€¢ Works offline after first load â€¢ Designed for 5,000+ songs
  </div>

</div>

<script>
(() => {
  const LS_KEY = "allSongsDB_v6";

  // Default fixed options (you can add more via UI)
  const DEFAULT_GENRES = [
    "Pop","Hip-Hop","R&B","Rock","Hard Rock","Metal Rock","Jazz","Classical","Electronic",
    "Indie","K-Pop","Country","Gospel","French","Instrumental","Other"
  ];
  const DEFAULT_LANGS = [
    "English","Spanish","French","Dutch","German","Italian","Korean","Japanese","Arabic","Other"
  ];
  const DEFAULT_COUNTRIES = [
    "USA","UK","Canada","France","Netherlands","Germany","Italy","Korea","Japan","Nigeria","Other"
  ];

  // State
  let state = loadState();

  // UI refs
  const $ = (id) => document.getElementById(id);

  const listEl = $("list");

  // Quick search
  const quickSearchEl = $("quickSearch");

  // Counts
  const countSongsEl = $("countSongs");
  const countArtistsEl = $("countArtists");
  const countGenresEl = $("countGenres");
  const countCountriesEl = $("countCountries");

  // Filters
  const filtersToggle = $("filtersToggle");
  const filtersBody = $("filtersBody");
  const favFilterEl = $("favFilter");
  const genreFilterEl = $("genreFilter");
  const langFilterEl = $("langFilter");
  const countryFilterEl = $("countryFilter");
  const applyFiltersBtn = $("applyFilters");
  const resetFiltersBtn = $("resetFilters");

  // Add
  const addToggle = $("addToggle");
  const addBody = $("addBody");
  const songTitleEl = $("songTitle");
  const artistNameEl = $("artistName");
  const genreSelectEl = $("genreSelect");
  const langSelectEl = $("langSelect");
  const countrySelectEl = $("countrySelect");
  const favSelectEl = $("favSelect");
  const newGenreEl = $("newGenre");
  const newLangEl = $("newLang");
  const newCountryEl = $("newCountry");
  const addGenreBtn = $("addGenreBtn");
  const addLangBtn = $("addLangBtn");
  const addCountryBtn = $("addCountryBtn");
  const saveSongBtn = $("saveSongBtn");
  const clearFormBtn = $("clearFormBtn");
  const exportBtn = $("exportBtn");
  const importFile = $("importFile");

  // Genres
  const genresToggle = $("genresToggle");
  const genresBody = $("genresBody");
  const topBubblesEl = $("topBubbles");
  const restListEl = $("restList");
  const restCountEl = $("restCount");
  const totalGenresCountEl = $("totalGenresCount");
  const expandBtn = $("expandBtn");
  const restGenresSection = $("restGenresSection");

  // Artist suggestions
  const artistsList = $("artistsList");

  // Editing
  let editingId = null;

  // Collapsed defaults
  setCollapsed(filtersBody, filtersToggle, true);
  setCollapsed(genresBody, genresToggle, true);
  setCollapsed(addBody, addToggle, true, "Add new song");

  // Populate option lists
  ensureDefaults();
  rebuildSelects();
  renderEverything();

  // ---------------- UI Behaviors ----------------

  filtersToggle.addEventListener("click", () => {
    const willCollapse = !filtersBody.classList.contains("hidden");
    setCollapsed(filtersBody, filtersToggle, willCollapse);
  });

  genresToggle.addEventListener("click", () => {
    const willCollapse = !genresBody.classList.contains("hidden");
    setCollapsed(genresBody, genresToggle, willCollapse);
    if (!willCollapse) renderGenreViz(); // render when opened
  });

  expandBtn.addEventListener("click", () => {
    if(restListEl.classList.contains('expanded')){
      restListEl.classList.remove('expanded');
      expandBtn.textContent = 'Show all';
    } else {
      restListEl.classList.add('expanded');
      expandBtn.textContent = 'Show less';
    }
  });

  addToggle.addEventListener("click", () => {
    const willCollapse = !addBody.classList.contains("hidden");
    setCollapsed(addBody, addToggle, willCollapse, "Add new song");
    if (!willCollapse) {
      // focus first field
      setTimeout(() => songTitleEl.focus(), 50);
    }
  });

  applyFiltersBtn.addEventListener("click", () => {
    state.ui.q = quickSearchEl.value || "";
    state.ui.favFilter = favFilterEl.value;
    state.ui.genreFilter = genreFilterEl.value;
    state.ui.langFilter = langFilterEl.value;
    state.ui.countryFilter = countryFilterEl.value;
    saveState();
    renderEverything();
    setCollapsed(filtersBody, filtersToggle, true);
  });

  resetFiltersBtn.addEventListener("click", () => {
    state.ui = defaultUI();
    saveState();
    syncFilterInputs();
    renderEverything();
  });

  addGenreBtn.addEventListener("click", () => addOption("genres", newGenreEl.value, genreSelectEl, genreFilterEl));
  addLangBtn.addEventListener("click", () => addOption("langs", newLangEl.value, langSelectEl, langFilterEl));
  addCountryBtn.addEventListener("click", () => addOption("countries", newCountryEl.value, countrySelectEl, countryFilterEl));

  clearFormBtn.addEventListener("click", () => clearForm());

  saveSongBtn.addEventListener("click", () => {
    const title = cleanStr(songTitleEl.value);
    const artist = cleanStr(artistNameEl.value);
    if (!title || !artist) {
      alert("Please fill Song title and Artist.");
      return;
    }

    const item = {
      id: editingId ?? cryptoId(),
      title,
      artist,
      genre: genreSelectEl.value || "Other",
      language: langSelectEl.value || "English",
      country: countrySelectEl.value || "Other",
      fav: favSelectEl.value || "none",
      updatedAt: Date.now()
    };

    if (editingId) {
      const idx = state.songs.findIndex(s => s.id === editingId);
      if (idx >= 0) state.songs[idx] = item;
    } else {
      state.songs.push(item);
    }

    editingId = null;
    saveState();
    clearForm();

    // hide the form after Save
    setCollapsed(addBody, addToggle, true, "Add new song");

    renderEverything();
  });

  exportBtn.addEventListener("click", () => {
    const payload = {
      version: 6,
      exportedAt: new Date().toISOString(),
      data: state
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "all-songs-export.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  importFile.addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    try {
      const text = await file.text();
      const obj = JSON.parse(text);
      const incoming = obj?.data ?? obj;

      // minimal validation
      if (!incoming || !Array.isArray(incoming.songs)) throw new Error("Invalid file format.");

      // merge options, replace songs + ui
      state.songs = incoming.songs.map(s => ({
        id: s.id || cryptoId(),
        title: cleanStr(s.title) || "Untitled",
        artist: cleanStr(s.artist) || "Unknown",
        genre: s.genre || "Other",
        language: s.language || "English",
        country: s.country || "Other",
        fav: s.fav || "none",
        updatedAt: s.updatedAt || Date.now()
      }));

      state.options = incoming.options || state.options;
      state.ui = incoming.ui || defaultUI();

      ensureDefaults();
      saveState();
      rebuildSelects();
      syncFilterInputs();
      renderEverything();
      alert("Import successful âœ…");
    } catch (err) {
      alert("Import failed: " + err.message);
    } finally {
      importFile.value = "";
    }
  });

  // Live-search
  quickSearchEl.addEventListener("input", () => {
    state.ui.q = quickSearchEl.value;
    renderEverything();
  });

  // ---------------- Rendering ----------------

  function renderEverything(){
    syncFilterInputs();

    const filtered = getFilteredSongs();

    // counts from full DB
    const all = getSortedSongs(state.songs);
    const uniqArtists = unique(all.map(s => norm(s.artist))).length;
    const uniqGenres = unique(all.map(s => norm(s.genre))).length;
    const uniqCountries = unique(all.map(s => norm(s.country))).length;

    countSongsEl.textContent = all.length.toString();
    countArtistsEl.textContent = uniqArtists.toString();
    countGenresEl.textContent = uniqGenres.toString();
    countCountriesEl.textContent = uniqCountries.toString();

    renderList(filtered);

    // update genre viz if open
    if (!genresBody.classList.contains("hidden")) renderGenreViz();
  }

  // ---------------- Genre Visualization ----------------

  function renderGenreViz(){
    const TOP_COUNT = 6; // Show top 6 as bubbles
    
    // Count genres from full database
    const all = getSortedSongs(state.songs);
    const counts = new Map();
    for (const s of all){
      const g = s.genre || "Other";
      counts.set(g, (counts.get(g) || 0) + 1);
    }
    
    // Sort by count descending
    const entries = Array.from(counts.entries()).sort((a,b) => b[1] - a[1]);
    const maxCount = Math.max(1, ...entries.map(e => e[1]));
    
    const topGenres = entries.slice(0, TOP_COUNT);
    const restGenres = entries.slice(TOP_COUNT);
    
    // Update total count
    totalGenresCountEl.textContent = entries.length;
    
    // Render top bubbles
    topBubblesEl.innerHTML = "";
    topGenres.forEach(([name, count]) => {
      const sizeClass = getGenreSizeClass(count, maxCount);
      const bubble = document.createElement('div');
      bubble.className = `bubble ${sizeClass}`;
      bubble.innerHTML = `
        <div class="bubbleName">${name}</div>
        <div class="bubbleCount">${count} songs</div>
      `;
      topBubblesEl.appendChild(bubble);
    });
    
    // Render rest as compact list
    if (restGenres.length > 0){
      restGenresSection.style.display = 'block';
      restCountEl.textContent = restGenres.length;
      restListEl.innerHTML = "";
      restGenres.forEach(([name, count]) => {
        const item = document.createElement('div');
        item.className = 'compactGenre';
        item.innerHTML = `
          <div class="compactGenreName">${name}</div>
          <div class="compactGenreCount">${count}</div>
        `;
        restListEl.appendChild(item);
      });
    } else {
      restGenresSection.style.display = 'none';
    }
  }
  
  function getGenreSizeClass(count, max){
    const percentage = count / max;
    if (percentage >= 0.70) return 'size-xl';
    if (percentage >= 0.50) return 'size-lg';
    if (percentage >= 0.30) return 'size-md';
    return 'size-sm';
  }

  function renderList(songs){
    listEl.innerHTML = "";

    if (!songs.length){
      const div = document.createElement("div");
      div.className = "empty";
      div.textContent = "No songs match your filters.";
      listEl.appendChild(div);
      return;
    }

    // Build artist ordering based on GLOBAL sorted songs
    const allSorted = getSortedSongs(state.songs);
    const artistOrder = unique(allSorted.map(s => norm(s.artist)));
    const artistIndexMap = new Map();
    artistOrder.forEach((a, i) => artistIndexMap.set(a, i+1));

    // Global song numbering
    const songIndexMap = new Map();
    allSorted.forEach((s, i) => songIndexMap.set(s.id, i+1));

    // Group filtered songs by artist
    const grouped = new Map();
    for (const s of songs){
      const key = norm(s.artist);
      if (!grouped.has(key)) grouped.set(key, []);
      grouped.get(key).push(s);
    }

    // Render artists in global Aâ€“Z order
    for (const artistKey of artistOrder){
      const arr = grouped.get(artistKey);
      if (!arr || !arr.length) continue;

      const artistName = arr[0].artist;

      const block = document.createElement("div");
      block.className = "artistBlock";

      const head = document.createElement("div");
      head.className = "artistHead";

      const left = document.createElement("div");
      left.className = "artistLeft";

      const aBadge = document.createElement("div");
      aBadge.className = "badge";
      aBadge.textContent = "#A" + artistIndexMap.get(artistKey);

      const metaWrap = document.createElement("div");
      metaWrap.style.minWidth = "0";

      const name = document.createElement("div");
      name.className = "artistName";
      name.textContent = artistName;

      const meta = document.createElement("div");
      meta.className = "artistMeta";
      meta.textContent = `${arr.length} song(s) shown`;

      metaWrap.appendChild(name);
      metaWrap.appendChild(meta);

      left.appendChild(aBadge);
      left.appendChild(metaWrap);

      const right = document.createElement("div");
      right.className = "artistRight";
      right.textContent = `${arr.length} shown`;

      head.appendChild(left);
      head.appendChild(right);

      block.appendChild(head);

      // render song cards
      for (const s of arr){
        const row = document.createElement("div");
        row.className = "songCard";

        const main = document.createElement("div");
        main.className = "songMain";

        const top = document.createElement("div");
        top.className = "songTop";

        const titleWrap = document.createElement("div");
        titleWrap.style.minWidth = "0";
        titleWrap.style.flex = "1 1 auto";

        const title = document.createElement("div");
        title.className = "songTitle";
        title.textContent = s.title;

        const sBadge = document.createElement("div");
        sBadge.className = "songId";
        sBadge.textContent = "#S" + padSong(songIndexMap.get(s.id));

        titleWrap.appendChild(title);
        titleWrap.appendChild(sBadge);
        top.appendChild(titleWrap);

        const sub = document.createElement("div");
        sub.className = "songSub";

        // Genre, Language, Country tags
        const g = mkTag(s.genre);
        const l = mkTag(s.language);
        const c = mkTag(s.country);

        sub.appendChild(g);
        sub.appendChild(l);
        sub.appendChild(c);

        // Favorite tags
        if (s.fav === "fav") sub.appendChild(mkTag("â˜… Fav", "good"));
        if (s.fav === "xfav") sub.appendChild(mkTag("â˜…â˜… X-Fav", "warn"));

        const actions = document.createElement("div");
        actions.className = "actions";

        const editBtn = iconBtn("âœŽ", "Edit");
        editBtn.addEventListener("click", () => startEdit(s));

        const delBtn = iconBtn("ðŸ—‘", "Delete", true);
        delBtn.addEventListener("click", () => {
          if (!confirm(`Delete "${s.title}" by ${s.artist}?`)) return;
          state.songs = state.songs.filter(x => x.id !== s.id);
          saveState();
          renderEverything();
        });

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        main.appendChild(top);
        main.appendChild(sub);

        row.appendChild(main);
        row.appendChild(actions);

        block.appendChild(row);
      }

      listEl.appendChild(block);
    }

    rebuildArtistDatalist();
  }

  // ---------------- Helpers ----------------

  function setCollapsed(bodyEl, btnEl, collapsed, openLabel){
    if (collapsed){
      bodyEl.classList.add("hidden");
      btnEl.textContent = "Collapsed â–¾";
    } else {
      bodyEl.classList.remove("hidden");
      btnEl.textContent = (openLabel ? "Close â–´" : "Open â–´");
      if (btnEl === addToggle) btnEl.textContent = "Close â–´";
      if (btnEl === filtersToggle) btnEl.textContent = "Open â–´";
      if (btnEl === chartsToggle) btnEl.textContent = "Open â–´";
    }
    if (btnEl === addToggle && collapsed) btnEl.textContent = (openLabel || "Add new song") + " â–¾";
  }

  function mkTag(text, kind){
    const el = document.createElement("div");
    el.className = "tag" + (kind ? (" " + kind) : "");
    el.textContent = text || "â€”";
    return el;
  }

  function iconBtn(char, title, danger=false){
    const b = document.createElement("button");
    b.className = "iconBtn" + (danger ? " danger" : "");
    b.title = title;
    b.textContent = char;
    return b;
  }

  function startEdit(s){
    editingId = s.id;

    setCollapsed(addBody, addToggle, false);
    songTitleEl.value = s.title;
    artistNameEl.value = s.artist;

    ensureOption("genres", s.genre);
    ensureOption("langs", s.language);
    ensureOption("countries", s.country);

    rebuildSelects();

    genreSelectEl.value = s.genre || "Other";
    langSelectEl.value = s.language || "English";
    countrySelectEl.value = s.country || "Other";
    favSelectEl.value = s.fav || "none";

    setTimeout(() => songTitleEl.focus(), 60);
  }

  function clearForm(){
    editingId = null;
    songTitleEl.value = "";
    artistNameEl.value = "";
    genreSelectEl.value = state.options.genres[0] || "Other";
    langSelectEl.value = "English";
    countrySelectEl.value = state.options.countries[0] || "Other";
    favSelectEl.value = "none";
    newGenreEl.value = "";
    newLangEl.value = "";
    newCountryEl.value = "";
  }

  function addOption(bucket, raw, selectA, selectB){
    const val = cleanStr(raw);
    if (!val) return;
    ensureOption(bucket, val);
    saveState();
    rebuildSelects();
    selectA.value = val;
    if (selectB) selectB.value = val;
    if (bucket === "genres") newGenreEl.value = "";
    if (bucket === "langs") newLangEl.value = "";
    if (bucket === "countries") newCountryEl.value = "";
    renderEverything();
  }

  function ensureOption(bucket, val){
    const clean = cleanStr(val);
    if (!clean) return;
    const arr = state.options[bucket];
    if (!arr.some(x => norm(x) === norm(clean))){
      arr.push(clean);
      arr.sort((a,b)=> a.localeCompare(b, undefined, {sensitivity:"base"}));
    }
  }

  function ensureDefaults(){
    if (!state.options) state.options = {genres:[], langs:[], countries:[]};

    for (const g of DEFAULT_GENRES) ensureOption("genres", g);
    for (const l of DEFAULT_LANGS) ensureOption("langs", l);
    for (const c of DEFAULT_COUNTRIES) ensureOption("countries", c);

    ensureOption("langs", "English");
  }

  function rebuildSelects(){
    rebuildSelect(genreFilterEl, ["any"].concat(state.options.genres), state.ui.genreFilter || "any", (v)=> v==="any" ? "Any" : v);
    rebuildSelect(langFilterEl, ["any"].concat(state.options.langs), state.ui.langFilter || "any", (v)=> v==="any" ? "Any" : v);
    rebuildSelect(countryFilterEl, ["any"].concat(state.options.countries), state.ui.countryFilter || "any", (v)=> v==="any" ? "Any" : v);

    rebuildSelect(genreSelectEl, state.options.genres, genreSelectEl.value || state.options.genres[0]);
    rebuildSelect(langSelectEl, state.options.langs, langSelectEl.value || "English");
    rebuildSelect(countrySelectEl, state.options.countries, countrySelectEl.value || state.options.countries[0]);

    rebuildArtistDatalist();
    syncFilterInputs();
  }

  function rebuildSelect(selectEl, values, selected, labelFn){
    const old = selectEl.value;
    selectEl.innerHTML = "";
    for (const v of values){
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = labelFn ? labelFn(v) : v;
      selectEl.appendChild(opt);
    }
    const candidate = selected ?? old;
    if (candidate && Array.from(selectEl.options).some(o => o.value === candidate)){
      selectEl.value = candidate;
    } else {
      selectEl.selectedIndex = 0;
    }
  }

  function rebuildArtistDatalist(){
    const all = getSortedSongs(state.songs);
    const artists = unique(all.map(s => s.artist)).sort((a,b)=> a.localeCompare(b, undefined, {sensitivity:"base"}));
    artistsList.innerHTML = "";
    for (const a of artists){
      const opt = document.createElement("option");
      opt.value = a;
      artistsList.appendChild(opt);
    }
  }

  function syncFilterInputs(){
    quickSearchEl.value = state.ui.q || "";
    favFilterEl.value = state.ui.favFilter || "any";
    genreFilterEl.value = state.ui.genreFilter || "any";
    langFilterEl.value = state.ui.langFilter || "any";
    countryFilterEl.value = state.ui.countryFilter || "any";
  }

  function getFilteredSongs(){
    const base = getSortedSongs(state.songs);
    const q = (quickSearchEl.value || state.ui.q || "").trim().toLowerCase();
    const fav = state.ui.favFilter || favFilterEl.value || "any";
    const g = state.ui.genreFilter || genreFilterEl.value || "any";
    const l = state.ui.langFilter || langFilterEl.value || "any";
    const c = state.ui.countryFilter || countryFilterEl.value || "any";

    return base.filter(s => {
      if (q){
        const hay = (s.title + " " + s.artist).toLowerCase();
        if (!hay.includes(q)) return false;
      }
      if (fav !== "any"){
        if (fav === "none" && s.fav !== "none") return false;
        if (fav === "fav" && s.fav !== "fav") return false;
        if (fav === "xfav" && s.fav !== "xfav") return false;
      }
      if (g !== "any" && norm(s.genre) !== norm(g)) return false;
      if (l !== "any" && norm(s.language) !== norm(l)) return false;
      if (c !== "any" && norm(s.country) !== norm(c)) return false;
      return true;
    });
  }

  function getSortedSongs(arr){
    return [...arr].sort((a,b) => {
      const aa = norm(a.artist), ab = norm(b.artist);
      if (aa !== ab) return aa.localeCompare(ab, undefined, {sensitivity:"base"});
      const ta = norm(a.title), tb = norm(b.title);
      if (ta !== tb) return ta.localeCompare(tb, undefined, {sensitivity:"base"});
      return (a.updatedAt||0) - (b.updatedAt||0);
    });
  }

  function padSong(n){
    return String(n || 0);
  }

  function unique(arr){
    const seen = new Set();
    const out = [];
    for (const v of arr){
      const k = norm(v);
      if (!seen.has(k)){
        seen.add(k);
        out.push(v);
      }
    }
    return out;
  }

  function cleanStr(s){
    return (s ?? "").toString().trim().replace(/\s+/g, " ");
  }
  function norm(s){
    return cleanStr(s).toLowerCase();
  }

  function defaultUI(){
    return {
      q: "",
      favFilter: "any",
      genreFilter: "any",
      langFilter: "any",
      countryFilter: "any",
      sortMode: "artist_song"
    };
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return {songs:[], options:{genres:[], langs:[], countries:[]}, ui: defaultUI()};
      const parsed = JSON.parse(raw);
      return {
        songs: Array.isArray(parsed.songs) ? parsed.songs : [],
        options: parsed.options || {genres:[], langs:[], countries:[]},
        ui: parsed.ui || defaultUI()
      };
    } catch {
      return {songs:[], options:{genres:[], langs:[], countries:[]}, ui: defaultUI()};
    }
  }

  function saveState(){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function cryptoId(){
    return "s_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }

})();
</script>
</body>
</html>

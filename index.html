<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Songs</title>
  <style>
    :root{
      --bg:#0b0d10;
      --card:#11151b;
      --muted:#97a3b6;
      --text:#eef2ff;
      --line:#1c2431;
      --accent:#7aa2ff;
      --good:#3ddc97;
      --warn:#ffcf5a;
      --bad:#ff6b6b;
      --pill:#182234;
      --pill2:#1b2b24;
      --pill3:#2c1e27;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(180deg,#07080a, #0b0d10 35%, #0b0d10);
      color:var(--text);
    }
    header{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter: blur(12px);
      background:rgba(11,13,16,.72);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    h1{font-size:18px;margin:0;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}

    .card{
      background:rgba(17,21,27,.92);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.22);
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      padding:14px;
    }
    @media(min-width:860px){
      .grid{
        grid-template-columns: 360px 1fr;
        align-items:start;
      }
    }

    button, input, select{
      font:inherit;
    }
    .btn{
      border:1px solid var(--line);
      background:#0f1319;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
    }
    .btn:hover{border-color:#2a3950}
    .btn.primary{
      background:linear-gradient(180deg,#1a2a44,#13223a);
      border-color:#2a3950;
      color:#eaf0ff;
    }
    .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
    .btn.danger{border-color:#3a1d22;background:#160b0d;color:#ffd6d6}

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:10px;
    }
    label{font-size:12px;color:var(--muted)}
    input, select{
      width:100%;
      border:1px solid var(--line);
      background:#0b0f14;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;

      /* IMPORTANT: make selects always clickable */
      position: relative;
      z-index: 5;
      -webkit-appearance: menulist;
      appearance: menulist;
    }
    input::placeholder{color:#63718a}
    .two{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    .three{display:grid;grid-template-columns: 1fr 1fr 1fr;gap:10px}
    @media(max-width:520px){
      .two,.three{grid-template-columns:1fr}
    }

    details{
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background:rgba(17,21,27,.75);
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    summary::-webkit-details-marker{display:none}
    .caret{color:var(--muted)}
    .pad{padding:12px;border-top:1px solid var(--line)}

    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .stat{
      padding:8px 10px;
      border-radius:999px;
      background:var(--pill);
      border:1px solid var(--line);
      font-size:12px;
      color:#d9e2ff;
    }

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .search{
      flex:1;
      min-width:200px;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }
    .item{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#0d1218;
    }
    .idx{
      width:44px;
      flex:0 0 44px;
      text-align:center;
      padding:6px 8px;
      border-radius:12px;
      background:#0b0f14;
      border:1px solid var(--line);
      color:#cfe0ff;
      font-size:12px;
      line-height:1.2;
    }
    .item-main{flex:1;min-width:0}
    .title{
      font-weight:600;
      font-size:14px;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta{
      margin-top:4px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#0b0f14;
    }
    .pill.genre{background:var(--pill); color:#d9e2ff}
    .pill.mood{background:var(--pill2); color:#dbffe9}
    .pill.fav{background:#16213a;color:#eaf0ff}
    .pill.xfav{background:#2b1b24;color:#ffe1f0;border-color:#3b2132}

    .item-actions{
      display:flex;
      flex-direction:column;
      gap:8px;
      flex:0 0 auto;
    }
    .iconbtn{
      width:40px;height:40px;
      border-radius:12px;
      display:grid;
      place-items:center;
      border:1px solid var(--line);
      background:#0b0f14;
      cursor:pointer;
      color:var(--text);
    }
    .iconbtn:hover{border-color:#2a3950}
    .muted{color:var(--muted)}
    .footer-note{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.4}

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:200;
    }
    .modal.open{display:flex}
    .modal-card{
      width:min(680px, 100%);
      background:rgba(17,21,27,.97);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 16px 60px rgba(0,0,0,.5);
    }
    .modal-head{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .modal-head h2{margin:0;font-size:16px}
    .hr{height:1px;background:var(--line);margin:12px 0}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>My Songs</h1>
        <div class="sub">Minimal, mobile-first. Vertical scroll only.</div>
      </div>
      <div class="row">
        <button class="btn small" id="btnExport">Export</button>
        <button class="btn small" id="btnImport">Import</button>
        <input type="file" id="fileImport" accept="application/json" hidden />
      </div>
    </div>
  </div>
</header>

<div class="grid">
  <!-- Left column -->
  <div class="wrap" style="padding-top:14px">
    <div class="card">
      <div class="toolbar">
        <button class="btn primary" id="toggleAdd">+ Add New Song</button>
        <button class="btn small" id="btnReset" title="Reset filters">Reset</button>
      </div>

      <div class="stats" id="stats"></div>

      <!-- Add form hidden until button -->
      <div id="addForm" style="display:none;margin-top:12px">
        <div class="two">
          <div class="field">
            <label>Artist</label>
            <input id="artistInput" list="artistList" placeholder="e.g. Radiohead" autocomplete="off" />
            <datalist id="artistList"></datalist>
          </div>
          <div class="field">
            <label>Song Title</label>
            <input id="songInput" list="songList" placeholder="e.g. Karma Police" autocomplete="off" />
            <datalist id="songList"></datalist>
          </div>
        </div>

        <div class="two">
          <div class="field">
            <label>Genre</label>
            <select id="genreSelect"></select>
            <div class="row" style="margin-top:8px">
              <input id="newGenre" placeholder="Add new genre‚Ä¶" />
              <button class="btn small" id="addGenreBtn">Add</button>
            </div>
          </div>

          <div class="field">
            <label>Mood</label>
            <select id="moodSelect"></select>
            <div class="row" style="margin-top:8px">
              <input id="newMood" placeholder="Add new mood‚Ä¶" />
              <button class="btn small" id="addMoodBtn">Add</button>
            </div>
          </div>
        </div>

        <div class="three">
          <div class="field">
            <label>Favorite</label>
            <select id="favSelect">
              <option value="none">No</option>
              <option value="fav">Favorite</option>
              <option value="xfav">Extra Favorite</option>
            </select>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button class="btn primary" id="addBtn">Add to list</button>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button class="btn" id="cancelAdd">Cancel</button>
          </div>
        </div>

        <div class="footer-note">
          Tip: type a few letters and pick from suggestions. Everything saves automatically.
        </div>
      </div>
    </div>

    <!-- Filters (collapsible) -->
    <details open style="margin-top:12px">
      <summary>
        <span>Filters</span>
        <span class="caret">tap to collapse</span>
      </summary>
      <div class="pad">
        <div class="field">
          <label>Search (artist or song)</label>
          <input id="searchInput" class="search" placeholder="Type to search‚Ä¶" />
        </div>

        <div class="two">
          <div class="field">
            <label>Genre</label>
            <select id="filterGenre"></select>
          </div>
          <div class="field">
            <label>Mood</label>
            <select id="filterMood"></select>
          </div>
        </div>

        <div class="two">
          <div class="field">
            <label>Show</label>
            <select id="filterFav">
              <option value="all">All</option>
              <option value="fav">Favorite only</option>
              <option value="xfav">Extra Favorite only</option>
              <option value="anyfav">Any favorite (fav + extra)</option>
              <option value="nonefav">No favorites</option>
            </select>
          </div>
          <div class="field">
            <label>Sort</label>
            <select id="sortMode">
              <option value="artist_song">Artist A‚ÜíZ, then Song A‚ÜíZ</option>
              <option value="song_artist">Song A‚ÜíZ, then Artist A‚ÜíZ</option>
            </select>
          </div>
        </div>

        <div class="footer-note">
          This layout avoids horizontal scrolling: only the important info is shown in the list cards.
        </div>
      </div>
    </details>
  </div>

  <!-- Right column -->
  <div class="wrap" style="padding-top:14px">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="muted" style="font-size:12px">List</div>
          <div style="font-size:14px;font-weight:600" id="listTitle">All Songs</div>
        </div>
        <div class="muted" style="font-size:12px" id="countText"></div>
      </div>

      <div class="list" id="list"></div>
      <div class="footer-note">
        Tap a song to edit details. Row number = song index in the current filtered view.
      </div>
    </div>
  </div>
</div>

<!-- Edit modal -->
<div class="modal" id="modal">
  <div class="modal-card">
    <div class="modal-head">
      <h2>Edit Song</h2>
      <button class="btn small" id="closeModal">Close</button>
    </div>
    <div class="hr"></div>

    <div class="two">
      <div class="field">
        <label>Artist</label>
        <input id="editArtist" list="artistList" />
      </div>
      <div class="field">
        <label>Song Title</label>
        <input id="editSong" list="songList" />
      </div>
    </div>

    <div class="two">
      <div class="field">
        <label>Genre</label>
        <select id="editGenre"></select>
      </div>
      <div class="field">
        <label>Mood</label>
        <select id="editMood"></select>
      </div>
    </div>

    <div class="two">
      <div class="field">
        <label>Favorite</label>
        <select id="editFav">
          <option value="none">No</option>
          <option value="fav">Favorite</option>
          <option value="xfav">Extra Favorite</option>
        </select>
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button class="btn danger" id="deleteBtn">Delete</button>
      </div>
    </div>

    <div class="field">
      <label class="muted">Changes save automatically when you press ‚ÄúSave changes‚Äù.</label>
      <button class="btn primary" id="saveBtn">Save changes</button>
    </div>
  </div>
</div>

<script>
  // ---------- Storage ----------
  const KEY = "mySongs_v3";
  const KEY_GENRES = "mySongs_genres_v3";
  const KEY_MOODS = "mySongs_moods_v3";

  const defaultGenres = [
    "Pop","Rock","Hip-Hop","R&B","Jazz","Classical","Electronic","Indie",
    "K-Pop","Country","Hard Rock","Gospel","Metal Rock","French"
  ];

  const defaultMoods = [
    "Happy","Sad","Energized","Instrumental","Calm"
  ];

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      return JSON.parse(raw);
    }catch(e){
      return fallback;
    }
  }
  function saveJSON(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }

  // Songs data model:
  // { id, artist, title, genre, mood, fav: "none"|"fav"|"xfav" }
  let songs = loadJSON(KEY, []);
  let genres = loadJSON(KEY_GENRES, defaultGenres);
  let moods  = loadJSON(KEY_MOODS, defaultMoods);

  // ---------- DOM ----------
  const $ = (id)=>document.getElementById(id);

  const listEl = $("list");
  const statsEl = $("stats");
  const countText = $("countText");
  const listTitle = $("listTitle");

  const addForm = $("addForm");
  const toggleAdd = $("toggleAdd");
  const cancelAdd = $("cancelAdd");

  const artistInput = $("artistInput");
  const songInput = $("songInput");
  const genreSelect = $("genreSelect");
  const moodSelect = $("moodSelect");
  const favSelect = $("favSelect");

  const newGenre = $("newGenre");
  const addGenreBtn = $("addGenreBtn");

  const newMood = $("newMood");
  const addMoodBtn = $("addMoodBtn");

  const addBtn = $("addBtn");

  const searchInput = $("searchInput");
  const filterGenre = $("filterGenre");
  const filterMood = $("filterMood");
  const filterFav = $("filterFav");
  const sortMode = $("sortMode");
  const btnReset = $("btnReset");

  // Export/Import
  const btnExport = $("btnExport");
  const btnImport = $("btnImport");
  const fileImport = $("fileImport");

  // Modal
  const modal = $("modal");
  const closeModal = $("closeModal");
  const saveBtn = $("saveBtn");
  const deleteBtn = $("deleteBtn");
  const editArtist = $("editArtist");
  const editSong = $("editSong");
  const editGenre = $("editGenre");
  const editMood = $("editMood");
  const editFav = $("editFav");

  const artistList = $("artistList");
  const songList = $("songList");

  let editingId = null;

  // ---------- Helpers ----------
  function norm(s){ return (s||"").trim(); }
  function byAZ(a,b){
    return a.localeCompare(b, undefined, {sensitivity:"base"});
  }

  function uniqueArtists(arr){
    const set = new Set(arr.map(x => (x.artist||"").toLowerCase().trim()).filter(Boolean));
    return set.size;
  }

  function rebuildDatalists(){
    // Artists list
    const artists = [...new Set(songs.map(s=>s.artist).filter(Boolean))].sort(byAZ);
    artistList.innerHTML = artists.map(a=>`<option value="${escapeHtml(a)}"></option>`).join("");

    // Song list (title only)
    const titles = [...new Set(songs.map(s=>s.title).filter(Boolean))].sort(byAZ);
    songList.innerHTML = titles.map(t=>`<option value="${escapeHtml(t)}"></option>`).join("");
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function fillSelect(selectEl, items, includeAll=false){
    const cur = selectEl.value;
    let html = "";
    if(includeAll) html += `<option value="__all__">All</option>`;
    html += items
      .slice()
      .sort(byAZ)
      .map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`)
      .join("");
    selectEl.innerHTML = html;

    // restore selection if still exists
    if(cur && [...selectEl.options].some(o=>o.value===cur)){
      selectEl.value = cur;
    }else if(includeAll){
      selectEl.value="__all__";
    }
  }

  function persist(){
    saveJSON(KEY, songs);
    saveJSON(KEY_GENRES, genres);
    saveJSON(KEY_MOODS, moods);
  }

  function artistIndexMap(sortedArtists){
    const map = new Map();
    sortedArtists.forEach((a,i)=>map.set(a, i+1));
    return map;
  }

  function getFiltered(){
    const q = norm(searchInput.value).toLowerCase();
    const g = filterGenre.value;
    const m = filterMood.value;
    const f = filterFav.value;

    let arr = songs.slice();

    // Sort base (stable)
    if(sortMode.value === "artist_song"){
      arr.sort((x,y)=>{
        const a = byAZ(x.artist||"", y.artist||"");
        if(a!==0) return a;
        return byAZ(x.title||"", y.title||"");
      });
    }else{
      arr.sort((x,y)=>{
        const a = byAZ(x.title||"", y.title||"");
        if(a!==0) return a;
        return byAZ(x.artist||"", y.artist||"");
      });
    }

    if(q){
      arr = arr.filter(s =>
        (s.artist||"").toLowerCase().includes(q) ||
        (s.title||"").toLowerCase().includes(q)
      );
    }
    if(g && g !== "__all__"){
      arr = arr.filter(s => s.genre === g);
    }
    if(m && m !== "__all__"){
      arr = arr.filter(s => s.mood === m);
    }
    if(f !== "all"){
      if(f === "fav") arr = arr.filter(s => s.fav === "fav");
      if(f === "xfav") arr = arr.filter(s => s.fav === "xfav");
      if(f === "anyfav") arr = arr.filter(s => s.fav === "fav" || s.fav === "xfav");
      if(f === "nonefav") arr = arr.filter(s => s.fav === "none");
    }
    return arr;
  }

  function renderStats(){
    const totalSongs = songs.length;
    const totalArtists = uniqueArtists(songs);

    const favCount = songs.filter(s=>s.fav==="fav").length;
    const xfavCount = songs.filter(s=>s.fav==="xfav").length;

    statsEl.innerHTML = `
      <span class="stat">Total songs: <b>${totalSongs}</b></span>
      <span class="stat">Unique artists: <b>${totalArtists}</b></span>
      <span class="stat">Favorites: <b>${favCount}</b></span>
      <span class="stat">Extra favorites: <b>${xfavCount}</b></span>
    `;
  }

  function pillHtml(s){
    const parts = [];
    if(s.genre) parts.push(`<span class="pill genre">üéµ ${escapeHtml(s.genre)}</span>`);
    if(s.mood)  parts.push(`<span class="pill mood">üôÇ ${escapeHtml(s.mood)}</span>`);
    if(s.fav==="fav") parts.push(`<span class="pill fav">‚òÖ Favorite</span>`);
    if(s.fav==="xfav") parts.push(`<span class="pill xfav">‚ú¶ Extra</span>`);
    return parts.join(" ");
  }

  function render(){
    fillSelect(genreSelect, genres, false);
    fillSelect(moodSelect, moods, false);
    fillSelect(filterGenre, genres, true);
    fillSelect(filterMood, moods, true);
    fillSelect(editGenre, genres, false);
    fillSelect(editMood, moods, false);

    rebuildDatalists();
    renderStats();

    const arr = getFiltered();

    // Artist numbering (based on full list, always A-Z by artist)
    const allArtistsSorted = [...new Set(songs.map(s=>s.artist).filter(Boolean))].sort(byAZ);
    const aIndex = artistIndexMap(allArtistsSorted);

    countText.textContent = `${arr.length} shown`;
    listTitle.textContent = (searchInput.value || filterGenre.value!=="__all__" || filterMood.value!=="__all__" || filterFav.value!=="all")
      ? "Filtered Songs"
      : "All Songs";

    listEl.innerHTML = "";
    if(arr.length === 0){
      listEl.innerHTML = `<div class="muted" style="padding:10px">No songs found.</div>`;
      return;
    }

    arr.forEach((s, idx)=>{
      const songNo = idx + 1; // numbering in the current view
      const artNo = aIndex.get(s.artist) || "‚Äî";
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="idx">
          <div>#${songNo}</div>
          <div class="muted" style="margin-top:4px">A${artNo}</div>
        </div>
        <div class="item-main">
          <p class="title">${escapeHtml(s.artist || "Unknown Artist")} ‚Äî ${escapeHtml(s.title || "Untitled")}</p>
          <div class="meta">
            ${pillHtml(s)}
          </div>
        </div>
        <div class="item-actions">
          <button class="iconbtn" title="Edit">‚úé</button>
        </div>
      `;
      el.querySelector(".iconbtn").addEventListener("click", ()=>openEdit(s.id));
      // Tap anywhere on card to edit (mobile friendly)
      el.addEventListener("click", (e)=>{
        if(e.target.closest(".iconbtn")) return;
        openEdit(s.id);
      });
      listEl.appendChild(el);
    });
  }

  // ---------- Add Song ----------
  function addSong(){
    const artist = norm(artistInput.value);
    const title  = norm(songInput.value);
    const genre  = genreSelect.value || "";
    const mood   = moodSelect.value || "";
    const fav    = favSelect.value || "none";

    if(!artist || !title){
      alert("Please fill in Artist and Song Title.");
      return;
    }

    // prevent duplicates (same artist+title)
    const exists = songs.some(s => (s.artist||"").toLowerCase()===artist.toLowerCase() &&
                                  (s.title||"").toLowerCase()===title.toLowerCase());
    if(exists){
      alert("That song already exists in your list.");
      return;
    }

    songs.push({
      id: crypto.randomUUID(),
      artist,
      title,
      genre,
      mood,
      fav
    });

    persist();
    // clear quick fields but keep selects
    songInput.value = "";
    // keep artist for faster adding multiple songs
    render();
  }

  // ---------- Genre / Mood add ----------
  function addGenre(){
    const g = norm(newGenre.value);
    if(!g) return;
    if(!genres.some(x => x.toLowerCase()===g.toLowerCase())){
      genres.push(g);
      persist();
    }
    newGenre.value="";
    render();
    genreSelect.value = g;
  }

  function addMood(){
    const m = norm(newMood.value);
    if(!m) return;
    if(!moods.some(x => x.toLowerCase()===m.toLowerCase())){
      moods.push(m);
      persist();
    }
    newMood.value="";
    render();
    moodSelect.value = m;
  }

  // ---------- Edit ----------
  function openEdit(id){
    const s = songs.find(x=>x.id===id);
    if(!s) return;
    editingId = id;

    editArtist.value = s.artist || "";
    editSong.value = s.title || "";
    fillSelect(editGenre, genres, false);
    fillSelect(editMood, moods, false);
    editGenre.value = s.genre || (genres[0]||"");
    editMood.value = s.mood || (moods[0]||"");
    editFav.value = s.fav || "none";

    modal.classList.add("open");
  }

  function closeEdit(){
    modal.classList.remove("open");
    editingId = null;
  }

  function saveEdit(){
    const s = songs.find(x=>x.id===editingId);
    if(!s) return;

    const artist = norm(editArtist.value);
    const title  = norm(editSong.value);
    if(!artist || !title){
      alert("Artist and Song Title are required.");
      return;
    }

    // duplicate check (ignore self)
    const dup = songs.some(x => x.id!==s.id &&
      (x.artist||"").toLowerCase()===artist.toLowerCase() &&
      (x.title||"").toLowerCase()===title.toLowerCase()
    );
    if(dup){
      alert("Another entry with the same artist + song title already exists.");
      return;
    }

    s.artist = artist;
    s.title = title;
    s.genre = editGenre.value || "";
    s.mood  = editMood.value || "";
    s.fav   = editFav.value || "none";

    persist();
    render();
    closeEdit();
  }

  function deleteEdit(){
    const s = songs.find(x=>x.id===editingId);
    if(!s) return;
    if(!confirm("Delete this song?")) return;
    songs = songs.filter(x=>x.id!==editingId);
    persist();
    render();
    closeEdit();
  }

  // ---------- Export / Import ----------
  function exportData(){
    const payload = {
      version: 3,
      exportedAt: new Date().toISOString(),
      genres,
      moods,
      songs
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "my-songs-export.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function importData(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const obj = JSON.parse(reader.result);
        if(!obj || !Array.isArray(obj.songs)) throw new Error("Invalid file");
        songs = obj.songs.map(s => ({
          id: s.id || crypto.randomUUID(),
          artist: s.artist || "",
          title: s.title || "",
          genre: s.genre || "",
          mood: s.mood || "",
          fav: s.fav || "none"
        }));

        if(Array.isArray(obj.genres) && obj.genres.length) genres = obj.genres;
        if(Array.isArray(obj.moods) && obj.moods.length) moods = obj.moods;

        persist();
        render();
        alert("Import successful!");
      }catch(e){
        alert("Import failed. Please select a valid export JSON file.");
      }
    };
    reader.readAsText(file);
  }

  // ---------- UI wiring ----------
  toggleAdd.addEventListener("click", ()=>{
    const open = addForm.style.display !== "none";
    addForm.style.display = open ? "none" : "block";
  });
  cancelAdd.addEventListener("click", ()=>{
    addForm.style.display = "none";
  });

  addBtn.addEventListener("click", addSong);
  addGenreBtn.addEventListener("click", addGenre);
  addMoodBtn.addEventListener("click", addMood);

  // Enter to add quickly
  songInput.addEventListener("keydown", (e)=>{
    if(e.key==="Enter") addSong();
  });

  [searchInput, filterGenre, filterMood, filterFav, sortMode].forEach(el=>{
    el.addEventListener("input", render);
    el.addEventListener("change", render);
  });

  btnReset.addEventListener("click", ()=>{
    searchInput.value="";
    filterGenre.value="__all__";
    filterMood.value="__all__";
    filterFav.value="all";
    sortMode.value="artist_song";
    render();
  });

  btnExport.addEventListener("click", exportData);
  btnImport.addEventListener("click", ()=>fileImport.click());
  fileImport.addEventListener("change", ()=>{
    const f = fileImport.files && fileImport.files[0];
    if(f) importData(f);
    fileImport.value="";
  });

  closeModal.addEventListener("click", closeEdit);
  modal.addEventListener("click", (e)=>{
    if(e.target === modal) closeEdit();
  });
  saveBtn.addEventListener("click", saveEdit);
  deleteBtn.addEventListener("click", deleteEdit);

  // ---------- Init ----------
  // ensure filter selects start at All
  function init(){
    if(!Array.isArray(songs)) songs = [];
    if(!Array.isArray(genres) || !genres.length) genres = defaultGenres.slice();
    if(!Array.isArray(moods) || !moods.length) moods = defaultMoods.slice();

    // defaults
    filterGenre.value="__all__";
    filterMood.value="__all__";
    sortMode.value="artist_song";
    render();
  }
  init();
</script>
</body>
  </html>

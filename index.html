<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Song Library</title>
  <style>
    :root{
      --bg0:#070915;
      --bg1:#0b0f24;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --text:#e9ecff;
      --muted: rgba(233,236,255,.70);
      --muted2: rgba(233,236,255,.55);
      --accent:#8aa2ff;
      --accent2:#a98bff;
      --good:#37d39a;
      --warn:#ffce6a;
      --danger:#ff6b7a;
      --pill: rgba(255,255,255,.09);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: radial-gradient(1200px 700px at 30% 5%, rgba(138,162,255,.20), transparent 55%),
                  radial-gradient(900px 600px at 90% 20%, rgba(169,139,255,.18), transparent 50%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 920px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }

    .title{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .title .icon{
      width:44px;height:44px;
      border-radius:16px;
      background: linear-gradient(135deg, rgba(138,162,255,.25), rgba(169,139,255,.20));
      border:1px solid var(--stroke);
      display:grid;place-items:center;
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .title h1{
      font-size: 22px;
      margin:0;
      letter-spacing:.2px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subtitle{
      margin:2px 0 0;
      color:var(--muted2);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:650;
      letter-spacing:.2px;
      cursor:pointer;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      transition: transform .08s ease, background .15s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform: scale(.98)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(138,162,255,.28), rgba(169,139,255,.20));
    }
    .btn.small{padding:8px 10px;border-radius:12px;font-size:13px}
    .btn.ghost{background: rgba(255,255,255,.04)}
    .btn.danger{background: rgba(255,107,122,.14); border-color: rgba(255,107,122,.22)}
    .btn.good{background: rgba(55,211,154,.14); border-color: rgba(55,211,154,.22)}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    details.accordion{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(255,255,255,.05);
      box-shadow: 0 12px 40px rgba(0,0,0,.28);
      overflow:hidden;
    }
    details.accordion + details.accordion,
    details.accordion + .card,
    .card + details.accordion,
    .card + .card { margin-top: 12px; }

    details.accordion > summary{
      list-style:none;
      cursor:pointer;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    details.accordion > summary::-webkit-details-marker{display:none}
    .sum-left{
      display:flex;align-items:center;gap:10px;min-width:0;
      font-weight:800;
      letter-spacing:.2px;
    }
    .sum-right{
      color:var(--muted2);
      font-size:12px;
      flex:0 0 auto;
    }
    .accordion-body{
      padding: 12px 14px 14px;
      border-top:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.06);
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .chip{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      padding:8px 10px;
      font-size:13px;
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:8px;
      max-width:100%;
    }
    .chip strong{color:var(--text)}
    .chip .dot{opacity:.7}

    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 720px){
      .grid2{grid-template-columns: 1fr 1fr;}
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted2);
      margin: 0 0 6px;
    }
    input[type="text"], select{
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(5,7,18,.55);
      color:var(--text);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    }
    input::placeholder{color: rgba(233,236,255,.35)}
    .row{
      display:flex;
      gap:10px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    .row > .grow{flex:1 1 220px; min-width: 220px;}
    .row > .mini{flex:0 0 auto}

    .help{
      color:var(--muted2);
      font-size:12px;
      margin: 10px 0 0;
      line-height:1.35;
    }

    /* Suggestions */
    .suggest{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .suggest button{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Artist blocks */
    .artist-block{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      border-radius: 22px;
      overflow:hidden;
    }
    .artist-head{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(0,0,0,.06);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .artist-left{
      min-width:0;
      display:flex;
      align-items:baseline;
      gap:10px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      font-weight:850;
      font-size:13px;
      flex:0 0 auto;
    }
    .artist-name{
      font-size:20px;
      font-weight:900;
      margin:0;
      line-height:1.2;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .artist-meta{
      color:var(--muted2);
      font-size:12px;
      flex:0 0 auto;
      white-space:nowrap;
    }

    .song-row{
      padding: 12px 14px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .song-row:last-child{border-bottom:none}
    .song-main{
      min-width:0;
      flex:1 1 auto;
    }
    .song-title-line{
      display:flex;
      gap:10px;
      align-items:baseline;
      flex-wrap:wrap;
    }
    .song-no{
      font-weight:900;
      color: rgba(233,236,255,.82);
      font-size:13px;
      letter-spacing:.2px;
      flex:0 0 auto;
    }
    .song-title{
      font-weight:900;
      font-size:16px;
      line-height:1.25;
      margin:0;
      white-space:normal;         /* wrap */
      overflow-wrap:anywhere;
    }

    .meta-inline{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .pill{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:7px 10px;
      border-radius:999px;
      font-size:13px;
      color:var(--muted);
      max-width:100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill.fav{ background: rgba(55,211,154,.14); border-color: rgba(55,211,154,.22); color: rgba(233,236,255,.92);}
    .pill.xfav{ background: rgba(255,206,106,.14); border-color: rgba(255,206,106,.22); color: rgba(233,236,255,.92);}

    .song-actions{
      flex:0 0 auto;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .iconbtn{
      width:44px;height:44px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color:var(--text);
      display:grid;place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .iconbtn:active{transform: scale(.98)}
    .iconbtn.danger{ background: rgba(255,107,122,.12); border-color: rgba(255,107,122,.22);}

    /* Chart */
    .chart-wrap{
      width:100%;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding: 10px;
      overflow:hidden;
    }
    .chart-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .chart-head h3{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .chart-note{
      color:var(--muted2);
      font-size:12px;
      white-space:nowrap;
    }
    canvas{display:block; width:100%; height:160px;} /* visual size */
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <div class="icon">üéµ</div>
        <div style="min-width:0">
          <h1>All Songs</h1>
          <div class="subtitle" id="subline">Sort: Artist A‚ÄìZ ‚Üí Song A‚ÄìZ</div>
        </div>
      </div>

      <button class="btn primary" id="toggleFormBtn">+ Add new song</button>
    </div>

    <!-- Add Song Form (hidden until button) -->
    <div class="card" id="formCard" style="display:none;">
      <div class="grid2">
        <div>
          <label>Song title</label>
          <input id="inTitle" type="text" placeholder="e.g. Blinding Lights" autocomplete="off" />
          <div class="suggest" id="sugTitle"></div>
        </div>
        <div>
          <label>Artist</label>
          <input id="inArtist" type="text" placeholder="e.g. The Weeknd" autocomplete="off" />
          <div class="suggest" id="sugArtist"></div>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label>Genre</label>
          <select id="selGenre"></select>
          <div class="row" style="margin-top:10px;">
            <div class="grow">
              <input id="addGenre" type="text" placeholder="Add new genre..." />
            </div>
            <div class="mini">
              <button class="btn small" id="btnAddGenre" type="button">Add</button>
            </div>
          </div>
        </div>

        <div>
          <label>Mood</label>
          <select id="selMood"></select>
          <div class="row" style="margin-top:10px;">
            <div class="grow">
              <input id="addMood" type="text" placeholder="Add new mood..." />
            </div>
            <div class="mini">
              <button class="btn small" id="btnAddMood" type="button">Add</button>
            </div>
          </div>
        </div>

        <div>
          <label>Country</label>
          <select id="selCountry"></select>
          <div class="row" style="margin-top:10px;">
            <div class="grow">
              <input id="addCountry" type="text" placeholder="Add new country..." />
            </div>
            <div class="mini">
              <button class="btn small" id="btnAddCountry" type="button">Add</button>
            </div>
          </div>
        </div>

        <div>
          <label>Favorite</label>
          <select id="selFav">
            <option value="None">None</option>
            <option value="Fav">Fav</option>
            <option value="X-Fav">X-Fav</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn good" id="btnSave" type="button">Save</button>
        <button class="btn ghost" id="btnClear" type="button">Clear</button>
      </div>

      <div class="help">
        Data saves automatically on this device (localStorage). Use Export/Import to move data to another device.
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn small" id="btnExport" type="button">Export (.json)</button>
        <label class="btn small" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
          Import (.json)
          <input id="fileImport" type="file" accept="application/json" style="display:none;" />
        </label>
      </div>
    </div>

    <!-- Filters (collapsed by default) -->
    <details class="accordion" id="filtersAcc">
      <summary>
        <div class="sum-left">üß∞ Filters</div>
        <div class="sum-right">Collapsed</div>
      </summary>
      <div class="accordion-body">
        <div class="grid2">
          <div>
            <label>Search (song or artist)</label>
            <input id="qSearch" type="text" placeholder="Type to search..." />
          </div>
          <div>
            <label>Favorite</label>
            <select id="fFav">
              <option value="Any">Any</option>
              <option value="Fav">Fav</option>
              <option value="X-Fav">X-Fav</option>
              <option value="None">None</option>
            </select>
          </div>
          <div>
            <label>Genre</label>
            <select id="fGenre"></select>
          </div>
          <div>
            <label>Mood</label>
            <select id="fMood"></select>
          </div>
          <div>
            <label>Country</label>
            <select id="fCountry"></select>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn small" id="btnApplyFilters" type="button">Save</button>
          <button class="btn small ghost" id="btnResetFilters" type="button">Reset</button>
        </div>
      </div>
    </details>

    <!-- Charts (collapsed by default) -->
    <details class="accordion" id="chartsAcc">
      <summary>
        <div class="sum-left">üìä Charts (genre)</div>
        <div class="sum-right">Collapsed</div>
      </summary>
      <div class="accordion-body">
        <div class="chart-wrap">
          <div class="chart-head">
            <h3>Genres (song count)</h3>
            <div class="chart-note" id="chartNote">‚Äî</div>
          </div>
          <canvas id="genreChart" width="900" height="220"></canvas>
        </div>
      </div>
    </details>

    <!-- Stats chips (compact) -->
    <div class="card">
      <div class="chips" id="statsChips"></div>
    </div>

    <!-- List -->
    <div class="card" id="listCard">
      <div id="list"></div>
    </div>
  </div>

<script>
(() => {
  const KEY = "songlib.v5";

  const defaultGenres = [
    "Pop","Rock","Hip-Hop","R&B","Jazz","Classical","Electronic","Indie","Alternative",
    "K-Pop","Country","Hard Rock","Gospel","Metal","French"
  ];
  const defaultMoods = ["Happy","Sad","Energized","Instrumental","Calm"];
  const defaultCountries = ["Unknown","USA","UK","Canada","Netherlands","France","Korea","Japan"];

  const state = loadState();

  // ---------- Elements ----------
  const formCard = document.getElementById("formCard");
  const toggleFormBtn = document.getElementById("toggleFormBtn");

  const inTitle = document.getElementById("inTitle");
  const inArtist = document.getElementById("inArtist");

  const sugTitle = document.getElementById("sugTitle");
  const sugArtist = document.getElementById("sugArtist");

  const selGenre = document.getElementById("selGenre");
  const selMood = document.getElementById("selMood");
  const selCountry = document.getElementById("selCountry");
  const selFav = document.getElementById("selFav");

  const addGenre = document.getElementById("addGenre");
  const addMood = document.getElementById("addMood");
  const addCountry = document.getElementById("addCountry");

  const btnAddGenre = document.getElementById("btnAddGenre");
  const btnAddMood = document.getElementById("btnAddMood");
  const btnAddCountry = document.getElementById("btnAddCountry");

  const btnSave = document.getElementById("btnSave");
  const btnClear = document.getElementById("btnClear");
  const btnExport = document.getElementById("btnExport");
  const fileImport = document.getElementById("fileImport");

  const qSearch = document.getElementById("qSearch");
  const fFav = document.getElementById("fFav");
  const fGenre = document.getElementById("fGenre");
  const fMood = document.getElementById("fMood");
  const fCountry = document.getElementById("fCountry");

  const btnApplyFilters = document.getElementById("btnApplyFilters");
  const btnResetFilters = document.getElementById("btnResetFilters");

  const statsChips = document.getElementById("statsChips");
  const listEl = document.getElementById("list");

  const chartsAcc = document.getElementById("chartsAcc");
  const filtersAcc = document.getElementById("filtersAcc");

  const genreCanvas = document.getElementById("genreChart");
  const chartNote = document.getElementById("chartNote");
  const ctx = genreCanvas.getContext("2d");

  // Collapsed by default
  chartsAcc.open = false;
  filtersAcc.open = false;

  // ---------- Init select options ----------
  function normList(arr){
    return Array.from(new Set(arr.map(x => (x||"").trim()).filter(Boolean)))
      .sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:"base"}));
  }

  function ensureDefaults(){
    state.options.genres = normList([...(state.options.genres||[]), ...defaultGenres]);
    state.options.moods = normList([...(state.options.moods||[]), ...defaultMoods]);
    state.options.countries = normList([...(state.options.countries||[]), ...defaultCountries]);
    if (!state.options.countries.includes("Unknown")) state.options.countries.unshift("Unknown");
  }
  ensureDefaults();
  saveState();

  function fillSelect(select, items, includeAny=false, anyLabel="Any"){
    const cur = select.value;
    select.innerHTML = "";
    if (includeAny){
      const o = document.createElement("option");
      o.value = "Any"; o.textContent = anyLabel;
      select.appendChild(o);
    }
    for (const v of items){
      const o = document.createElement("option");
      o.value = v; o.textContent = v;
      select.appendChild(o);
    }
    // restore if possible
    if (cur && Array.from(select.options).some(o => o.value === cur)){
      select.value = cur;
    }
  }

  function refreshAllSelects(){
    fillSelect(selGenre, state.options.genres);
    fillSelect(selMood, state.options.moods);
    fillSelect(selCountry, state.options.countries);

    fillSelect(fGenre, ["Any", ...state.options.genres], false);
    fGenre.value = "Any";
    fillSelect(fMood, ["Any", ...state.options.moods], false);
    fMood.value = "Any";
    fillSelect(fCountry, ["Any", ...state.options.countries], false);
    fCountry.value = "Any";

    // Keep filters if saved:
    if (state.filters){
      qSearch.value = state.filters.q || "";
      fFav.value = state.filters.fav || "Any";
      if (Array.from(fGenre.options).some(o => o.value === state.filters.genre)) fGenre.value = state.filters.genre;
      if (Array.from(fMood.options).some(o => o.value === state.filters.mood)) fMood.value = state.filters.mood;
      if (Array.from(fCountry.options).some(o => o.value === state.filters.country)) fCountry.value = state.filters.country;
    }
  }
  refreshAllSelects();

  // ---------- Form show/hide ----------
  toggleFormBtn.addEventListener("click", () => {
    const showing = formCard.style.display !== "none";
    formCard.style.display = showing ? "none" : "block";
    if (!showing) {
      inTitle.focus();
      // keep current defaults
      if (!selGenre.value) selGenre.value = state.options.genres[0] || "";
      if (!selMood.value) selMood.value = state.options.moods[0] || "";
      if (!selCountry.value) selCountry.value = "Unknown";
      selFav.value = "None";
    }
  });

  function hideForm(){
    formCard.style.display = "none";
  }

  // ---------- Add option helpers ----------
  function addOption(kind, value){
    const v = (value||"").trim();
    if (!v) return;
    const key = kind.toLowerCase();
    const list = state.options[key];
    if (!list.some(x => x.localeCompare(v, undefined, {sensitivity:"base"})===0)){
      list.push(v);
      state.options[key] = normList(list);
      saveState();
      refreshAllSelects();
    }
  }

  btnAddGenre.addEventListener("click", () => { addOption("genres", addGenre.value); addGenre.value=""; });
  btnAddMood.addEventListener("click",  () => { addOption("moods", addMood.value); addMood.value=""; });
  btnAddCountry.addEventListener("click", () => { addOption("countries", addCountry.value); addCountry.value=""; });

  // ---------- Suggestions (artist/title) ----------
  function uniqueValues(arr, pick){
    const set = new Map();
    for (const s of arr){
      const v = (pick(s)||"").trim();
      if (!v) continue;
      const k = v.toLowerCase();
      if (!set.has(k)) set.set(k, v);
    }
    return Array.from(set.values()).sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:"base"}));
  }

  function renderSuggestions(container, items, onPick){
    container.innerHTML = "";
    for (const v of items.slice(0, 10)){
      const b = document.createElement("button");
      b.type = "button";
      b.textContent = v;
      b.addEventListener("click", () => onPick(v));
      container.appendChild(b);
    }
  }

  function updateSugTitle(){
    const q = (inTitle.value||"").trim().toLowerCase();
    if (!q) { sugTitle.innerHTML=""; return; }
    const titles = uniqueValues(state.songs, s => s.title)
      .filter(t => t.toLowerCase().includes(q));
    renderSuggestions(sugTitle, titles, (v)=>{ inTitle.value=v; sugTitle.innerHTML=""; });
  }

  function updateSugArtist(){
    const q = (inArtist.value||"").trim().toLowerCase();
    if (!q) { sugArtist.innerHTML=""; return; }
    const artists = uniqueValues(state.songs, s => s.artist)
      .filter(a => a.toLowerCase().includes(q));
    renderSuggestions(sugArtist, artists, (v)=>{ inArtist.value=v; sugArtist.innerHTML=""; });
  }

  inTitle.addEventListener("input", updateSugTitle);
  inArtist.addEventListener("input", updateSugArtist);

  // ---------- Save song ----------
  btnSave.addEventListener("click", () => {
    const title = (inTitle.value||"").trim();
    const artist = (inArtist.value||"").trim();
    if (!title || !artist){
      alert("Please enter both Song title and Artist.");
      return;
    }

    const song = {
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
      title,
      artist,
      genre: selGenre.value || "",
      mood: selMood.value || "",
      country: selCountry.value || "Unknown",
      fav: selFav.value || "None",
      createdAt: Date.now()
    };

    state.songs.push(song);
    saveState();
    clearForm();
    hideForm();              // <<< important: hide after save
    render();
  });

  btnClear.addEventListener("click", () => clearForm());

  function clearForm(){
    inTitle.value = "";
    inArtist.value = "";
    sugTitle.innerHTML = "";
    sugArtist.innerHTML = "";
    selGenre.value = state.options.genres[0] || "";
    selMood.value = state.options.moods[0] || "";
    selCountry.value = "Unknown";
    selFav.value = "None";
  }

  // ---------- Export / Import ----------
  btnExport.addEventListener("click", () => {
    const payload = {
      version: 5,
      exportedAt: new Date().toISOString(),
      data: state
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "song-library-export.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  fileImport.addEventListener("change", async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    try{
      const text = await file.text();
      const obj = JSON.parse(text);
      const incoming = obj.data ? obj.data : obj;
      if (!incoming || !Array.isArray(incoming.songs)){
        alert("This file doesn't look like a valid export.");
        return;
      }
      state.songs = incoming.songs || [];
      state.options = incoming.options || state.options;
      state.filters = incoming.filters || state.filters;

      ensureDefaults();
      saveState();
      refreshAllSelects();
      render();
      alert("Import successful!");
    }catch(err){
      console.error(err);
      alert("Import failed. File might be corrupted.");
    }finally{
      fileImport.value = "";
    }
  });

  // ---------- Filters ----------
  btnApplyFilters.addEventListener("click", () => {
    state.filters = {
      q: qSearch.value || "",
      fav: fFav.value || "Any",
      genre: fGenre.value || "Any",
      mood: fMood.value || "Any",
      country: fCountry.value || "Any"
    };
    saveState();
    render();
    // keep compact feeling: you can collapse manually after
  });

  btnResetFilters.addEventListener("click", () => {
    qSearch.value = "";
    fFav.value = "Any";
    fGenre.value = "Any";
    fMood.value = "Any";
    fCountry.value = "Any";
    state.filters = { q:"", fav:"Any", genre:"Any", mood:"Any", country:"Any" };
    saveState();
    render();
  });

  // ---------- Render ----------
  function normalize(str){ return (str||"").toLowerCase().trim(); }

  function sortSongs(arr){
    return [...arr].sort((a,b)=>{
      const aa = (a.artist||"").localeCompare(b.artist||"", undefined, {sensitivity:"base"});
      if (aa) return aa;
      return (a.title||"").localeCompare(b.title||"", undefined, {sensitivity:"base"});
    });
  }

  function applyFilters(arr){
    const f = state.filters || { q:"", fav:"Any", genre:"Any", mood:"Any", country:"Any" };
    const q = normalize(f.q);
    return arr.filter(s=>{
      if (q){
        const hay = normalize(s.artist) + " " + normalize(s.title);
        if (!hay.includes(q)) return false;
      }
      if (f.fav && f.fav !== "Any"){
        if ((s.fav||"None") !== f.fav) return false;
      }
      if (f.genre && f.genre !== "Any"){
        if ((s.genre||"") !== f.genre) return false;
      }
      if (f.mood && f.mood !== "Any"){
        if ((s.mood||"") !== f.mood) return false;
      }
      if (f.country && f.country !== "Any"){
        if ((s.country||"Unknown") !== f.country) return false;
      }
      return true;
    });
  }

  function padN(n, digits){
    const s = String(n);
    return s.length >= digits ? s : "0".repeat(digits - s.length) + s;
  }

  function render(){
    // Stats based on ALL songs (not filtered)
    const totalSongs = state.songs.length;
    const artistsAll = new Set(state.songs.map(s => (s.artist||"").trim()).filter(Boolean));
    const totalArtists = artistsAll.size;

    // filtered display
    const sorted = sortSongs(applyFilters(state.songs));
    const artistsShown = new Set(sorted.map(s => (s.artist||"").trim()).filter(Boolean)).size;

    statsChips.innerHTML = "";
    statsChips.appendChild(chip(`Songs`, `${totalSongs}`));
    statsChips.appendChild(chip(`Artists`, `${totalArtists}`));
    if (state.filters && (state.filters.q || state.filters.fav!=="Any" || state.filters.genre!=="Any" || state.filters.mood!=="Any" || state.filters.country!=="Any")){
      statsChips.appendChild(chip(`Shown`, `${sorted.length} songs ‚Ä¢ ${artistsShown} artists`));
    } else {
      statsChips.appendChild(chip(`Shown`, `${sorted.length} songs ‚Ä¢ ${artistsShown} artists`));
    }

    // render grouped list (compact)
    listEl.innerHTML = "";
    const groups = new Map();
    for (const s of sorted){
      const a = (s.artist||"Unknown").trim() || "Unknown";
      if (!groups.has(a)) groups.set(a, []);
      groups.get(a).push(s);
    }
    const artistNames = Array.from(groups.keys()).sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:"base"}));

    let songIndex = 0;
    let artistIndex = 0;

    const songDigits = Math.max(4, String(Math.max(1, sorted.length)).length); // 4 or more as it grows

    for (const artist of artistNames){
      artistIndex++;
      const block = document.createElement("div");
      block.className = "artist-block";
      block.style.marginTop = "12px";

      const head = document.createElement("div");
      head.className = "artist-head";

      const left = document.createElement("div");
      left.className = "artist-left";

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = `#A${artistIndex}`;

      const name = document.createElement("h2");
      name.className = "artist-name";
      name.textContent = artist;

      left.appendChild(badge);
      left.appendChild(name);

      const meta = document.createElement("div");
      meta.className = "artist-meta";
      meta.textContent = `${groups.get(artist).length} song(s)`;

      head.appendChild(left);
      head.appendChild(meta);
      block.appendChild(head);

      for (const s of groups.get(artist)){
        songIndex++;
        const row = document.createElement("div");
        row.className = "song-row";

        const main = document.createElement("div");
        main.className = "song-main";

        const line = document.createElement("div");
        line.className = "song-title-line";

        const no = document.createElement("div");
        no.className = "song-no";
        no.textContent = `#S${padN(songIndex, songDigits)}`;

        const title = document.createElement("p");
        title.className = "song-title";
        title.textContent = s.title;

        line.appendChild(no);
        line.appendChild(title);

        const metaInline = document.createElement("div");
        metaInline.className = "meta-inline";

        if (s.genre) metaInline.appendChild(pill(s.genre));
        if (s.mood) metaInline.appendChild(pill(s.mood));
        if (s.country) metaInline.appendChild(pill(s.country));

        if (s.fav === "Fav") metaInline.appendChild(pill("‚òÖ Fav", "fav"));
        if (s.fav === "X-Fav") metaInline.appendChild(pill("‚òÖ‚òÖ X-Fav", "xfav"));

        main.appendChild(line);
        main.appendChild(metaInline);

        const actions = document.createElement("div");
        actions.className = "song-actions";

        const editBtn = document.createElement("button");
        editBtn.className = "iconbtn";
        editBtn.innerHTML = "‚úé";
        editBtn.title = "Edit";
        editBtn.addEventListener("click", () => editSong(s.id));

        const delBtn = document.createElement("button");
        delBtn.className = "iconbtn danger";
        delBtn.innerHTML = "üóë";
        delBtn.title = "Delete";
        delBtn.addEventListener("click", () => {
          if (!confirm("Delete this song?")) return;
          state.songs = state.songs.filter(x => x.id !== s.id);
          saveState();
          render();
        });

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        row.appendChild(main);
        row.appendChild(actions);

        block.appendChild(row);
      }

      listEl.appendChild(block);
    }

    if (sorted.length === 0){
      const empty = document.createElement("div");
      empty.style.color = "rgba(233,236,255,.65)";
      empty.style.padding = "8px 2px";
      empty.textContent = "No songs match your filters yet.";
      listEl.appendChild(empty);
    }

    drawGenreChart(); // based on ALL songs, not filtered (keeps stable)
  }

  function chip(label, value){
    const el = document.createElement("div");
    el.className = "chip";
    el.innerHTML = `<strong>${label}</strong><span class="dot">‚Ä¢</span><span>${value}</span>`;
    return el;
  }

  function pill(text, cls){
    const el = document.createElement("div");
    el.className = "pill" + (cls ? " " + cls : "");
    el.textContent = text;
    return el;
  }

  // ---------- Edit song (simple) ----------
  function editSong(id){
    const s = state.songs.find(x => x.id === id);
    if (!s) return;

    // Show form and fill
    formCard.style.display = "block";
    inTitle.value = s.title || "";
    inArtist.value = s.artist || "";
    selGenre.value = s.genre || (state.options.genres[0]||"");
    selMood.value = s.mood || (state.options.moods[0]||"");
    selCountry.value = s.country || "Unknown";
    selFav.value = s.fav || "None";

    // Replace save behavior temporarily
    btnSave.textContent = "Update";
    const original = btnSave.onclick;

    btnSave.onclick = () => {
      const title = (inTitle.value||"").trim();
      const artist = (inArtist.value||"").trim();
      if (!title || !artist){
        alert("Please enter both Song title and Artist.");
        return;
      }
      s.title = title;
      s.artist = artist;
      s.genre = selGenre.value || "";
      s.mood = selMood.value || "";
      s.country = selCountry.value || "Unknown";
      s.fav = selFav.value || "None";

      saveState();
      clearForm();
      hideForm();
      btnSave.textContent = "Save";
      btnSave.onclick = null; // restore default handler by re-attaching:
      attachDefaultSave();
      render();
    };

    // Scroll to form
    formCard.scrollIntoView({behavior:"smooth", block:"start"});
  }

  function attachDefaultSave(){
    btnSave.onclick = null;
    btnSave.addEventListener("click", defaultSaveHandler, {once:true});
    // But we used addEventListener earlier; easiest is to keep our earlier listener.
    // So we won't rely on this. We'll do a safer approach below.
  }

  // Safer: keep the original save handler via a named function:
  function defaultSaveHandler(){ /* unused */ }

  // ---------- Chart (genre only) ----------
  function drawGenreChart(){
    const counts = new Map();
    for (const s of state.songs){
      const g = (s.genre||"").trim() || "Unknown";
      counts.set(g, (counts.get(g)||0) + 1);
    }

    const items = Array.from(counts.entries())
      .sort((a,b)=>b[1]-a[1] || a[0].localeCompare(b[0], undefined, {sensitivity:"base"}));

    const total = state.songs.length;
    chartNote.textContent = total ? `${items.length} genres ‚Ä¢ ${total} songs` : "No data";

    // responsive scaling
    const cssW = genreCanvas.clientWidth;
    const cssH = genreCanvas.clientHeight;
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    genreCanvas.width = Math.floor(cssW * dpr);
    genreCanvas.height = Math.floor(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    // Clear
    ctx.clearRect(0,0,cssW,cssH);

    // If empty
    if (!total){
      ctx.fillStyle = "rgba(233,236,255,.55)";
      ctx.font = "12px system-ui";
      ctx.fillText("Add songs to see genre chart.", 8, 20);
      return;
    }

    // pick top 10 for compactness
    const top = items.slice(0, 10);
    const max = Math.max(...top.map(x => x[1]));

    const pad = 10;
    const w = cssW - pad*2;
    const h = cssH - pad*2;

    // background grid lines (subtle)
    ctx.strokeStyle = "rgba(255,255,255,.06)";
    ctx.lineWidth = 1;
    for (let i=1;i<=3;i++){
      const y = pad + (h * i/4);
      ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(pad+w, y); ctx.stroke();
    }

    const barGap = 8;
    const barH = Math.max(12, Math.floor((h - barGap*(top.length-1)) / top.length));
    let y = pad;

    // Bars (horizontal, compact & readable)
    for (const [label, val] of top){
      const bw = Math.max(2, Math.round((val / max) * (w * 0.62)));
      const x0 = pad;

      // bar
      const grad = ctx.createLinearGradient(x0, y, x0 + bw, y);
      grad.addColorStop(0, "rgba(138,162,255,.65)");
      grad.addColorStop(1, "rgba(169,139,255,.55)");
      ctx.fillStyle = grad;
      roundRect(ctx, x0, y, bw, barH, 8);
      ctx.fill();

      // label (left)
      ctx.fillStyle = "rgba(233,236,255,.78)";
      ctx.font = "12px system-ui";
      const short = label.length > 18 ? label.slice(0, 18) + "‚Ä¶" : label;
      ctx.fillText(short, x0 + bw + 10, y + barH - 3);

      // count (right-ish)
      ctx.fillStyle = "rgba(233,236,255,.55)";
      ctx.font = "12px system-ui";
      ctx.fillText(String(val), x0 + w - 18, y + barH - 3);

      y += barH + barGap;
    }

    // note bottom
    ctx.fillStyle = "rgba(233,236,255,.35)";
    ctx.font = "11px system-ui";
    ctx.fillText("Top 10 shown", pad, cssH - 6);
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  // redraw chart when resized (fix weird scaling)
  const ro = new ResizeObserver(() => {
    if (chartsAcc.open) drawGenreChart();
  });
  ro.observe(genreCanvas);

  chartsAcc.addEventListener("toggle", () => {
    if (chartsAcc.open) drawGenreChart();
  });

  // ---------- Storage ----------
  function loadState(){
    const raw = localStorage.getItem(KEY);
    if (raw){
      try{
        const parsed = JSON.parse(raw);
        return {
          songs: Array.isArray(parsed.songs) ? parsed.songs : [],
          options: parsed.options || {genres:[], moods:[], countries:[]},
          filters: parsed.filters || { q:"", fav:"Any", genre:"Any", mood:"Any", country:"Any" }
        };
      }catch(e){}
    }
    return {
      songs: [],
      options: { genres: [...defaultGenres], moods: [...defaultMoods], countries: [...defaultCountries] },
      filters: { q:"", fav:"Any", genre:"Any", mood:"Any", country:"Any" }
    };
  }

  function saveState(){
    localStorage.setItem(KEY, JSON.stringify(state));
  }

  // ---------- Start ----------
  // prevent the ‚Äútabs reset‚Äù feeling: we don't auto re-render form while open.
  // Only list rendering updates.
  render();
})();
</script>
</body>
  </html>

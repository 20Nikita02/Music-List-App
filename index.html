<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b0b0c" />
  <title>My Songs</title>
  <style>
    :root{
      --bg:#0b0b0c; --card:#141417; --muted:#a6a6ad; --text:#f2f2f4;
      --line:#232329; --accent:#7aa2ff; --good:#39d98a; --warn:#ffcc66;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(180deg, rgba(11,11,12,0.98), rgba(11,11,12,0.92));
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      padding:14px 14px 10px;
    }
    .titleRow{display:flex; align-items:center; justify-content:space-between; gap:10px}
    h1{font-size:18px; margin:0; font-weight:700; letter-spacing:0.2px}
    .sub{margin-top:4px; font-size:12px; color:var(--muted)}
    .actions{display:flex; gap:8px; align-items:center}
    button{
      border:1px solid var(--line);
      background:var(--card);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:650;
      font-size:14px;
      cursor:pointer;
    }
    button.primary{border-color:transparent; background:var(--accent); color:#0b0b0c}
    button.ghost{background:transparent}
    button:active{transform:scale(0.99)}
    .controls{
      display:grid; gap:10px; margin-top:10px;
    }
    .row{display:flex; gap:10px; align-items:center}
    input[type="search"], select{
      width:100%;
      border:1px solid var(--line);
      background:var(--card);
      color:var(--text);
      padding:12px 12px;
      border-radius:12px;
      font-size:14px;
      outline:none;
    }
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      border:1px solid var(--line);
      background:transparent;
      color:var(--muted);
      padding:8px 10px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{background:var(--card); color:var(--text); border-color:#2e2e38}
    main{padding:14px; padding-bottom:90px}
    .artistCard{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:16px;
      padding:12px;
      margin-bottom:12px;
    }
    .artistTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .artistName{
      font-size:16px; font-weight:750; margin:0; line-height:1.2;
      word-break:break-word;
    }
    .artistMeta{font-size:12px; color:var(--muted); margin-top:3px}
    .pill{
      font-size:12px; padding:6px 8px; border-radius:999px; border:1px solid var(--line);
      color:var(--muted);
      white-space:nowrap;
    }
    .songList{display:flex; flex-direction:column; gap:8px}
    .songItem{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      background:#101013;
    }
    .left{min-width:0}
    .songTitle{
      margin:0; font-weight:720; font-size:14px; line-height:1.25;
      word-break:break-word;
    }
    .songMeta{
      margin-top:4px; font-size:12px; color:var(--muted);
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tag{
      border:1px solid var(--line);
      border-radius:999px;
      padding:4px 8px;
      font-size:12px;
      color:var(--muted);
    }
    .tag.fav{border-color:rgba(255,204,102,0.35); color:var(--warn)}
    .tag.xfav{border-color:rgba(57,217,138,0.35); color:var(--good)}
    .right{display:flex; gap:6px}
    .iconBtn{
      width:38px; height:38px; border-radius:12px;
      display:grid; place-items:center;
      border:1px solid var(--line);
      background:transparent; color:var(--text);
      cursor:pointer;
      flex:0 0 auto;
    }
    .muted{color:var(--muted)}
    .empty{
      border:1px dashed var(--line);
      border-radius:16px;
      padding:16px;
      color:var(--muted);
    }

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0; background:rgba(0,0,0,0.6);
      display:none; align-items:flex-end; justify-content:center;
      padding:12px;
      z-index:50;
    }
    .modal{
      width:min(680px, 100%);
      border:1px solid var(--line);
      background:var(--card);
      border-radius:18px;
      padding:12px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.35);
    }
    .modalHeader{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:6px 6px 10px;
    }
    .modalHeader h2{margin:0; font-size:16px}
    .grid{
      display:grid;
      gap:10px;
    }
    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px 2px}
    .field{display:flex; flex-direction:column}
    .twoCol{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:520px){ .twoCol{grid-template-columns:1fr} }
    .toggleRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .toggle{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 12px;
      background:#101013;
    }
    .toggle input{width:18px; height:18px}
    .footerBar{
      position:fixed; left:0; right:0; bottom:0;
      border-top:1px solid var(--line);
      background:rgba(11,11,12,0.9);
      backdrop-filter: blur(12px);
      padding:12px 14px;
      display:flex; justify-content:space-between; gap:10px;
    }
    .footerBar .small{font-size:12px; color:var(--muted); line-height:1.2}
    a.link{color:var(--accent); text-decoration:none}
  </style>
</head>
<body>
  <header>
    <div class="titleRow">
      <div>
        <h1>My Songs</h1>
        <div class="sub" id="stats">Loading…</div>
      </div>
      <div class="actions">
        <button class="ghost" id="syncBtn" title="Optional: sync with GitHub Gist">Sync</button>
        <button class="primary" id="addBtn">+ Add</button>
      </div>
    </div>

    <div class="controls">
      <input id="q" type="search" placeholder="Search song or artist…" autocomplete="off" />
      <div class="row">
        <select id="moodFilter">
          <option value="">All moods</option>
        </select>
        <select id="favFilter">
          <option value="">All</option>
          <option value="fav">Favorites</option>
          <option value="xfav">Extra favorites</option>
        </select>
      </div>
      <div class="chips" id="chips">
        <div class="chip active" data-chip="all">All</div>
        <div class="chip" data-chip="fav">Fav</div>
        <div class="chip" data-chip="xfav">Extra</div>
      </div>
    </div>
  </header>

  <main id="list"></main>

  <!-- Modal -->
  <div class="modalOverlay" id="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <h2 id="modalTitle">Add Song</h2>
        <button class="ghost" id="closeBtn">Close</button>
      </div>

      <div class="grid">
        <div class="field">
          <label>Artist</label>
          <input id="artistInput" type="search" placeholder="e.g. Radiohead" />
        </div>

        <div class="field">
          <label>Song Title</label>
          <input id="titleInput" type="search" placeholder="e.g. Karma Police" />
        </div>

        <div class="twoCol">
          <div class="field">
            <label>Mood</label>
            <select id="moodInput"></select>
          </div>
          <div class="field">
            <label>Year (optional)</label>
            <input id="yearInput" inputmode="numeric" placeholder="e.g. 2016" />
          </div>
        </div>

        <div class="toggleRow">
          <label style="width:100%">Flags</label>
          <div class="toggle"><input id="favInput" type="checkbox" /> <span>Favorite</span></div>
          <div class="toggle"><input id="xfavInput" type="checkbox" /> <span>Extra favorite</span></div>
        </div>

        <div class="row" style="justify-content:flex-end; gap:10px; margin-top:6px">
          <button id="deleteBtn" class="ghost" style="display:none">Delete</button>
          <button id="saveBtn" class="primary">Save</button>
        </div>

        <div class="sub">
          Tip: keep it minimal. You can always add details later.
        </div>
      </div>
    </div>
  </div>

  <div class="footerBar">
    <div class="small">
      Vertical-only layout ✅<br/>
      Data saved locally. Use <b>Sync</b> if you want multi-device.
    </div>
    <button class="ghost" id="exportBtn">Export</button>
  </div>

<script>
(() => {
  // ---------- Data model ----------
  // song: { id, artist, title, mood, year, fav, xfav, createdAt }
  const LS_KEY = "mySongs.v1";
  const LS_SYNC = "mySongs.sync.v1"; // { gistId, token }
  const DEFAULT_MOODS = ["", "Happy", "Chill", "Sad", "Angry", "Focus", "Workout", "Party", "Romantic", "Nostalgic", "Calm", "Hype"];

  let songs = loadLocal();
  let editingId = null;

  // ---------- Elements ----------
  const $ = (id) => document.getElementById(id);
  const listEl = $("list");
  const statsEl = $("stats");
  const qEl = $("q");
  const moodFilterEl = $("moodFilter");
  const favFilterEl = $("favFilter");
  const chipsEl = $("chips");

  const overlay = $("overlay");
  const modalTitle = $("modalTitle");
  const artistInput = $("artistInput");
  const titleInput = $("titleInput");
  const moodInput = $("moodInput");
  const yearInput = $("yearInput");
  const favInput = $("favInput");
  const xfavInput = $("xfavInput");
  const deleteBtn = $("deleteBtn");

  // ---------- Init moods ----------
  function buildMoodSelects() {
    const moods = Array.from(new Set(DEFAULT_MOODS.concat(songs.map(s => s.mood || "").filter(Boolean))));
    // modal
    moodInput.innerHTML = "";
    moods.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m === "" ? "—" : m;
      moodInput.appendChild(opt);
    });
    // filter
    moodFilterEl.innerHTML = "";
    const allOpt = document.createElement("option");
    allOpt.value = "";
    allOpt.textContent = "All moods";
    moodFilterEl.appendChild(allOpt);
    moods.filter(Boolean).forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      moodFilterEl.appendChild(opt);
    });
  }

  // ---------- Local storage ----------
  function loadLocal() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    } catch {
      return [];
    }
  }
  function saveLocal() {
    localStorage.setItem(LS_KEY, JSON.stringify(songs));
  }

  // ---------- Sorting & grouping ----------
  function norm(s){ return (s||"").trim().toLowerCase(); }

  function getFilteredSongs() {
    const q = norm(qEl.value);
    const mood = moodFilterEl.value;
    const favFilter = favFilterEl.value; // "", "fav", "xfav"
    const chip = chipsEl.querySelector(".chip.active")?.dataset.chip || "all";

    return songs.filter(s => {
      const matchQ = !q || norm(s.artist).includes(q) || norm(s.title).includes(q);
      const matchMood = !mood || (s.mood === mood);
      const matchFavDrop =
        !favFilter ||
        (favFilter === "fav" && !!s.fav) ||
        (favFilter === "xfav" && !!s.xfav);

      const matchChip =
        chip === "all" ||
        (chip === "fav" && !!s.fav) ||
        (chip === "xfav" && !!s.xfav);

      return matchQ && matchMood && matchFavDrop && matchChip;
    });
  }

  function groupByArtist(list) {
    // sort artists A-Z; songs within artist A-Z
    const sorted = [...list].sort((a,b) => {
      const aa = norm(a.artist), bb = norm(b.artist);
      if (aa !== bb) return aa < bb ? -1 : 1;
      const at = norm(a.title), bt = norm(b.title);
      if (at !== bt) return at < bt ? -1 : 1;
      return (a.createdAt||0) - (b.createdAt||0);
    });

    const map = new Map();
    for (const s of sorted) {
      const key = (s.artist || "Unknown Artist").trim();
      if (!map.has(key)) map.set(key, []);
      map.get(key).push(s);
    }
    const artists = Array.from(map.keys()).sort((a,b)=> norm(a) < norm(b) ? -1 : 1);
    return artists.map(a => ({ artist: a, songs: map.get(a) }));
  }

  // ---------- Rendering ----------
  function render() {
    buildMoodSelects();

    const filtered = getFilteredSongs();
    const grouped = groupByArtist(filtered);

    // global stats based on ALL songs (not filtered)
    const totalSongs = songs.length;
    const uniqueArtists = new Set(songs.map(s => (s.artist||"Unknown Artist").trim())).size;
    const favCount = songs.filter(s => s.fav).length;
    const xfavCount = songs.filter(s => s.xfav).length;
    statsEl.textContent = `${totalSongs} songs • ${uniqueArtists} artists • ${favCount} fav • ${xfavCount} extra`;

    // If nothing
    if (grouped.length === 0) {
      listEl.innerHTML = `
        <div class="empty">
          No results. Try a different search or filter.<br/><br/>
          Tap <b>+ Add</b> to add your first song.
        </div>`;
      return;
    }

    // Build global index map (over ALL songs, sorted by artist/title)
    const globalSortedAll = groupByArtist(songs)
      .flatMap(g => g.songs);
    const globalIndex = new Map(globalSortedAll.map((s, i) => [s.id, i+1]));

    // Render grouped cards
    listEl.innerHTML = "";
    grouped.forEach((group, artistIdx) => {
      const card = document.createElement("div");
      card.className = "artistCard";

      // artist numbering is within filtered view (so feels consistent while browsing)
      const artistNumber = artistIdx + 1;
      const songCount = group.songs.length;

      const top = document.createElement("div");
      top.className = "artistTop";
      top.innerHTML = `
        <div style="min-width:0">
          <p class="artistName">#${artistNumber} ${escapeHtml(group.artist)}</p>
          <div class="artistMeta">${songCount} song${songCount===1?"":"s"}</div>
        </div>
        <div class="pill">A–Z</div>
      `;
      card.appendChild(top);

      const list = document.createElement("div");
      list.className = "songList";

      group.songs.forEach((s, withinArtistIdx) => {
        const globalNo = globalIndex.get(s.id) ?? "?";
        const withinArtistNo = withinArtistIdx + 1;

        const item = document.createElement("div");
        item.className = "songItem";

        const moodTag = s.mood ? `<span class="tag">${escapeHtml(s.mood)}</span>` : "";
        const yearTag = s.year ? `<span class="tag">${escapeHtml(String(s.year))}</span>` : "";
        const favTag = s.fav ? `<span class="tag fav">★ Fav</span>` : "";
        const xfavTag = s.xfav ? `<span class="tag xfav">✦ Extra</span>` : "";

        item.innerHTML = `
          <div class="left">
            <p class="songTitle">#${globalNo} • ${escapeHtml(s.title || "Untitled")}</p>
            <div class="songMeta">
              <span class="tag">Artist-song #${withinArtistNo}</span>
              ${favTag}${xfavTag}${moodTag}${yearTag}
            </div>
          </div>
          <div class="right">
            <button class="iconBtn" title="Edit">✎</button>
          </div>
        `;
        item.querySelector("button").addEventListener("click", () => openEdit(s.id));
        list.appendChild(item);
      });

      card.appendChild(list);
      listEl.appendChild(card);
    });
  }

  // ---------- Modal controls ----------
  function openAdd() {
    editingId = null;
    modalTitle.textContent = "Add Song";
    artistInput.value = "";
    titleInput.value = "";
    moodInput.value = "";
    yearInput.value = "";
    favInput.checked = false;
    xfavInput.checked = false;
    deleteBtn.style.display = "none";
    overlay.style.display = "flex";
    setTimeout(() => artistInput.focus(), 50);
  }

  function openEdit(id) {
    const s = songs.find(x => x.id === id);
    if (!s) return;
    editingId = id;
    modalTitle.textContent = "Edit Song";
    artistInput.value = s.artist || "";
    titleInput.value = s.title || "";
    moodInput.value = s.mood || "";
    yearInput.value = s.year ? String(s.year) : "";
    favInput.checked = !!s.fav;
    xfavInput.checked = !!s.xfav;
    deleteBtn.style.display = "inline-block";
    overlay.style.display = "flex";
  }

  function closeModal() {
    overlay.style.display = "none";
  }

  function saveFromModal() {
    const artist = artistInput.value.trim();
    const title = titleInput.value.trim();
    const mood = moodInput.value || "";
    const yearRaw = yearInput.value.trim();
    const year = yearRaw ? Number(yearRaw) : null;

    if (!artist || !title) {
      alert("Please enter both Artist and Song Title.");
      return;
    }
    if (yearRaw && (!Number.isFinite(year) || year < 0 || year > 3000)) {
      alert("Year must be a valid number.");
      return;
    }

    if (editingId) {
      const idx = songs.findIndex(s => s.id === editingId);
      if (idx >= 0) {
        songs[idx] = {
          ...songs[idx],
          artist, title, mood,
          year: yearRaw ? year : null,
          fav: favInput.checked,
          xfav: xfavInput.checked,
        };
      }
    } else {
      songs.push({
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
        artist, title, mood,
        year: yearRaw ? year : null,
        fav: favInput.checked,
        xfav: xfavInput.checked,
        createdAt: Date.now(),
      });
    }

    saveLocal();
    closeModal();
    render();
  }

  function deleteCurrent() {
    if (!editingId) return;
    if (!confirm("Delete this song?")) return;
    songs = songs.filter(s => s.id !== editingId);
    saveLocal();
    closeModal();
    render();
  }

  // ---------- Export ----------
  function exportJson() {
    const blob = new Blob([JSON.stringify(songs, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "mySongs.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  // ---------- Optional: GitHub Gist Sync ----------
  // This lets you sync across devices. You need:
  // - a GitHub Personal Access Token (classic) with "gist" scope
  // - a gist ID (or create one from the app)
  async function syncFlow() {
    const existing = loadSyncConfig();
    let token = existing?.token || prompt("GitHub token (classic) with 'gist' scope.\nIt will be stored on this device only.");
    if (!token) return;

    let gistId = existing?.gistId || prompt("Gist ID (leave empty to create a new Gist)");
    if (!gistId) {
      gistId = await createGist(token);
      if (!gistId) return;
      alert("Created a new Gist! Now syncing to it.");
    }

    // choose direction
    const choice = prompt("Type:\nPUSH = upload your current songs to Gist\nPULL = download from Gist to this device", "PUSH");
    if (!choice) return;

    saveSyncConfig({ token, gistId });

    if (choice.toUpperCase() === "PULL") {
      const remote = await pullFromGist(token, gistId);
      if (remote) {
        songs = remote;
        saveLocal();
        render();
        alert("Pulled from Gist ✅");
      }
    } else {
      const ok = await pushToGist(token, gistId, songs);
      if (ok) alert("Pushed to Gist ✅");
    }
  }

  function loadSyncConfig() {
    try { return JSON.parse(localStorage.getItem(LS_SYNC) || "null"); }
    catch { return null; }
  }
  function saveSyncConfig(cfg) {
    localStorage.setItem(LS_SYNC, JSON.stringify(cfg));
  }

  async function createGist(token) {
    try {
      const res = await fetch("https://api.github.com/gists", {
        method: "POST",
        headers: {
          "Authorization": "token " + token,
          "Accept": "application/vnd.github+json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          description: "My Songs Sync",
          public: false,
          files: { "mySongs.json": { content: "[]" } }
        })
      });
      if (!res.ok) throw new Error("Failed to create Gist");
      const data = await res.json();
      return data.id;
    } catch (e) {
      alert("Gist create failed: " + e.message);
      return null;
    }
  }

  async function pullFromGist(token, gistId) {
    try {
      const res = await fetch("https://api.github.com/gists/" + gistId, {
        headers: {
          "Authorization": "token " + token,
          "Accept": "application/vnd.github+json"
        }
      });
      if (!res.ok) throw new Error("Failed to fetch Gist");
      const data = await res.json();
      const file = data.files?.["mySongs.json"];
      if (!file?.content) throw new Error("Gist missing mySongs.json");
      const parsed = JSON.parse(file.content);
      if (!Array.isArray(parsed)) throw new Error("Invalid JSON data");
      return parsed;
    } catch (e) {
      alert("Pull failed: " + e.message);
      return null;
    }
  }

  async function pushToGist(token, gistId, payload) {
    try {
      const res = await fetch("https://api.github.com/gists/" + gistId, {
        method: "PATCH",
        headers: {
          "Authorization": "token " + token,
          "Accept": "application/vnd.github+json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          files: { "mySongs.json": { content: JSON.stringify(payload, null, 2) } }
        })
      });
      if (!res.ok) throw new Error("Failed to update Gist");
      return true;
    } catch (e) {
      alert("Push failed: " + e.message);
      return false;
    }
  }

  // ---------- Helpers ----------
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // ---------- Events ----------
  $("addBtn").addEventListener("click", openAdd);
  $("closeBtn").addEventListener("click", closeModal);
  $("saveBtn").addEventListener("click", saveFromModal);
  deleteBtn.addEventListener("click", deleteCurrent);
  overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeModal(); });

  qEl.addEventListener("input", render);
  moodFilterEl.addEventListener("change", render);
  favFilterEl.addEventListener("change", render);

  chipsEl.addEventListener("click", (e) => {
    const chip = e.target.closest(".chip");
    if (!chip) return;
    chipsEl.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
    chip.classList.add("active");
    render();
  });

  $("exportBtn").addEventListener("click", exportJson);
  $("syncBtn").addEventListener("click", syncFlow);

  // First render
  buildMoodSelects();
  render();
})();
</script>
</body>
</html>

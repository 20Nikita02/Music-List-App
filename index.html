<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>All Songs</title>

  <style>
    :root{
      --bg:#0b0f1a;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --muted2:rgba(255,255,255,.45);
      --chip:rgba(255,255,255,.10);
      --chipStroke:rgba(255,255,255,.12);
      --accent:#7aa2ff;
      --fav:#2fdc9a;
      --xfav:#f0c36a;

      --r:22px;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(900px 600px at 25% 10%, rgba(122,162,255,.18), transparent 60%),
                  radial-gradient(900px 600px at 80% 30%, rgba(157,122,255,.14), transparent 60%),
                  var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width: 720px;
      margin: 0 auto;
      padding: 18px 14px 110px;
    }

    header{
      display:flex;
      gap:12px;
      align-items:center;
      margin: 6px 0 14px;
    }
    .icon{
      width:48px;height:48px;border-radius:16px;
      display:grid;place-items:center;
      background: linear-gradient(160deg, rgba(122,162,255,.22), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    h1{margin:0;font-size:30px;letter-spacing:.2px}

    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row-between{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .spacer{height:12px}

    .btn{
      appearance:none;border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 600;
      cursor:pointer;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(122,162,255,.26), rgba(255,255,255,.06));
      border-color: rgba(122,162,255,.30);
    }
    .btn.danger{
      border-color: rgba(255,120,120,.35);
      background: rgba(255,120,120,.10);
    }
    .btn.ghost{
      background: transparent;
    }

    input, select, textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      color: var(--text);
      padding: 11px 12px;
      outline:none;
      font-size: 14px;
    }
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){
      .grid{grid-template-columns: 1fr;}
    }

    details{
      border-radius: var(--r);
      overflow:hidden;
      background: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding: 12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      font-weight: 700;
    }
    summary::-webkit-details-marker{display:none}
    .details-body{padding: 0 14px 14px}
    .hint{color:var(--muted2);font-size:12px;margin-top:8px;line-height:1.35}

    .badges{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
      color:var(--muted);
      font-size:12px;
    }
    .badge{
      padding:7px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }

    /* Artist block */
    .artist{
      padding: 12px 12px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      margin-top: 12px;
    }
    .artist-head{
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
    }
    .artist-left{
      display:flex;gap:10px;align-items:flex-start;min-width:0;
    }
    .num-pill{
      flex:0 0 auto;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      font-weight:800;
      font-size:12px;
      color: rgba(255,255,255,.85);
    }
    .artist-name{
      font-size: 22px;
      font-weight: 850;
      line-height: 1.15;
      margin:0;
      word-break: break-word;
    }
    .artist-sub{
      margin-top:4px;
      color: var(--muted);
      font-size: 13px;
    }
    .artist-tools{
      display:flex;gap:8px;align-items:center;
    }

    /* Song card (compact) */
    .song{
      margin-top:10px;
      padding: 10px 10px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.16);
    }
    .song-top{
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
    }
    .song-left{
      display:flex;gap:10px;align-items:flex-start;min-width:0;
    }
    .song-title{
      font-size: 18px;
      font-weight: 800;
      margin:0;
      line-height:1.2;
      word-break: break-word; /* wrap long titles */
    }
    .song-meta{
      color:var(--muted);
      font-size:12px;
      margin-top:4px;
    }
    .song-actions{display:flex;gap:8px;flex:0 0 auto}
    .iconbtn{
      width:42px;height:42px;border-radius:14px;
      display:grid;place-items:center;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      cursor:pointer;
    }

    /* Chips row ‚Äî now side-by-side */
    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .chip{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--chipStroke);
      background: var(--chip);
      color: rgba(255,255,255,.85);
      font-size: 12px;
      font-weight: 650;
      white-space:nowrap;
    }
    .chip.fav{border-color: rgba(47,220,154,.30); background: rgba(47,220,154,.12); color: rgba(225,255,245,.95)}
    .chip.xfav{border-color: rgba(240,195,106,.32); background: rgba(240,195,106,.12); color: rgba(255,245,220,.95)}

    /* Chart */
    .chartwrap{
      height: 170px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      padding: 10px;
    }
    canvas{width:100%;height:100%}

    /* Autocomplete dropdown */
    .acbox{position:relative}
    .aclist{
      position:absolute;left:0;right:0;top: calc(100% + 6px);
      background: rgba(15,20,35,.98);
      border:1px solid var(--stroke);
      border-radius: 16px;
      overflow:hidden;
      z-index: 10;
      box-shadow: var(--shadow);
      max-height: 220px;
      overflow-y:auto;
      display:none;
    }
    .acitem{
      padding: 10px 12px;
      font-size: 14px;
      border-top: 1px solid rgba(255,255,255,.06);
      cursor:pointer;
      color: rgba(255,255,255,.88);
    }
    .acitem:first-child{border-top:none}
    .acitem:hover{background: rgba(122,162,255,.12)}
    .acsub{color:var(--muted2);font-size:12px;margin-top:2px}

    .footer-note{
      margin-top: 12px;
      color: var(--muted2);
      font-size: 12px;
      line-height:1.35;
    }

    /* Make long labels wrap without squishing */
    .nowrap{white-space:nowrap}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="icon" aria-hidden="true">üéµ</div>
      <div>
        <h1>All Songs</h1>
        <div class="badges" id="summaryBadges"></div>
      </div>
    </header>

    <!-- Filters (collapsed by default) -->
    <details id="filtersPanel" open="false">
      <summary>
        <span>üîé Filters</span>
        <span style="color:var(--muted);font-weight:700;font-size:12px" id="filtersState">Collapsed</span>
      </summary>
      <div class="details-body">
        <div class="grid">
          <div>
            <label>Search (song or artist)</label>
            <input id="q" placeholder="Type to search‚Ä¶" />
          </div>

          <div>
            <label>Favorite</label>
            <select id="favFilter">
              <option value="all">All</option>
              <option value="fav">Fav</option>
              <option value="xfav">X-Fav</option>
              <option value="any">Fav or X-Fav</option>
              <option value="none">None</option>
            </select>
          </div>

          <div>
            <label>Genre</label>
            <select id="genreFilter"></select>
          </div>

          <div>
            <label>Mood</label>
            <select id="moodFilter"></select>
          </div>

          <div>
            <label>Country</label>
            <select id="countryFilter"></select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="applyFilters">Apply</button>
          <button class="btn" id="resetFilters">Reset</button>
        </div>

        <div class="hint">Tip: Filters & charts start collapsed to stay compact for big libraries (5000+ songs).</div>
      </div>
    </details>

    <div class="spacer"></div>

    <!-- Charts (genre only, collapsed by default) -->
    <details id="chartsPanel" open="false">
      <summary>
        <span>üìä Charts (compact)</span>
        <span style="color:var(--muted);font-weight:700;font-size:12px" id="chartsState">Collapsed</span>
      </summary>
      <div class="details-body">
        <div class="chartwrap">
          <canvas id="genreChart"></canvas>
        </div>
        <div class="hint">Genre chart only (Mood removed).</div>
      </div>
    </details>

    <div class="spacer"></div>

    <!-- Add song -->
    <div class="card">
      <div class="row-between">
        <div class="badges">
          <span class="badge" id="sortLabel">Sort: Artist A‚ÄìZ ‚Üí Song A‚ÄìZ</span>
        </div>
        <button class="btn primary" id="toggleAdd">Ôºã Add new song</button>
      </div>

      <div id="addForm" style="display:none; margin-top:12px;">
        <div class="grid">
          <div class="acbox">
            <label>Artist</label>
            <input id="artistIn" placeholder="e.g. The Weeknd" autocomplete="off" />
            <div class="aclist" id="artistAC"></div>
          </div>

          <div class="acbox">
            <label>Song Title</label>
            <input id="titleIn" placeholder="e.g. Blinding Lights" autocomplete="off" />
            <div class="aclist" id="titleAC"></div>
          </div>

          <div>
            <label>Genre</label>
            <select id="genreIn"></select>
            <div class="row" style="margin-top:8px">
              <input id="newGenre" placeholder="Add new genre‚Ä¶" />
              <button class="btn" id="addGenreBtn">Add</button>
            </div>
          </div>

          <div>
            <label>Mood</label>
            <select id="moodIn"></select>
            <div class="row" style="margin-top:8px">
              <input id="newMood" placeholder="Add new mood‚Ä¶" />
              <button class="btn" id="addMoodBtn">Add</button>
            </div>
          </div>

          <div>
            <label>Country</label>
            <select id="countryIn"></select>
            <div class="row" style="margin-top:8px">
              <input id="newCountry" placeholder="Add new country‚Ä¶" />
              <button class="btn" id="addCountryBtn">Add</button>
            </div>
          </div>

          <div>
            <label>Favorite</label>
            <select id="favIn">
              <option value="none">None</option>
              <option value="fav">Fav</option>
              <option value="xfav">X-Fav (extra favorite)</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="saveSong">Save</button>
          <button class="btn" id="clearForm">Clear</button>
        </div>

        <div class="footer-note">
          Data saves automatically on this device (localStorage). Use Export/Import to move data to another device.
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="exportBtn">Export (.json)</button>
          <label class="btn" for="importFile" style="cursor:pointer">Import (.json)</label>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </div>
      </div>
    </div>

    <div id="list"></div>

  </div>

  <script>
    /***********************
     * Storage + Defaults
     ***********************/
    const LS_KEY = "allSongs.v3";

    const defaultGenres = ["Pop","Rock","Hip Hop","R&B","Jazz","Classical","EDM","Indie","K-pop","Country","Hard Rock","Gospel","Metal Rock","French"];
    const defaultMoods  = ["Happy","Sad","Energized","Instrumental","Calm"];
    const defaultCountries = ["USA","UK","Canada","Netherlands","France","Korea","Japan"];

    const state = {
      songs: [],
      genres: [],
      moods: [],
      countries: [],
      filters: { q:"", fav:"all", genre:"all", mood:"all", country:"all" }
    };

    function load(){
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        try{
          const data = JSON.parse(raw);
          state.songs = Array.isArray(data.songs) ? data.songs : [];
          state.genres = Array.isArray(data.genres) && data.genres.length ? data.genres : [...defaultGenres];
          state.moods = Array.isArray(data.moods) && data.moods.length ? data.moods : [...defaultMoods];
          state.countries = Array.isArray(data.countries) && data.countries.length ? data.countries : [...defaultCountries];
          state.filters = data.filters || state.filters;
          return;
        }catch(e){}
      }
      // First run
      state.songs = [
        {id: uid(), artist:"The Weeknd", title:"Blinding Lights", genre:"Pop", mood:"Energized", country:"Canada", fav:"xfav"}
      ];
      state.genres = [...defaultGenres];
      state.moods = [...defaultMoods];
      state.countries = [...defaultCountries];
      save();
    }

    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify({
        songs: state.songs,
        genres: state.genres,
        moods: state.moods,
        countries: state.countries,
        filters: state.filters
      }));
    }

    function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

    /***********************
     * Sorting + numbering
     ***********************/
    const collator = new Intl.Collator(undefined, { sensitivity:"base", numeric:true });

    function normalize(s){ return (s || "").trim(); }

    function sortSongs(arr){
      return [...arr].sort((a,b)=>{
        const aa = normalize(a.artist), ba = normalize(b.artist);
        const at = normalize(a.title), bt = normalize(b.title);
        const c1 = collator.compare(aa, ba);
        if(c1 !== 0) return c1;
        return collator.compare(at, bt);
      });
    }

    // Artist numbering (A1, A2...) based on unique artists in current filtered set or whole set?
    // We'll base it on the CURRENT VIEW (after filters) so it matches what you see.
    function pad(n, width){
      const s = String(n);
      return s.length >= width ? s : "0".repeat(width - s.length) + s;
    }

    /***********************
     * UI refs
     ***********************/
    const el = (id)=>document.getElementById(id);

    const summaryBadges = el("summaryBadges");
    const listEl = el("list");

    const filtersPanel = el("filtersPanel");
    const chartsPanel  = el("chartsPanel");
    const filtersState = el("filtersState");
    const chartsState  = el("chartsState");

    const q = el("q");
    const favFilter = el("favFilter");
    const genreFilter = el("genreFilter");
    const moodFilter = el("moodFilter");
    const countryFilter = el("countryFilter");

    const applyFilters = el("applyFilters");
    const resetFilters = el("resetFilters");

    const toggleAdd = el("toggleAdd");
    const addForm = el("addForm");

    const artistIn = el("artistIn");
    const titleIn  = el("titleIn");
    const genreIn  = el("genreIn");
    const moodIn   = el("moodIn");
    const countryIn = el("countryIn");
    const favIn    = el("favIn");

    const newGenre = el("newGenre");
    const newMood = el("newMood");
    const newCountry = el("newCountry");

    const addGenreBtn = el("addGenreBtn");
    const addMoodBtn = el("addMoodBtn");
    const addCountryBtn = el("addCountryBtn");

    const saveSongBtn = el("saveSong");
    const clearFormBtn = el("clearForm");

    const exportBtn = el("exportBtn");
    const importFile = el("importFile");

    // Autocomplete
    const artistAC = el("artistAC");
    const titleAC  = el("titleAC");

    /***********************
     * Dropdown helpers
     ***********************/
    function fillSelect(sel, items, includeAll=false){
      sel.innerHTML = "";
      if(includeAll){
        const opt = document.createElement("option");
        opt.value="all"; opt.textContent="All";
        sel.appendChild(opt);
      }
      for(const it of items){
        const opt = document.createElement("option");
        opt.value=it; opt.textContent=it;
        sel.appendChild(opt);
      }
    }

    function ensureInList(list, value){
      value = normalize(value);
      if(!value) return false;
      if(list.some(x => x.toLowerCase() === value.toLowerCase())) return false;
      list.push(value);
      list.sort((a,b)=>collator.compare(a,b));
      return true;
    }

    /***********************
     * Filters
     ***********************/
    function matchesFilters(s){
      const qq = state.filters.q.trim().toLowerCase();
      if(qq){
        const hay = (s.artist + " " + s.title).toLowerCase();
        if(!hay.includes(qq)) return false;
      }
      const f = state.filters.fav;
      if(f === "fav" && s.fav !== "fav") return false;
      if(f === "xfav" && s.fav !== "xfav") return false;
      if(f === "any" && !(s.fav === "fav" || s.fav === "xfav")) return false;
      if(f === "none" && s.fav !== "none") return false;

      if(state.filters.genre !== "all" && s.genre !== state.filters.genre) return false;
      if(state.filters.mood !== "all" && s.mood !== state.filters.mood) return false;
      if(state.filters.country !== "all" && s.country !== state.filters.country) return false;
      return true;
    }

    /***********************
     * Render list (compact)
     ***********************/
    function render(){
      // sync filter inputs from state
      q.value = state.filters.q || "";
      favFilter.value = state.filters.fav || "all";

      fillSelect(genreFilter, ["All", ...state.genres], false);
      genreFilter.value = state.filters.genre || "all";
      genreFilter.options[0].value = "all";
      genreFilter.options[0].textContent = "All";

      fillSelect(moodFilter, ["All", ...state.moods], false);
      moodFilter.value = state.filters.mood || "all";
      moodFilter.options[0].value = "all";
      moodFilter.options[0].textContent = "All";

      fillSelect(countryFilter, ["All", ...state.countries], false);
      countryFilter.value = state.filters.country || "all";
      countryFilter.options[0].value = "all";
      countryFilter.options[0].textContent = "All";

      fillSelect(genreIn, state.genres, false);
      fillSelect(moodIn, state.moods, false);
      fillSelect(countryIn, state.countries, false);

      // collapse labels
      filtersState.textContent = filtersPanel.open ? "Expanded" : "Collapsed";
      chartsState.textContent  = chartsPanel.open ? "Expanded" : "Collapsed";

      // apply filters
      const filtered = sortSongs(state.songs.filter(matchesFilters));

      // Summary badges (compact)
      const totalSongs = filtered.length;
      const artistSet = new Set(filtered.map(s => normalize(s.artist).toLowerCase()).filter(Boolean));
      const totalArtists = artistSet.size;

      summaryBadges.innerHTML = `
        <span class="badge">Songs: <b>${totalSongs}</b></span>
        <span class="badge">Artists: <b>${totalArtists}</b></span>
      `;

      // Build artist groups in current view, with artist numbering based on alphabetical artists in view
      const artists = Array.from(new Set(filtered.map(s => normalize(s.artist)).filter(Boolean)))
        .sort((a,b)=>collator.compare(a,b));

      const artistIndexMap = new Map();
      artists.forEach((a,i)=>artistIndexMap.set(a, i+1));

      // Song numbering is global in current view order (S00001..)
      // This gives you ‚Äúhow many songs in this view‚Äù and the song position.
      listEl.innerHTML = "";

      let songCounter = 0;

      for(const artist of artists){
        const groupSongs = filtered.filter(s => normalize(s.artist) === artist);

        const artistCard = document.createElement("div");
        artistCard.className = "artist";

        const artistNo = artistIndexMap.get(artist);
        const aTag = `#A${artistNo}`;

        artistCard.innerHTML = `
          <div class="artist-head">
            <div class="artist-left">
              <div class="num-pill">${aTag}</div>
              <div style="min-width:0">
                <p class="artist-name">${escapeHtml(artist)}</p>
                <div class="artist-sub">${groupSongs.length} song(s)</div>
              </div>
            </div>
          </div>
        `;

        // songs
        for(const s of groupSongs){
          songCounter++;
          const sTag = `#S${pad(songCounter, 5)}`; // simple, clean numbering

          const songEl = document.createElement("div");
          songEl.className = "song";

          const favChip = s.fav === "fav" ? `<span class="chip fav">‚òÖ Fav</span>` :
                          s.fav === "xfav" ? `<span class="chip xfav">‚òÖ‚òÖ X-Fav</span>` : ``;

          songEl.innerHTML = `
            <div class="song-top">
              <div class="song-left">
                <div class="num-pill">${sTag}</div>
                <div style="min-width:0">
                  <p class="song-title">${escapeHtml(s.title || "(Untitled)")}</p>
                </div>
              </div>
              <div class="song-actions">
                <button class="iconbtn" title="Edit" aria-label="Edit">‚úèÔ∏è</button>
                <button class="iconbtn" title="Delete" aria-label="Delete">üóëÔ∏è</button>
              </div>
            </div>

            <div class="chips" aria-label="Tags">
              ${s.genre ? `<span class="chip">${escapeHtml(s.genre)}</span>` : ``}
              ${s.mood ? `<span class="chip">${escapeHtml(s.mood)}</span>` : ``}
              ${s.country ? `<span class="chip">${escapeHtml(s.country)}</span>` : ``}
              ${favChip}
            </div>
          `;

          const [editBtn, delBtn] = songEl.querySelectorAll(".iconbtn");
          editBtn.onclick = ()=> editSong(s.id);
          delBtn.onclick  = ()=> deleteSong(s.id);

          artistCard.appendChild(songEl);
        }

        listEl.appendChild(artistCard);
      }

      // Charts update (only genre)
      renderGenreChart(filtered);
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /***********************
     * Add / Edit / Delete
     ***********************/
    function clearForm(){
      artistIn.value = "";
      titleIn.value = "";
      genreIn.selectedIndex = 0;
      moodIn.selectedIndex = 0;
      countryIn.selectedIndex = 0;
      favIn.value = "none";
      newGenre.value = "";
      newMood.value = "";
      newCountry.value = "";
    }

    function upsertSong(existingId=null){
      const artist = normalize(artistIn.value);
      const title  = normalize(titleIn.value);
      const genre  = genreIn.value || "";
      const mood   = moodIn.value || "";
      const country = countryIn.value || "";
      const fav    = favIn.value || "none";

      if(!artist || !title){
        alert("Please enter Artist and Song Title.");
        return;
      }

      if(existingId){
        const s = state.songs.find(x=>x.id===existingId);
        if(!s) return;
        s.artist = artist; s.title = title; s.genre = genre; s.mood = mood; s.country = country; s.fav = fav;
      }else{
        state.songs.push({ id: uid(), artist, title, genre, mood, country, fav });
      }

      save();
      render();
      clearForm();
      addForm.style.display = "none";
      toggleAdd.textContent = "Ôºã Add new song";
      toggleAdd.dataset.open = "0";
    }

    function deleteSong(id){
      if(!confirm("Delete this song?")) return;
      state.songs = state.songs.filter(s=>s.id!==id);
      save(); render();
    }

    let editingId = null;
    function editSong(id){
      const s = state.songs.find(x=>x.id===id);
      if(!s) return;
      editingId = id;
      addForm.style.display = "block";
      toggleAdd.textContent = "‚úï Close";
      toggleAdd.dataset.open = "1";

      artistIn.value = s.artist || "";
      titleIn.value  = s.title  || "";
      genreIn.value  = s.genre  || state.genres[0] || "";
      moodIn.value   = s.mood   || state.moods[0] || "";
      countryIn.value = s.country || state.countries[0] || "";
      favIn.value = s.fav || "none";

      // scroll to form
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    /***********************
     * Autocomplete (artist + title)
     ***********************/
    function uniqueArtists(){
      const set = new Map();
      for(const s of state.songs){
        const a = normalize(s.artist);
        if(!a) continue;
        set.set(a.toLowerCase(), a);
      }
      return [...set.values()].sort((a,b)=>collator.compare(a,b));
    }

    function uniqueTitlesForArtist(artist){
      const set = new Map();
      const a = normalize(artist).toLowerCase();
      for(const s of state.songs){
        if(normalize(s.artist).toLowerCase() !== a) continue;
        const t = normalize(s.title);
        if(!t) continue;
        set.set(t.toLowerCase(), t);
      }
      return [...set.values()].sort((a,b)=>collator.compare(a,b));
    }

    function showAC(listEl, items, onPick){
      if(!items.length){ listEl.style.display="none"; return; }
      listEl.innerHTML = "";
      for(const it of items.slice(0,10)){
        const div = document.createElement("div");
        div.className = "acitem";
        div.textContent = it;
        div.onclick = ()=>{ onPick(it); listEl.style.display="none"; };
        listEl.appendChild(div);
      }
      listEl.style.display="block";
    }

    artistIn.addEventListener("input", ()=>{
      const v = artistIn.value.trim().toLowerCase();
      if(!v){ artistAC.style.display="none"; return; }
      const items = uniqueArtists().filter(a=>a.toLowerCase().includes(v));
      showAC(artistAC, items, (pick)=>{ artistIn.value = pick; artistIn.dispatchEvent(new Event("input")); });
    });

    titleIn.addEventListener("input", ()=>{
      const av = normalize(artistIn.value);
      const v = titleIn.value.trim().toLowerCase();
      if(!v){ titleAC.style.display="none"; return; }

      let items = [];
      if(av){
        items = uniqueTitlesForArtist(av).filter(t=>t.toLowerCase().includes(v));
      }else{
        // fallback: suggest titles from all songs
        const set = new Map();
        for(const s of state.songs){
          const t = normalize(s.title);
          if(t) set.set(t.toLowerCase(), t);
        }
        items = [...set.values()].sort((a,b)=>collator.compare(a,b)).filter(t=>t.toLowerCase().includes(v));
      }
      showAC(titleAC, items, (pick)=>{ titleIn.value = pick; titleAC.style.display="none"; });
    });

    document.addEventListener("click", (e)=>{
      if(!artistAC.contains(e.target) && e.target !== artistIn) artistAC.style.display="none";
      if(!titleAC.contains(e.target) && e.target !== titleIn) titleAC.style.display="none";
    });

    /***********************
     * Genre chart (compact)
     ***********************/
    const ctx = el("genreChart").getContext("2d");
    function renderGenreChart(filtered){
      // build counts
      const counts = new Map();
      for(const s of filtered){
        const g = normalize(s.genre) || "Unknown";
        counts.set(g, (counts.get(g) || 0) + 1);
      }
      const entries = [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0, 8);
      const labels = entries.map(e=>e[0]);
      const values = entries.map(e=>e[1]);

      drawBarChart(ctx, labels, values);
    }

    function drawBarChart(ctx, labels, values){
      const canvas = ctx.canvas;
      // clear
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // device pixel ratio scaling for crispness
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.round(rect.width * dpr);
      canvas.height = Math.round(rect.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);

      const w = rect.width, h = rect.height;
      const padX = 10, padY = 10;
      const chartW = w - padX*2;
      const chartH = h - padY*2 - 24;

      const max = Math.max(1, ...values);
      const barCount = Math.max(1, labels.length);
      const gap = 10;
      const barW = Math.max(10, (chartW - gap*(barCount-1)) / barCount);

      // bars
      for(let i=0;i<labels.length;i++){
        const v = values[i];
        const bh = (v / max) * chartH;
        const x = padX + i*(barW + gap);
        const y = padY + (chartH - bh);

        // gradient-ish fill with alpha
        const grd = ctx.createLinearGradient(0, y, 0, y+bh);
        grd.addColorStop(0, "rgba(122,162,255,.70)");
        grd.addColorStop(1, "rgba(122,162,255,.25)");
        ctx.fillStyle = grd;
        roundRect(ctx, x, y, barW, bh, 10, true, false);

        // value
        ctx.fillStyle = "rgba(255,255,255,.75)";
        ctx.font = "12px ui-sans-serif, system-ui";
        ctx.textAlign = "center";
        ctx.fillText(String(v), x + barW/2, y - 6);
      }

      // labels
      ctx.fillStyle = "rgba(255,255,255,.60)";
      ctx.font = "12px ui-sans-serif, system-ui";
      ctx.textAlign = "center";
      for(let i=0;i<labels.length;i++){
        const x = padX + i*(barW + gap) + barW/2;
        ctx.fillText(trunc(labels[i], 9), x, h - 10);
      }
    }

    function trunc(s, n){
      s = String(s);
      return s.length>n ? s.slice(0,n-1)+"‚Ä¶" : s;
    }

    function roundRect(ctx, x, y, w, h, r, fill, stroke) {
      if (w < 2 * r) r = w / 2;
      if (h < 2 * r) r = h / 2;
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }

    window.addEventListener("resize", ()=>render());

    /***********************
     * Wire events
     ***********************/
    filtersPanel.addEventListener("toggle", ()=>{ filtersState.textContent = filtersPanel.open ? "Expanded" : "Collapsed"; });
    chartsPanel.addEventListener("toggle", ()=>{ chartsState.textContent = chartsPanel.open ? "Expanded" : "Collapsed"; });

    applyFilters.onclick = ()=>{
      state.filters.q = q.value || "";
      state.filters.fav = favFilter.value || "all";
      state.filters.genre = genreFilter.value || "all";
      state.filters.mood = moodFilter.value || "all";
      state.filters.country = countryFilter.value || "all";
      save(); render();
    };

    resetFilters.onclick = ()=>{
      state.filters = { q:"", fav:"all", genre:"all", mood:"all", country:"all" };
      save(); render();
    };

    toggleAdd.onclick = ()=>{
      const open = toggleAdd.dataset.open === "1";
      if(open){
        addForm.style.display = "none";
        toggleAdd.textContent = "Ôºã Add new song";
        toggleAdd.dataset.open = "0";
        editingId = null;
      }else{
        addForm.style.display = "block";
        toggleAdd.textContent = "‚úï Close";
        toggleAdd.dataset.open = "1";
      }
    };

    saveSongBtn.onclick = ()=> upsertSong(editingId);
    clearFormBtn.onclick = ()=>{ editingId=null; clearForm(); };

    addGenreBtn.onclick = ()=>{
      const v = newGenre.value;
      if(ensureInList(state.genres, v)){
        save();
        fillSelect(genreIn, state.genres);
        fillSelect(genreFilter, ["All", ...state.genres], false);
        genreFilter.options[0].value="all"; genreFilter.options[0].textContent="All";
        newGenre.value="";
        render();
      }
    };

    addMoodBtn.onclick = ()=>{
      const v = newMood.value;
      if(ensureInList(state.moods, v)){
        save();
        fillSelect(moodIn, state.moods);
        fillSelect(moodFilter, ["All", ...state.moods], false);
        moodFilter.options[0].value="all"; moodFilter.options[0].textContent="All";
        newMood.value="";
        render();
      }
    };

    addCountryBtn.onclick = ()=>{
      const v = newCountry.value;
      if(ensureInList(state.countries, v)){
        save();
        fillSelect(countryIn, state.countries);
        fillSelect(countryFilter, ["All", ...state.countries], false);
        countryFilter.options[0].value="all"; countryFilter.options[0].textContent="All";
        newCountry.value="";
        render();
      }
    };

    exportBtn.onclick = ()=>{
      const blob = new Blob([JSON.stringify({
        songs: state.songs,
        genres: state.genres,
        moods: state.moods,
        countries: state.countries
      }, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "all-songs-backup.json";
      a.click();
      URL.revokeObjectURL(a.href);
    };

    importFile.onchange = async ()=>{
      const f = importFile.files && importFile.files[0];
      if(!f) return;
      const txt = await f.text();
      try{
        const data = JSON.parse(txt);
        if(Array.isArray(data.songs)) state.songs = data.songs;
        if(Array.isArray(data.genres) && data.genres.length) state.genres = data.genres;
        if(Array.isArray(data.moods) && data.moods.length) state.moods = data.moods;
        if(Array.isArray(data.countries) && data.countries.length) state.countries = data.countries;
        save(); render();
        alert("Import complete ‚úÖ");
      }catch(e){
        alert("Invalid JSON file.");
      }finally{
        importFile.value = "";
      }
    };

    /***********************
     * Init
     ***********************/
    load();

    // Fill selects before first render
    state.genres.sort((a,b)=>collator.compare(a,b));
    state.moods.sort((a,b)=>collator.compare(a,b));
    state.countries.sort((a,b)=>collator.compare(a,b));

    // Start collapsed (important)
    filtersPanel.open = false;
    chartsPanel.open = false;

    render();
  </script>
</body>
</html>
